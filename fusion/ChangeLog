2004-12-24  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/types.h: Define ROOT_THREAD_INIT/EXIT for use in
	context-agnostic (kernel/uvm) apps.

	* fusion: __xeno_*_* -> __fusion_*_*.

	* include/nucleus/GNUmakefile.am: Optionally recurse into asm-uvm/
	during installation.

	* configure.in: Add -D_GNU_SOURCE -D_REENTRANT to
	RTAI_USER_CFLAGS.

2004-12-22  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/Kconfig: Hide configuration of per-cpu timers. It is
	enabled by default and may be disabled only when "expert mode" is
	activated.

2004-12-21  Philippe Gerum  <rpm@xenomai.org>

	* sim: Fix a few glitches and update the necessary bits to run the
	RTAI skin.

	* GNUmakefile.am (install-data-local): Add "build" and "source"
	symlinks in $prefix.

2004-12-21  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/nucleus/pod.h (xnpod_ticks2ns) : Remove useless llimd.

2004-12-20  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/nucleus/asm-i386/hal.h: Mark arithmetic routines
	arguments const, to allow better compiler optimization.

	* nucleus/shadow.c (xnshadow_ticks2*): Really roll-back slow
	implementations.

	* nucleus/shadow.c (xnshadow_substitute_syscall): Only pass
	positive arguments to xnshadow_ticks2ts.

2004-12-19  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* Per-cpu timers implementation; pod and timer: Each CPU has a
	timerwheel, a timer object is attached to a sched structure, a new
	call xntimer_set_sched allowing to change this structure. When a
	timer is modified on a distant CPU, xnarch_send_timer_ipi is
	called. The HAL is expected to either install the handler passed
	to rthal_request_timer for this IPI, or to use the same interrupt
	for the timer and this IPI (the x86 case).

	* nucleus/timer.c (xntimer_next_shot): Round delays greater than
	ULONG_MAX ticks to ULONG_MAX, so that 32 bits are enough.

	* arch/i386/hal/hal.c (rthal_critical_sync, rthal_request_timer):
	Avoid timers to tick at the same time on all CPUS on SMP systems.

	* skins/posix: add missing EXPORT_SYMBOL, use fusion POD, add
	pthread_make_periodic_np, pthread_wait_np calls, round towards
	infinity while converting timespec to ticks count and add one more
	tick.

2004-12-18  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/shadow.c (xnshadow_*2ticks, xnshadow_ticks2*):
	Roll-back slow implementations.
	
	* nucleus/lib/fusion.c: Provide a C-only implementation of llimd
	to avoid inclusion of hal.h in user-space.

	* include/nucleus/asm-uvm/system.h,
	  sim/include/nucleus/asm/system.h: Correct rounding of llimd for
	negative arguments.

	* include/nucleus/asm-i386/hal.h: Re-implement llimd for correct
	rounding and minimized inline assembly.

2004-12-13  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.6.7

2004-12-12  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/nucleus/asm-uvm/system.h: Add pure C implementation of
	the new macros, as well as for imuldiv and llimd (only unsigned
	for now).

	* include/nucleus/asm-*/system.h : Add new macros for 64 bit
	calculus, defined in hal.h.

	* nucleus/shadow.c (xnshadow_*2ticks, xnshadow_ticks2*):
	Temporarily re-implement slow versions.

	* include/nucleus/asm-i386/hal.h: Got rid of the broken
	rthal_ulldiv, minimize usage of inline assembly, add new functions
	for 64 bits calculus.

	* include/nucleus/*/system.h: Allow interruption of
	xnarch_sleep_on in debug mode.

2004-12-11  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-uvm/system.h: Enforce start barrier and fix
	shadow mapping protocol.

	* skins/rtai/lib/task.c (rt_task_trampoline): Enforce start
	barrier.

	* nucleus/shadow.c (xnshadow_kick_process): Remove the shadow
	start call which was bugous wrt ptracing interaction, and has been
	deprecated by the start barrier mechanism.

	* nucleus/shadow.c: Fix ptracing support for shadow threads using
	a start barrier which allows to keep processing signals
	(e.g. SIGSTOP) for unstarted (i.e. dormant) threads.

2004-12-10  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/lib/task.c (rt_task_trampoline): Commit stack memory
	up to PTHREAD_STACK_MIN.
	(rt_task_create): Raise minimum stack to PTHREAD_STACK_MIN * 2.

	* skins/rtai/event.c (rt_event_signal): Do not auto-clear matched
	bits; this makes no sense with multiple waiters.

	* include/nucleus/queue.h: Disable queue checks in user-space code
	which does not run as part of any virtual machine, e.g. skin
	syslibs. This fixes the CONFIG_RTAI_OPT_DEBUG problem with
	skin/rtai/lib.

	* arch/*/hal/hal.c (rthal_request_irq): Only virtualize requested
	IRQs.

2004-12-09  Philippe Gerum  <rpm@xenomai.org>

	* GNUmakefile.am (dev devices): Always enable even if DESTDIR is set.

2004-12-08  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/timer.c (xntimer_do_timers): Add missing anticipation on
	timer trigger date, suppress useless timer->shot. Those changes
	seem to have extremely positive impact on latencies with low-end
	hw.

	* testsuite/klatency/latency-module.c (latency): Display overall
	min latency.

2004-12-07  Philippe Gerum  <rpm@xenomai.org>

	* scripts/rtai-*.in: Force /bin/bash as interpreter.

2004-12-05  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.6.6

2004-12-05  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-i386/system.h (xnarch_adjust_calibration):
	No adjustment needed anymore here.

	* skins/rtai/task.c: Return -EACCES upon invalid non-task context
	to remain consistent with the shadow manager.

	* skins/rtai/syscalls.c: Fix generalized memory leak upon RT
	object deletion.

	* skins/rtai/syscall.c (rt_alarm_wait): Provide user-space support
	for waiting for alarm shots.

	* skins/rtai/task.c (rt_task_set_priority): Check priority
	argument.

2004-12-04  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/lib/task.c (__init_skin): Must be single instance.

	* skins/rtai/alarm.c (rt_alarm_create): Fix position of name
	parameter.

	* skins/rtai/syscall.c (__rt_heap_create): Fix placeholder type
	used.

	* include/nucleus/fusion.h (FUSION_IRQ_PRIO): Add priority level
	for interrupt servers in user-space.

2004-12-03  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/alarm.c (rt_alarm_inquire): Add count of expiries.

2004-12-03  Panagiotis Issaris <panagiotis.issaris@mech.kuleuven.ac.be>

	* doc/docbook/xenomai/xenomai.xml: Fix typos and other
	spelling/grammar mistakes.

2004-12-03  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/types.h: Change xnsigmask_t to the natural
	integer type available on the platform, so that we can map it
	properly over some data carried by siginfo_t. In any case, it does
	not make any sense to allow different amount of possible signals
	across platforms by depending on the size of their respective
	natural long type.

	* skins/rtai/syscall.c: Fix "self" task determination code to
	encompass the case where the caller is a relaxed shadow.

	* skins/rtai/syscall.c: Turn -ENOENT errors into -ESRCH.

	* skins/rtai/task.c, skin/rtai/lib/task.c (rt_task_self,
	rt_task_slice): Finalize user-space support.

	* nucleus/pod.c (xnpod_calibration_thread): Fix stupid time
	reference bug.

2004-12-02  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/task.c (rt_task_self): Add self descriptor retrieval
	function.
	(rt_task_slice): Add routine to setup the round-robin credit.

	* nucleus/timer.c (xntimer_enqueue_aperiodic): Enforce new
	internal priority of timers.

2004-12-01  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/alarm.c: Add alarm support.

	* include/nucleus/asm-*/system.h (xnarch_sysalloc,
	xnarch_sysfree): Use vmalloc support for sizes >= 128Kb.

2004-11-30  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_set_thread_periodic): Fix start mode with
	idate == XN_INFINITE (i.e. do not enter any initial wait state).
	(xnpod_resume_thread): Fix interesting corner case involving
	partial resumption of a thread still blocked on a primary XNDELAY
	condition.

	* skins/rtai/types.h: RT_TIME_INFINITE -> TM_INFINITE,
	RT_TIME_NONBLOCK -> TM_NONBLOCK for consistency purpose with other
	namings.

2004-11-29  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/event.c (rt_event_clear): Add service to clear a set
	of flags from an event group.

	* skins/rtai/timer.h: RT_TIMER_UNSET/ONESHOT -> TM_UNSET/ONESHOT
	for consistency with other namings.

2004-11-28  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.6.5

2004-11-28  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade to Adeos 2.6.9-i386-r9c1.

	* skins/rtai/task.c (rt_task_create): Allow for creation in
	suspended state passing T_SUSP.
	(rt_task_start): Apply CPU affinity.

	* skins/rtai/task.h (T_CPU): Fix for multiple cpu affinity.

	* skins/rtai/event.c: Rename rt_event_post() -> rt_event_signal(),
	rt_event_pend() -> rt_event_wait() for consistency purpose with
	the condvar support.

2004-11-28  Jan Kiszka <kiszka@rts.uni-hannover.de>

	* skins/rtai/sem.c: Export sem_broadcast().

2004-11-27  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-*/syscall.h: Provide support for direct
	reading of the TSC in user-space when available.

	* nucleus/timer.c: Read Adeos profile timings when available when
	CONFIG_RTAI_OPT_TIMESTAMPS is enabled.

2004-11-26  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/snippets: Add code snippets illustrating the use of
	the API.

	* nucleus/pod.c: Compile out calls to the scheduler hook unless we
	are actually building the simulator.
	(xnpod_switch_fpu): Inline calls on the fast path.

	* skins/rtai/lib/task.c (rt_task_set_mode, rt_task_notify): Export
	to user-space.

	* testsuite/latency/latency.c (main): Allow for setting the
	sampling period.

2004-11-25  Philippe Gerum  <rpm@xenomai.org>

	* fusion: Pass RTAI_KMOD_CFLAGS as needed.

2004-11-24  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/module.c (__fusion_skin_init): Fix init without
	user-space support.

	* arch/i386/hal/hal.c (rthal_trap_fault): Remove lazy handling of
	on-demand kernel memory mapping, leaving the burden to Adeos
	(which does it eagerly instead, see include/asm-i386/pgalloc.h).

2004-11-24  Marc Kleine-Budde <kleine-budde@gmx.de>

	* configure.in: Fix various m4 quoting issues.

2004-11-23  Philippe Gerum  <rpm@xenomai.org>

	* arch/*/defconfig: Rebuild sound versions.

2004-11-22  Philippe Gerum  <rpm@xenomai.org>

	* configure.in: Use pretty printing for help strings
	(AS_HELP_STRING).

	* nucleus: Fix various undefined symbols with fusion-less builds.

	* nucleus/timer.c (xntimer_start): Do not check for preposterous
	dates: the start value is a duration and not an absolute date, and
	dates in the past are caught when programming the next shot
	anyway.

2004-11-21  Philippe Gerum  <rpm@xenomai.org>

	* fusion: Upgrade to autoconf 2.59 and friends.

	* nucleus/lib/fusion.c: 
	* skins/rtai/syscall.c: Qualify __user pointers to have them
	"sparse"-friendly.

	* config/autoconf/acinclude.m4:
	* sim/acinclude.m4: Fix new pedantic autoconf whim: quote all
	macro names in definitions.

2004-11-19  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.6.4

2004-11-19  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade to Adeos 2.6.*-i386-r8 final.

2004-11-18  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/mutex.h: Fix forward declaration of RT_TASK.

	* skins/rtai/task.c (rt_task_set_mode): Allow for changing the
	mode bits of the current task.

	* skins/rtai/sem.c (rt_sem_broadcast): Add broadcasting op.

	* nucleus/pod.c (xnpod_set_thread_periodic): Allow passing a
	special start date to indicate that no initial delay should take
	place before entering the periodic mode.

2004-11-17  Philippe Gerum  <rpm@xenomai.org>

	* Kconfig: Move nucleus-related options to nucleus/Kconfig.

	* configure.in: Add top and bottom sections to KBUILD_CMD.

2004-11-16  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/hal/hal.c (__rthal_init): Setup the 8254 channel #2
	for TSC emulation.

2004-11-15  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/heap.c (rt_heap_alloc): Add shmget variant.
	
	* skins/rtai/heap.c (rt_heap_create):
	* skins/rtai/queue.c (rt_queue_create): Account for the overhead
	so that the actual free space is large enough to match the
	requested size.

	* configure.in, nucleus/Kconfig: Make the maximum number of pipes
	configurable.

2004-11-14  Philippe Gerum  <rpm@xenomai.org>

	* nucleus, include/nucleus: Provide support for non-threaded Adeos
	domains (i.e. single-stack Adeos model).

	* fusion: Make the whole user-space support optional.

	* nucleus/pipe.c: Make it optional.

	* skins/rtai/registry.c, skins/rtai/event.c, skins/rtai/heap.c,
	skins/rtai/sem.c, skins/rtai/task.c: Add feature intro.

2004-11-13  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.6.3

2004-11-13  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade to Adeos 2.6.*-i386-r8c7.

	* nucleus/shadow.c (gatekeeper_thread): Lower spl when processing
	requests.

2004-11-09  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/nucleus/asm-i386/system.h (xnarch_restore_fpu): Restore
	the ts bit when switching to a user-space thread with
	uninitialized FPU.

	* testsuite/cruncher/cruncher.c (sampler_thread): Really calibrate
	the cruncher for a 10 ms computation.

2004-11-07  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* configure.in (RTAI_KBUILD_CMD): Do return the same status as
	Kbuild make.

	* arch/i386/hal/hal.c (__rthal_init): Use CLOCK_TICK_RATE as CPU
	frequency when the kernel is configured without CONFIG_X86_TSC.

2004-11-07  Philippe Gerum  <rpm@xenomai.org>

	* GNUMakefile.am (device): Create /dev/rtheap.

	* skins/rtai/task.c: Add asynchronous notification support.

	* skins/rtai: Add shared heap (standalone) support.

2004-11-06  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/queue.c (rt_queue_send): Pass message's payload size.

	* skins/rtai/syscall.c: Check for writability of the return buffer
	for all inquiry services.
	
	* skins/rtai/syscall.c (__rt_queue_free, __rt_queue_send): General
	fix.

	* skins/rtai/queue.c, skins/rtai/syscalls.c,
	skins/rtai/lib/queue.c: Fix various issues for user-space use.
	(rt_queue_alloc): Return NULL upon failure as expected.

	* skins/rtai/syscall.c (__rt_queue_bind): Allow mapping DMA memory.

	* skins/rtai/registry.c (rt_registry_remove): Semantics changed:
	forcibly unregisters the object.
	(rt_registry_remove_safe): Performs safe removal atomically when
	the object is fully unlocked/idle.

2004-11-05  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/syscall.c: Revert change to deletion calls mode; they
	should not switch to primary.

	* skins/rtai/queue.c (rt_queue_create): Return -ENOMEM upon error
	return from xnheap_init_shared().

	* skins/rtai/lib/queue.c (rt_queue_create): Make sure we don't
	leave a dandling queue in kernel space if the mapping fails.

2004-11-04  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.6.2

2004-11-04  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade to Adeos 2.6.*-i386-r8c6.

	* arch/ppc/patches: Upgrade to Adeos 2.6.8rc1-ppc-r6c9.

	* configure.in: Get rid of annnoying Kbuild warnings about undef'd
	symbols by moving vmlinux and Module.symvers out of the way (Idea
	brought by Jan Kiszka).

	* skins/rtai/registry.c (rt_registry_remove): Make sure we
	properly process XNBREAK.

	* skins/rtai/syscall.c: Make all deletion calls switch to primary
	mode before operating since rt_registry_remove() could wait.

	* skins/rtai: Provide exhaustive calling environment information.
	
	* skins/rtai/task.c: Add rt_task_remove_hook().

2004-11-01  Philippe Gerum  <rpm@xenomai.org>

	* configure.in, scripts/rtai-config.in: Fix CONFIG_RTAI_LINUXDIR
	mess.

	* nucleus/heap.c: Finalize shared heap support.

	* include/nucleus/queue.h (DECLARE_XNQUEUE): Add global queue
	declarator with built-in initializer.

2004-10-31  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/heap.c: Create the basic infrastructure for mapping
	heap memory to user-space processes.

	* include/nucleus/heap.h (xnheap_t): Add arch-dependent block.

2004-10-30  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/queue.c: Add message queue support.

	* nucleus/pipe.c: More appropriate than legacy "domain bridge"
	name.

2004-10-25  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/shadow.c (xnshadow_linux_sysentry): replace direct
	assignment to __xn_reg_rval by xn_status_return for xn_sys_attach
	and xn_sys_detach syscalls.

	* nucleus/fusion.c (__pthread_ns2ticks_rt, __pthread_ticks2nsr_rt)
	  nucleus/lib/fusion.c (pthread_ns2tsc_rt, pthread_tsc2ns_rt), 
	  include/nucleus/fusion.h:
	Separate conversion between nanoseconds and tscs from conversion
	between nanoseconds and scheduler ticks counts.

	* include/nucleus/asm-i386/system.h, nucleus/trace.c: move
	architecture dependent part of the trace module to system.h.

2004-10-25  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_schedule): Escalate all requests to the
	RTAI domain.

	* nucleus/shadow.c: Get rid of __xn_sys_sched request. Rely on
	xnpod_schedule() escalation handling.

	* README.QUICKINSTALL: Add Pierre Ficheux's quick install note.

	* nucleus/shadow.c (xnshadow_substitute_syscall): Make sure to
	call request_syscall_restart() on behalf of a shadow only.

2004-10-24  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-i386/system.h (__switch_threads): Fix %ebp
	trashing.

	* nucleus/shadow.c: Fix license. This is kernel-only code, so GPL
	applies with no user-space library consideration.

2004-10-21  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-i386/system.h: Make lock variable volatile.

2004-10-20  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/asm-i386/system.h: Add debug infrastructure for
	spinlocks.
	
2004-10-20  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_schedule_handler): Don't grab the nklock
	uselessly.
	(xnpod_schedule): Keep on holding the lock while dispatching
	signals.

	* include/nucleus/asm-i386/system.h (xnlock_put_irqrestore):
	Discard useless cpu_relax() and fold unlocking into a single
	test and clear op.

2004-10-19  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_mount): Add memory barrier after
	gksync init.

2004-10-18  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_harden): Fix stupid uninit cpuid bug
	in SMP case.

2004-10-18  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/pod.c (xnpod_announce_tick): prevent timer interrupt
	from ticking on several CPUS.

2004-10-17  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.6.1

2004-10-17  Philippe Gerum  <rpm@xenomai.org>

	* README.INSTALL: Clarify Adeos-related issues.
	
	* arch/*/patches: Use vanilla Adeos file names.
	
	* nucleus/pod.c (xnpod_suspend_thread): Conservatively clear the
	wait channel upon signal aborted wait.

	* arch/i386/patches: Upgrade to Adeos 2.6.*-i386-r8c5.

2004-10-16  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-*/system.h (__xnlock_get_irqsave): Get
	rid of the optimization allowing to spin interrupts on. The basic
	idea is correct, but the implementation was bugous
	Adeos-wise. Revert to a conservative implementation until SMP
	support is deemed stable in all other aspects.
	
	* nucleus/pod.c (xnpod_suspend_thread): Clear other unblocking
	condition bits when forcing XNBREAK upon signal.

2004-10-13  Philippe Gerum  <rpm@xenomai.org>

	* scripts/rtai-load.in: Allow for passing args to commands.
	e.g. ./run [target spec] -- arglist

2004-10-11  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_suspend_thread): Convert any pending
	XNKICKED state into the XNBREAK condition when attempting to
	suspend a runnable shadow thread which has received a Linux
	signal.

2004-10-10  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.6

2004-10-10  Philippe Gerum  <rpm@xenomai.org>

	* GNUMakefile.am: Fix distclean-local for old fashioned build.

2004-10-09  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* GNUmakefiles.am building kernel modules : Force build of kernel
	and let Kbuild handle dependencies.

2004-10-09  Ivan Raikov <raikov@cc.gatech.edu>

	* scripts/rtai-load.in: Add support for user-defined module search
	directory.

2004-10-09  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade to Adeos 2.6.*-i386-r8c4 and
	2.6.8rc1-ppc-r6c8.

	* nucleus/shadow.c (engage_irq_shield, disengage_irq_shield):
	Improve concurrency while testing the shielded/unshieded state
	bits.

	* include/nucleus/asm-*/system.h (xnarch_grab_xirqs,
	xnarch_lock_xirqs, xnarch_unlock_xirqs): Move the arch-dependent
	shield code to where it belongs.

2004-10-08  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c: Yet another IRQ shield implementation.

2004-10-07  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_substitute_syscall): Make sure we
	will attempt to restart the nanosleep() substitute if interrupted
	by a signal.

	* nucleus/fusion.c (__pthread_sleep_rt): Return -EINTR upon
	interrupt.

	* nucleus/pod.c (xnpod_add_hook, xnpod_remove_hook): Fix an
	obscure SMP race that occurred when using job control on
	testsuite/latency.

	* nucleus/shadow.c (xnshadow_linux_sysentry): Reread the current
	Xenomai thread pointer for calling request_syscall_restart();
	it might have been NULL on entry then only set during the just
	performed syscall as a result of the initial shadow mapping.

2004-10-07  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* testsuite/cruncher/cruncher.c (cruncher_thread): Test the value
	returned by the computation loop and compile with the correct
	optimization flags.

	* configure.in: Add check for the architecture tuning flags used
	by the kbuild.

	* include/nucleus/asm-i386/system.h (xnarch_switch_to): Remove
	useless restoration of the ts bit.

2004-10-06  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c: Rewrite the interrupt shield management.
	(xnshadow_linux_taskexit): No more need to disable the interrupt
	shield upon task exit.

	* testsuite/latency/latency.c: Rearrange cleanup actions so that
	we don't get caught in a tight sampling loop when the timer is
	stopped by the signal handler.

2004-10-05  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_linux_taskexit): Disengage the
	interrupt shield so that synchronous IPIs that might be used in
	the task cleanup code could flow to Linux freely.
	(engage_local_irq_shield): Lock hw interrupts.
	(engage_local_irq_shield):
	(disengage_local_irq_shield): Remove superfluous check for virtual
	IRQs.

2004-10-04  Edelhard Becker <ebecker@software-manufaktur.de>

	* configure.in: Detect CONFIG_X86_EMU486 when testing for
	cmpxchg() availability.

2004-10-04  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade to Adeos 2.6.*-i386-r8c3 and
	2.6.8rc1-ppc-r6c7.

	* include/nucleus/asm-*/system.h (xnarch_notify_shutdown): 
	* arch/*/hal/hal.c (__rthal_init): Force CPU affinity so that the
	HAL and the nucleus always keep their execution sequence on SMP
	systems wrt cleanup actions.

	* nucleus/shadow.c: Ask Linux to restart interrupted Xenomai
	syscalls.

	* testsuite/latency/latency.c (cleanup_upon_sig): Forcibly exit
	upon signal so that the sampler does not enter a tight error loop
	in RTAI mode after the time has been stopped.

2004-10-03  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-ppc/syscall.h (XENOMAI_DO_SYSCALL): Revert
	retval negation upon error.

2004-10-02  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade to Adeos 2.6.*-i386-r8c2.

	* include/nucleus/asm-*/system.h (xnarch_init): 
	* arch/*/hal/hal.c (__rthal_init): Force CPU affinity so that the
	HAL and the nucleus always keep their execution sequence on SMP
	systems wrt initialization chores.

2004-10-02  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* skins/rtai/module.c (__fusion_skin_init): Remove warnings about
	unused labels.

2004-10-01  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/trace.c: Add tracing module.

	* All GNUmakefile.am: Make the "distcheck" target work.

2004-10-01  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_shutdown): Split the cleanup work into two
	distinct phases delimited by calls to xnarch_notify_shutdown() and
	xnarch_notify_halt(), so that per-arch actions can be performed at
	different times during the shutdown process.
	
	* nucleus/shadow.c: Define xnshadow_grab_events() and
	xnshadow_release_events() to request/release kernel event
	interception independently of the module loadup/cleanup phases.
	
	* nucleus/module.c (xnpod_read_proc): Fix race w/ shutdown.

2004-10-01  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/nucleus/asm-i386/system.h (xnarch_switch_to): clear the
	ts bit when switching to a Linux task when the previous Linux task
	had used the FPU.

2004-09-30  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/pod.c (xnpod_init): Handle the XNPIDLE bit, to prevent
	several instances or xnpod_shutdown from interleaving.

	* include/nucleus/asm-i386/system.h (xnarch_notify_shutdown):
	Better implementation, waiting for all the cpus to switch to the
	Linux domain.

2004-09-30  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c: Rearrange critical sections so that
	rthal_critical_enter() is not called while the nklock is held.

	* nucleus/timer.c (xntimer_freeze): Do not hold the nklock while
	stopping the hw timer.

	* nucleus/pod.c (xnpod_start_timer): Fix error path.
	(xnpod_start_timer): Do not hold the nklock while starting the hw
	timer.

	* nucleus/intr.c: Remove duplicate logic w/ HAL's own checks for
	operation consistency.

2004-09-29  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-i386/system.h: Check for Adeos version >=
	2.6r8c1.

	* nucleus/pod.c: Remove the cancellation points and the XNKILLED
	bit handling which become useless due to the following change.

	* nucleus/shadow.c: Always allow any signal to flow down to the
	Linux context; just make sure the associated shadow is properly
	awaken upon wakeup notification from the Linux kernel.

	* nucleus/pod.c (xnpod_start_thread): Fix unlocking upon error case.

2004-09-27  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_wait_thread_period): Fix error return when
	the timer is not active.
	(xnpod_calibration_thread): Use long integer to store the jitter
	value.

	* include/nucleus/pod.h (xnpod_ns2ticks): Discard remainder arg.

2004-09-26  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_schedule_head): Rollback the previous
	change on 2004-09-22 until it is properly fixed: it spuriously
	leaves the shield on upon shadow exit.

2004-09-25  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/pod.h (xnpod_cancellation_point): Define and use
	a common cancellation handler to process the XNKILLED bit.

2004-09-23  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_start_timer): Allow the arch-dependent code
	grabbing the hw timer to request a precise start time for the host
	tick timer.

	* include/nucleus/asm-*/syscall.h: Define an arch-dependent way of
	setting the value returned by syscalls, using
	__xn_success_return(), __xn_error_return() and
	__xn_status_return().

2004-09-22  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/procfs.h: Discard.

	* nucleus/shadow.c (xnshadow_schedule_head): Only disengage the
	shield if the outgoing task was a shadow; otherwise, it's useless.

2004-09-21  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_substitute_syscall): No need to
	compute an expiry date in the setitimer() replacement code.

	* nucleus/pod.c (xnpod_suspend_thread): Immediately unblock the
	suspended thread if a preposterous timeout is notified by the
	timer manager.

2004-09-20  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_relax): Feeds
	__adeos_schedule_back_root() with the proper task pointer, which
	must always be the current (Linux-managed) switch lock owner.

2004-09-18  Philippe Gerum  <rpm@xenomai.org>

	* testsuite/GNUmakefile.am (OPTDIRS): Leave the cruncher out of
	the optional dirs.

	* arch/i386/patches: Upgrade to Adeos 2.6.*-i386-r7 final.

2004-09-16  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/dbridge.c: Always return -EPIPE instead of -EIO.

2004-09-14  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c: Call __adeos_schedule_back_root() with the
	proper "prev" task pointer at the time the Linux scheduling tail
	should be run, which must be different from "current".

2004-09-12  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/fusion.c (__pthread_ticks2ns_rt, __pthread_ns2ticks_rt):
	Use signed input/output.

	* skins/rtai/timer.c (rt_timer_ticks2ns, rt_timer_ns2ticks):
	Consider CONFIG_RTAI_HW_APERIODIC_TIMER when converting.

2004-09-11  Philippe Gerum  <rpm@xenomai.org>

	* arch/*/hal/hal.c: Discard obsolete rthal_linux_context[] which
	is not used anymore.

	* include/nucleus/asm-i386/system.h (xnarch_switch_to): Finally
	unstaticalize cr0.

2004-09-09  Evgeny Sinelnikov <linux4sin@mail.ru>

	* configure.in, makefile, scripts/rtai-config.in: Correctly handle
	the --with-linux-dir configure option.

2004-09-07  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_calibrate_sched): Obtain the calibration
	pod and thread memory from the system heap, not from the stack;
	the latter could cause misaligned FPU ops.
	(xnpod_init): Clear the rescheduling mask of all scheds at init.

2004-09-06  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade to Adeos 2.6.8.1-i386-r7c1.

2004-09-05  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_migrate_thread): Rename, export and use a
	single exit path.

	* nucleus/shadow.c (xnshadow_substitute_syscall): Do not
	substitute timing calls if the system timer has not been started.

	* nucleus/pod.c (xnpod_fault_handler): Make sure we propagate
	faults over shadows to Linux after they have been relaxed.

2004-09-04  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/hal/hal.c (rthal_calibrate_timer): Fix the way we
	calibrate the APIC programming time; the old way simply broke any
	SMP setup.

2004-09-03  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_calibrate_sched): Make the calibration
	thread struct static, so that we can't get a TCB with a badly
	aligned FPU area.

2004-09-03  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/nucleus/asm-(i386|ppc)/system.h (__xnlock_get_irqsave):
	Avoid to enable interrupts in nested critical sections.

2004-09-01  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.5

2004-09-01  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/hal/hal.c: Use standard PIT_xx defines instead of
	immediate port values.

2004-09-01  Philippe Gerum  <rpm@xenomai.org>

	* fusion: Get rid of CONFIG_RTAI_HW_NRCPUS and use the
	Linux-defined constant instead.

	* arch/ppc/patches: Update Adeos support to 2.6.8rc1-r6c5.

	* include/nucleus/asm-ppc/atomic.h: Fix register notations in
	inline assembly.

	* arch/*/defconfig: Rebuild sane defconfigs.

	* nucleus/pod.c (xnpod_calibration_thread): Calibrate during 0.3s
	regardless of the calibration period. Also provide for adjusting
	the estimated average jitter on a per-architecture basis.

	* nucleus/timer.c (xntimer_do_timers): Refresh the tested clock
	value in aperiodic mode after each timer processing loop.

	* arch/*/hal/hal.c (rthal_set_irq_affinity): Replace reset action
	by returning the old cpumask.

2004-08-31  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_calibrate_sched): Straighten error path.
	(xnpod_calibrate_sched): Disable autocalibration of the scheduling
	latency for architectures that do not provide an aperiodic timing
	source.

	* nucleus/module.c (__fusion_sys_init): Straighten error path.

2004-08-30  Philippe Gerum  <rpm@xenomai.org>

	* nucleus: Define CONFIG_RTAI_HW_APERIODIC_TIMER.

	* nucleus/timer.c (xntimer_enqueue): Completely dissociate
	periodic from aperiodic timer enqueueing/dequeueing.

2004-08-30  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* arch/ppc/hal/hal.c: Move the Doxygen documentation to a new
	group, 	hal_ppc, in order to avoid clash (and doxygen warnings)
	with x86 documentation.

2004-08-29  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/pod.c (xnpod_migrate): Initial implementation of a
	migration function.

	* nucleus/pod.c (xnpod_init, xnpod_shutdown): Remove useless calls
	to set_cpus_allowed.

	* nucleus, */system.h: Use cpumask_t for affinity, providing
	an 'unsigned long' based implementation for architectures other
	than the Linux kernel.

2004-08-29  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/pod.h (struct pod): Remove the usrthread member;
	it became meaningless with the dismissal of the threaded interrupt
	model.

	* nucleus: Prefer non-atomic bitops when applicable.

	* nucleus/pod.c (xnpod_schedule): Clarify the path to switch
	decision a bit.

2004-08-29  Marc Kleine-Budde <kleine-budde@gmx.de>

	* include/nucleus/asm-ppc/system.h (xnarch_switch_to): Do not
	fiddle with Altivec-related information if Altivec support is not
	configured in.

2004-08-28  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/timer.c (xntimer_next_shot): Update timer shot
	anticipation.

2004-08-27  Philippe Gerum  <rpm@xenomai.org>

	* nucleus: Add support for execution timestamps aimed at chasing
	excessive jitter.

	* skins/rtai/pipe.c (__pipe_close_handler): Leave the pipe struct
	alive and wait for a subsequent call to rt_pipe_close() from the
	application.

2004-08-26  Philippe Gerum  <rpm@xenomai.org>

	* arch/ppc/patches: Add 2.6.8rc1-r6c4.

	* include/nucleus/asm-ppc/system.h (xnarch_switch_to): Integrate
	various bits of user-space context switching in a single area.

	* nucleus/timer.c (xntimer_do_timers): Optimize restart point.

	* arch/ppc/hal/hal.c (rthal_calibration_timer): Return the 1 tick
	(expressed as a count of nanoseconds) instead of zero. The latter
	is a special error value.

	* testsuite/latency/latency.c (cleanup_upon_sig): Stop timer.

	* nucleus/shadow.c (xnshadow_kick_process): Check shared pending
	signal mask too.

2004-08-25  Philippe Gerum  <rpm@xenomai.org>

	* arch/ppc/hal/hal.c (rthal_calibration_timer): On PowerPC
	systems, the cost of setting the decrementer or the PIT does not
	induce significant latency; so just return zero from there without
	further evaluation.
	(rthal_trap_fault): Add simplistic handling.

	* arch/ppc/hal/switch.S (rthal_context_switch): Fix register
	offset mismatch.

2004-08-24  Philippe Gerum  <rpm@xenomai.org>

	* arch/ppc/hal/switch.S (rthal_context_switch): Enforce standard
	stack frame overhead.

	* include/nucleus/asm-i386/system.h (xnarch_sleep_on): Properly
	set the task state before sleeping on schedule_timeout().

	* include/nucleus/asm-ppc/system.h (xnarch_program_timer_shot): Do
	not rescale the delay value uselessly.

	* arch/ppc/hal/hal.c (__rthal_init): Fix tunables.timer_freq.

	* arch/i386/hal/hal.c: Make proper use of
	IPIPE_NR_XIRQS/IPIPE_NR_IRQS.

2004-08-23  Philippe Gerum  <rpm@xenomai.org>

	* arch/ppc/hal/hal.c (rthal_request_timer, rthal_release_timer):
	Implement timer setup code.

	* testsuite/cruncher/cruncher.c: Remove useless and offending
	<asm/io.h> inclusion (x86-specific).

2004-08-22  Philippe Gerum  <rpm@xenomai.org>

	* arch/ppc: Various compilation fixes.
	
	* Kconfig: Centralize generic/common Kconfig information.

	* arch/ppc/hal/fpu.S: Add FPU save/restore support.

2004-08-19  Philippe Gerum  <rpm@xenomai.org>

	* arch/ppc, include/nucleus/asm-ppc: Add PowerPC base.

	* include/nucleus/asm-i386/system.h: MODULE_LICENSE is always
	defined in 2.6: remove default definition.

2004-08-17  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-i386/hal.h: Kill obsolete
	rthal_switch_to_*() routines: system.h does this in an integrated
	fashion already.

	* include/nucleus/asm-i386/fpu.h: Kill fpu.h and integrate the
	tiny useful bit it used to provide directly into system.h.

2004-08-16  Philippe Gerum  <rpm@xenomai.org>

	* configure.in: Allow for assembly files in target modules.

2004-08-05  Marc Kleine-Budde <kleine-budde@gmx.de>

	* arch/i386/hal/hal.c (rthal_trap_fault): Remove legacy code from
	pre-Adeos times.

2004-08-05  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-uvm/system.h: Include missing
	<rtai_config.h>.

2004-08-05  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/pod.c (xnpod_welcome_thread): Fix FPU ownership on
	thread entry.

2004-08-04  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.4

2004-08-04  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/timer.c (xntimer_next_shot): Anticipate the next timer
	shot better.

2004-08-04  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/nucleus/asm-i386/system.h: Fix FPU support for
	kernel-based threads.

2004-08-03  Marc Kleine-Budde <kleine-budde@gmx.de>

	* nucleus/pod.c (xnpod_trap_fault): Ensure that faults over IRQs
	and threads are properly relayed to the user-defined fault
	handler.

	* nucleus/pod.c (xnpod_announce_tick): Move the test for the timer
	mode away from the inner loop.

2004-08-03  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade to Adeos 2.6.7-i386-r6c6. This is
	needed to have the APIC timing in uniprocessor mode properly
	working.

2004-08-02  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/hal/hal.c: Refactor the timer support.  As a result of
	the changes: 1) the code automatically adapts to the timer used by
	the kernel configuration, and only for this one
	(CONFIG_X86_LOCAL_APIC or not); 2) the UP+LAPIC configuration now
	works properly; 3) the timer-related API exposed is much more
	consistent.

	* arch/i386/patches: Upgrade to Adeos 2.6.7-i386-r6c5.

2004-08-02  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-i386/system.h (XNARCH_CALIBRATION_PERIOD):
	Set to 100 us.

	* arch/i386/hal/hal.c (rthal_trap_fault): Remove obsolete code
	trapping exception #7 over the RTAI domain.

	* nucleus/timer.c (xntimer_next_shot): Rewrite so that the
	calibrated latencies are properly used.

	* nucleus/pod.c (xnpod_resume_thread): Single exit branch.

2004-08-01  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/types.h: Define signed types for tick and
	nanosecond values.

	* skins/rtai/timer.c (rt_timer_ticks2ns, rt_timer_ns2ticks):
	Operate on signed input/output values.

2004-07-31  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_preempt_current_thread): Remove superfluous
	locking; it must be in effect when entering the routine in any
	case.

2004-07-27  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_sync_wait): Use the right type for
	storing a spl value.

2004-07-26  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/dbridge.c: Use SMP locking.

2004-07-25  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.3

2004-07-25  Philippe Gerum  <rpm@xenomai.org>

	* configure.in: Discard legacy kbuild support (pre-2.6.6) from
	RTAI_KBUILD_CMD.

2004-07-23  Marc Kleine-Budde <kleine-budde@gmx.de>

	* skins/posix/sem.c (sem_init): Add newly created semaphores to
	pse51_semq.

2004-07-22  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/pipe.c (rt_pipe_alloc): Fix allocation size to
	encompass the header space.

	* skins/rtai/pipe.c (__pipe_close_handler): Shutdown the kernel
	side of the pipe upon closure of the user-space side.

2004-07-22  Marc Kleine-Budde <kleine-budde@gmx.de>

	* scripts/rtai-config: Fix output of --config.

2004-07-21  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade to Adeos 2.6.7-i386-r6c4.

2004-07-21  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/pod.c (xnpod_schedule, xnpod_schedule_runnable): Test 
	the XNKILLED bit early in the scheduling functions, to avoid
	inter-cpu races conditions where one CPU decides to kill one
	thread, whereas the thread is currently	suspending itself on
	another CPU.
	(xnpod_dispatch_signals): clear the XNKILLED bit once tested.
	(xnpod_shutdown): Remove a potentially harmful xnlock_init.
							
	* nucleus/shadow.c (xnshadow_wakeup_handler): Reflect shadow
	inter-cpu migrations on its user-space mate.
				
2004-07-21  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/nucleus/asm-i386/system.h (__switch_threads): Provide
	a different version for gcc before version 3.2.
		
2004-07-17  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/nucleus/asm-i386/system.h (__switch_threads): Mark the
	eax and edx registers as input/output and ebx and esi as clobbered
	in order to avoid Debian gcc 3.3.4 to generate code reusing ebx
	after the context switch for a Xeon kernel with SMP and without
	preemption enabled.

	* nucleus/shadow.c (xnshadow_kick_process): Set the rescheduling
	bit of the killed thread's scheduler when the killed thread is
	running.

	* nucleus/shadow.c (xnshadow_schedule_head): Test whether a thread
	which is about to be scheduled is marked as blocked for the
	nucleus.
			
2004-07-07  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/pod.c (xnpod_schedule)
	  include/nucleus/pod.h (xnsched_clr_mask): Do not forget to clear
	the rescheduling bits after having sent the rescheduling IPIs.
			
2004-07-05  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>
			
	* nucleus/shadow.c (irq_shield): Manipulate the IRQ shield over
	the IShield domain, instead of the Root domain. Do not send IPIs
	to CPU which do not exist or are not online.
						
2004-07-04  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/thread.c (xnthread_symbolic_status): Add helper function
	to convert a thread status word into its symbolic
	(i.e. human-readable) representation.

2004-07-01  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_relax): Do not hold the nucleus
	superlock while performing the Linux scheduling tail; just lock
	the local IRQs out.

2004-06-30  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_kick_process): Do not hold the
	nucleus superlock while sending the scheduling request to the high
	stage.

2004-06-30  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.2

2004-06-30  Philippe Gerum  <rpm@xenomai.org>

	* testsuite/cruncher: Add a test measuring the nanosleep() and
	execution time jitters w/ and w/o RTAI/fusion.

2004-06-29  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/fusion.c (__pthread_shadow_helper): Protect the mapping
	phase from asynchronous deletion of the new shadow thread.

	* skins/rtai/syscall.c (__rt_task_create): Downgrade the lock held
	during xnshadow_map() from global (nucleus superlock) to local
	(IRQ masking).

	* skins/rtai/cond.c: Add Doxygen documentation of services.

	* include/nucleus/asm-i386/system.h (xnarch_setimask): Inline it.

	* nucleus/module.c: Export missing symbols.

2004-06-29  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* nucleus/shadow.c (xnshado_map, xnshadow_attach_skin,
	xnshadow_unmap): Fix the skin reference counting.
		
2004-06-28  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade the x86 patch to 2.6.7r6c1. Discard
	older r5 patches since critical fixes are brought by this one,
	Linux-wise and Adeos-wise.

	* arch/i386/hal/hal.c (rthal_trap_fault): Handle RTAI-originated
	faults in kernel space caused by on-demand virtual memory
	mappings.

	* nucleus/shadow.c: Import SMP-related changes.

	* skins/rtai/pipe.c (rt_pipe_open): Set magic number.

2004-06-28  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* skins/psos+, skins/rtai, skins/uitron, skins/vrtx: adaptation to SMP.

	* */asm*/system.h: same cleanup.

	* include/nucleus/asm-i386/system.h: SMP code cleanup.

2004-06-27  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-i386/system.h: Better split the SMP/UP code
	so that the #ifdef hell is reduced.

2004-06-26  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/heap.c: Remove the automatically extendable heap
	feature: this proved to be useless and confusing. Provide
	xnheap_extend() to manually extend any given heap instead.
	Fix documentation and skins accordingly.

2004-06-25  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_schedule_runnable): Fix XNSCHED handling,
	so that we still leave this bit on if no thread switch is
	performed.
	(xnpod_schedule): Optimize and iron SMP case.

2004-06-24  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* arch/i386/Kconfig, arch/i386/defconfig, configure.in: correctly
	handle the configure-time number of cpus.

2004-06-23  Philippe Gerum  <rpm@xenomai.org>

	* configure.in: Do not pass SUBDIRS to the kernel builder anymore;
	only rely on M=.

	* include/nucleus/asm-i386/system.h (xnarch_thread_redirect): 
	Force regparm(0) so that we are still safe if CONFIG_REGPARM is
	enabled (use "asmlinkage" for that).

2004-06-21  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/hal/hal.c (rthal_domain_entry): Disable sync (debug)
	mode for printk().

	* nucleus/lib/fusion.c (pthread_migrate_rt): Directly use the
	nucleus-based migration service: this one works properly in all
	cases...

2004-06-21  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* configure.in, GNUmakefile.am: handle correctly the "all" and "dist"
	targets, whether or not the doc and sim directories are present in
	the source tree.

2004-06-20  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai: Export interface symbols.

2004-06-19  Philippe Gerum  <rpm@xenomai.org>

	* doc/docbook/docbook-test/xenomai.xml: Refactor the paper
	according to the latest RTAI/Xenomai evolution.

2004-06-18  Philippe Gerum  <rpm@xenomai.org>

 	* RELEASE: fusion-0.1

2004-06-18  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/patches: Upgrade the x86 patches to 2.6r5 final. Add
	support for 2.6.7.

	* skins/rtai/syscall.c: Do not compile in unselected optional
	support.
	
	* skins/rtai/syscall.c: Properly handle calls on self task object.

	* skins/rtai/syscall.c: Only fetch objects address but do not lock
	them since the descriptor will be (re-)verified by the syscall,
	and we want the possibly pended object to be destroyable, and
	sleepers to unblock on the XNRMID condition.

	* skins/rtai/registry.c: Implement rt_registry_fetch().

2004-06-17  Philippe Gerum  <rpm@xenomai.org>

	* configure.in: Clobber *.o in RTAI_KBUILD_CLEAN.

	* skins/rtai/cond.c: Add condition variable support.

	* skins/rtai/mutex.c: Add mutex support.

	* nucleus/fusion.c (__pthread_set_periodic_rt,
	__pthread_wait_period_rt): Use new nucleus's built-in support for
	periodic timing.

	* skins/rtai/task.c (rt_task_set_periodic, rt_task_wait_period):
	Use new nucleus's built-in support for periodic timing.

	* nucleus/pod.c (xnpod_set_thread_periodic,
	xnpod_wait_thread_period): Add built-in support for periodic
	timing.

	* nucleus/shadow.c: Rollback some changes from the SMP port
	reinstating proper protection around critical sections.

2004-06-16  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/thread.h: Rename thread::timer to thread::rtimer
	for "resource timer" in order to comply with the other timer
	names.

	* nucleus/pod.c (xnpod_delete_thread): Stop the periodic timer
	before deleting the thread.

2004-06-15  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_realtime_sysentry): Properly return
	-ENOSYS upon syscall request without any skin loaded.

	* nucleus/pod.c (xnpod_schedule_runnable): Postpone
	xnsched_clr_resched() so that calls with XNPOD_NOSWITCH set don't
	clear it.

	* nucleus/pod.c (xnpod_schedule): Make sure we don't lose the
	rescheduling bit upon early exit.
	
	* nucleus/thread.c (xnthread_init): Add built-in support for
	periodic timing.

2004-06-13  Philippe Gerum  <rpm@xenomai.org>

	* scripts/rtai-load.in: Use modprobe instead of insmod for modules
	from /lib/modules.

2004-06-11  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/syscall.c: Export event group interface.

	* skins/rtai/event.c: Add documentation.

2004-06-10  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/event.c: Fully implement the event flag group.

	* nucleus/pod.c (xnpod_init_thread): Discard magic parameter. Use
	xnthread_set_magic() after creation instead.

	* nucleus/thread.c (xnthread_init): Discard magic parameter as a
	consequence of the above change.

	* configure.in: Pass ARCH in RTAI_KBUILD_CMD.

2004-06-09  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-i386/system.h (xnarch_switch_to): Integrate
	the memory context switch code inline.

	* arch/i386/hal/hal.c: Discard rthal_linux_switch_mm().

2004-06-07  Philippe Gerum  <rpm@xenomai.org>

	* scripts/rtai-load.in: Add application loader adapted from
	vesuvio.

	* testsuite: Add testsuite embryo. First, a plain and simple
	latency test.

2004-06-06  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/system.h: Remove useless inclusions for plain
	user-space mode.

2004-06-06  Philippe Gerum  <rpm@xenomai.org>

	* Move to GNA (http://www.gna.org/projects/rtai/).

2004-06-06  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/system.h: New wrapper file for user-space
	inclusion. Wraps to the nucleus/asm-uvm/ pseudo-architecture when
	compiling the user-space VMs.

	* include/nucleus/vm: Replaced and refactored by nucleus/asm-uvm/.

2004-06-05  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-i386/hal.h,
	sim/include/nucleus/asm/system/h,
	include/nucleus/vm/nucleus/asm/system.h: Add ffnz().

2004-06-04  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_calibrate_sched): Make extern.

2004-06-04  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* fusion: SMP port contributed by the HYADES project
	(http://www.hyades-itea.org/).
	
2004-06-04  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/mutex.c: Remove mutex support which proved to raise
	performances issues, especially in SMP mode.

	* nucleus/pod.c (xnpod_init_thread, xnpod_start_thread): Kill
	arch-dependent cookie.

	* include/nucleus/asm-i386/hal.h: Cleanup a few obsolete macros.

	* nucleus/shadow.c: Discard autoswitch mode to RTAI upon return
	from Linux; it proved useless by design. Additionally, this
	removes the need for intercepting the syscall exit event.

2004-06-02  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/syscall.c: Wrap semaphore services.

2004-06-01  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c: Add autocalibration code for scheduling and timer
	latencies.

	* fusion: Replace Xenomai-defined errcodes by standard POSIX ones.

	* nucleus/pod.c (xnpod_start_timer): Make sure the user cannot
	specify a host tick shorter than the timer precision.

2004-05-31  Philippe Gerum  <rpm@xenomai.org>

	* skins/uitron, skins/vrtx: Use interrupt masking instead of
	an interface mutex.

	* nucleus/timer.c (xntimer_do_timers): Postpone the propagation of
	the host tick to the interrupt epilogue (xnintr_irq_handler()).

2004-05-29  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai: Use interrupt masking instead of an interface mutex.

	* nucleus/intr.c, nucleus/pod.c: Dismantle support for interrupt
	service threads, which proved to be too higher an abstraction for
	the nanokernel which would be better provided by the skins
	themselves, using their own semantics (e.g. the fact that ISVCs
	could not block is a major drawback wrt usability).
	Performance-wise, handling the clock interrupt over an ISVC also
	showed far too much overhead compared to a direct handling over
	ISRs. This global change also means that clock ticks are now
	directly handled over the timer ISR.

	* nucleus/pod.c (xnpod_schedule_runnable): Clear the XNSCHED flag.

2004-05-28  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c (xnpod_stop_timer): Freeze all running timers.

	* nucleus/timer.c (xntimer_freeze): Add support for dequeuing all
	running software timers upon request to stop the hardware timer.

	* nucleus/pod.c (xnpod_init_thread): Make sure we don't accept
	extraneous flags for the thread.

2004-05-26  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* GNUmakefile.am (SUBDIRS): moved the distribution of the "config"
	directory to config/GNUmakefile.am to avoid a conflict with the
	phony config target which occured when running "make dist".

2004-05-26  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/pod.c: Remove the obsolete and unfinished debugger
	support and xnpod_freeze()/unfreeze() routines which are
	definitely lethal in a mutex-enabled system, since one could
	accidentally suspend a thread owning a mutex without competing for
	the said mutex first.
	(xnpod_init): Manage a "still initializing" bit so that we don't
	try to refer to a half-baked pod from some Adeos event hooks that
	may preempt xnpod_init()
	[e.g. ADEOS_SCHEDULE_HEAD set up by the shadow support].

2004-05-26  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* include/nucleus/mutex.h (xnmutex_clear_lock, xnmutex_set_lock):
	Make sure we account for any change of the mutex state
	(pended/free) when reinstating its value.
	
2004-05-26  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/mutex.c (xnmutex_forget_sleeper): 

	* nucleus/timer.c (xntimer_set_initial_date): Make sure interval
	timers using an aperiodic time source use a constant epoch to
	compute the time of the next shot, and not the current CPU time.
	(xntimer_stop): Reprogram the aperiodic hardware for the next shot
	if removing the heading timer.

	* skins/rtai/task.c (__task_delete_hook): Destroy the periodic
	timer.

2004-05-25  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/fusion.c: Fix modifier of pthread_sleep_rt().

	* nucleus/intr.c (xnintr_svc_thread): Ensure nested interrupts are
	never lost.

2004-05-24  Philippe Gerum  <rpm@xenomai.org>

	* include/nucleus/asm-i386/system.h (xnarch_program_timer_shot):
	Make sure we do not set the timer for an elapse time shorter than
	the calibrated value for programming it.
	
2004-05-23  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/task.c (rt_task_set_periodic): Properly test the
	return value of xntimer_start() so that any attempt to set the
	first periodic release point in the past is detected.

	* include/nucleus/asm-i386/system.h: Properly scale the CPU
	frequency-based input value to a PIT frequency-based one.

2004-05-22  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_umount): Make sure to run the Linux
	scheduling tail code before exiting a mapped task.

2004-05-21  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_realtime_sysentry): Always propagate
	regular Linux syscalls to the low domain stage handler if we are
	running over the root thread.

	* nucleus/shadow.c (get_calling_task): Improve robustness.

2004-05-19  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/lib/fusion.c: Fix migration switches.

2004-05-21  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* skins/posix/cond.c (cond_timedwait_internal): no longer try to
	be smart about why xnsynch_sleep_on returned; cause a wakeup and
	let the application decide. Move the functions saving and
	restoring mutex lock counts to mutex.h.

	* skins/posix/signal.c: replace the direct bitfields
	manipulations by the macros setbits, clrbits et testbits.

	* skins/vxworks/taskLib.c (testSafe): removed the useless and
	harmful calls to xnpod_lock_sched and xnpod_unlock_sched.

2004-05-18  Gilles Chanteperdrix  <gilles.chanteperdrix@laposte.net>

	* rtai-doc/install-dist.rules, rtai-doc/docbook/docbook.rules :
	suppressed empty 'for' loops to avoid a bug occuring with versions
	of bash before 2.05a. For details, see :
	http://www.unixguide.net/unix/bash/E7.shtml

2004-05-18  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/shadow.c (xnshadow_map): Rely on the standard
	xnthread_init() routine for having prepared the thread struct; do
	not handcraft it anymore.

	* skins/rtai/registry.c (rt_registry_get): Fix the return value.
	(rt_registry_enter): Properly index the specified opaque object.

	* nucleus/shadow.c (xnshadow_realtime_sysentry): Mark the syscalls
	requiring a shadow context to run instead of the opposite.

2004-05-17  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/module.c (__fusion_skin_init): Set up init sequence.

	* skins/rtai/timer.c (rt_timer_start): Add call to start the
	timer.

	* skins/rtai/registry.c: Rework safe/unsafe handling.

	* skins/rtai/pipe.c (rt_pipe_write): Flush the streamed output
	prior to sending.

	* include/nucleus/asm-i386/hal.h (rthal_ulldiv): Allow for
	optional remainder.

	* nucleus/shadow.c: Use a per-thread status bit to handle the kill
	condition instead of polluting the signal namespace.

	* nucleus/shadow.c (xnshadow_substitute_syscall): Fix timeout
	handling in aperiodic mode.

2004-05-16  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/pipe.c (rt_pipe_fill): Add flushable bit to prevent
	multiple enqueing.

	* skins/rtai/pipe.c (rt_pipe_close): Ensure the flushable data are
	purged on pipe closure.

	* arch/i386/hal/hal.c (rthal_pend_linux_srq): Return the TAS flag
	for the operation.

	* skins/rtai/pipe.c (rt_pipe_fill): Add primitive to use pipe in
	byte stream mode from kernel to userland.

	* arch/i386/hal/hal.c: Reserve SRQ #0 as invalid.

	* skin/rtai/pipe.c: Provide support for inter-domain communication
	channels.
	
	* skins/rtai, configure.in: Make registry support optional.

2004-05-15  Philippe Gerum  <rpm@xenomai.org>

	* skins/rtai/task.c: Return -ETIMEDOUT instead of -EAGAIN.

	* configure.in, arch/i386/Kconfig: Make the total number of
	registry slots configurable.
	
	* skins/rtai/registry.c: Add registry support.

2004-05-13  Philippe Gerum  <rpm@xenomai.org>

	* arch/i386/hal/hal.c: Fix placeholder names of IRQ affinity
	services in UP case.

	* skins/rtai/task.c: Allow passing implicit 'self' argument using
	a NULL task pointer to rt_task_delete(), rt_task_suspend() and
	rt_task_inquire().

2004-05-12  Philippe Gerum  <rpm@xenomai.org>

	* nucleus/timer.c: Deal with CPU ticks internally when running in
	aperiodic mode, but still expose nanosecond parameters to the
	upper interface.

	* nucleus/timer.c, nucleus/thread.h: Make all time computations
	consistent with the current internal unit.

2004-05-10  Philippe Gerum  <rpm@xenomai.org>

	* fusion: Put baseline on the public CVS.

2004-05-06  Philippe Gerum  <rpm@xenomai.org>

	* sim: Adapt simulation support. Discard (now useless)
	VRTAI-related support.
	
	* nucleus/fusion.c: Integrate the fusion interface to the nucleus and
	make it auto loadable/unloadable.

2004-05-03  Philippe Gerum  <rpm@xenomai.org>

	* skins/native: Start skin aimed at refactoring the original RTAI
	API.
	
	* nucleus/heap.c (xnheap_free): Fix a potential race upon concurrent
	release of the same block.

2004-05-02  Philippe Gerum  <rpm@xenomai.org>

	* skins/posix: Coding style updates.

2004-05-01  Philippe Gerum  <rpm@xenomai.org>

	* configure.in: Ensure that rtai_srctree and rtai_srcdir are
	always absolute paths. This fixes out-of-tree builds when
	executing the configure script by hand.

2004-04-30  Philippe Gerum  <rpm@xenomai.org>

	* fusion: Organize directory layout and adapt configuration and
	build systems.

	* Started: baseline from Xenomai as of 3.1-test2.
