<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI Fusion API: include/nucleus/asm-ia64/hal.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000009.html">include</a>&nbsp;/&nbsp;<a class="el" href="dir_000010.html">nucleus</a>&nbsp;/&nbsp;<a class="el" href="dir_000013.html">asm-ia64</a></div>
<h1>hal.h</h1><a href="asm-ia64_2hal_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00031 <span class="preprocessor">#ifndef _RTAI_ASM_IA64_HAL_H</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#define _RTAI_ASM_IA64_HAL_H</span>
00033 <span class="preprocessor"></span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="asm-generic_2hal_8h.html">nucleus/asm-generic/hal.h</a>&gt;</span>    <span class="comment">/* Read the generic bits. */</span>
00035 
00036 <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rthal_time_t;
00037 
00038 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rthal_ullmul(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> m0, 
00039                                               <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> m1)
00040 {
00041     <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) m0 * m1;
00042 }
00043 
00044 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rthal_ulldiv (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ull,
00045                                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> uld,
00046                                                <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *<span class="keyword">const</span> rp)
00047 {
00048     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> result = ull / uld;
00049 
00050     <span class="keywordflow">if</span> (rp)
00051         *rp = ull % uld;
00052 
00053     <span class="keywordflow">return</span> result;
00054 }
00055 
00056 <span class="preprocessor">#define rthal_uldivrem(ull,ul,rp) ((u_long) rthal_ulldiv((ull),(ul),(rp)))</span>
00057 <span class="preprocessor"></span>
00058 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> rthal_imuldiv (<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> mult, <span class="keywordtype">int</span> div)
00059 {
00060     <span class="keywordflow">return</span> ((<span class="keywordtype">long</span> <span class="keywordtype">long</span>)i * mult) / div;
00061 }
00062 
00063 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rthal_llimd (<span class="keywordtype">long</span> <span class="keywordtype">long</span> op,
00064                                      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> m,
00065                                      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> d)
00066 {
00067     <span class="keywordtype">long</span> <span class="keywordtype">long</span> h, l, qh, ql, rh;
00068 
00069     <span class="comment">/* (ll * mult) may need 96 bits, so we split it into two parts. We use / and</span>
00070 <span class="comment">       % on purpose, not shift operations, to handle correctly negative numbers.</span>
00071 <span class="comment">    */</span>
00072     h = (op / (1LL &lt;&lt; 32)) * m;
00073     l = (op % (1LL &lt;&lt; 32)) * m;
00074     h += l / (1LL &lt;&lt; 32);
00075     l %= (1LL &lt;&lt; 32);
00076 
00077     rh = (h % d) * (1LL &lt;&lt; 32);
00078     qh = (h / d) * (1LL &lt;&lt; 32);
00079     ql = (rh + l) / d;
00080 
00081     <span class="keywordflow">return</span> qh + ql;
00082 }
00083 
00084 <span class="keyword">static</span> <span class="keyword">inline</span>  __attribute_const__ <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ffnz (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ul)
00085 {
00086     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> r;
00087     <span class="keyword">asm</span> (<span class="stringliteral">"popcnt %0=%1"</span> : <span class="stringliteral">"=r"</span> (r) : <span class="stringliteral">"r"</span> ((ul-1) &amp; ~ul));
00088     <span class="keywordflow">return</span> r;
00089 }
00090 
00091 <span class="preprocessor">#if defined(__KERNEL__) &amp;&amp; !defined(__cplusplus)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#include &lt;asm/system.h&gt;</span>
00093 <span class="preprocessor">#include &lt;nucleus/asm/atomic.h&gt;</span>
00094 <span class="preprocessor">#include &lt;asm/processor.h&gt;</span>
00095 <span class="preprocessor">#include &lt;asm/delay.h&gt;</span>          <span class="comment">/* For ia64_get_itc / ia64_set_itm */</span>
00096 
00097 <span class="preprocessor">#define RTHAL_TIMER_VECTOR      ADEOS_SERVICE_VECTOR3</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#define RTHAL_TIMER_IRQ         ADEOS_SERVICE_IPI3</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#define RTHAL_HOST_TIMER_VECTOR IA64_TIMER_VECTOR</span>
00100 <span class="preprocessor"></span><span class="preprocessor">#define RTHAL_HOST_TIMER_IRQ    __ia64_local_vector_to_irq(IA64_TIMER_VECTOR)</span>
00101 <span class="preprocessor"></span>
00102 <span class="preprocessor">#define rthal_irq_descp(irq)  irq_descp(irq)</span>
00103 <span class="preprocessor"></span>
00104 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rthal_rdtsc (<span class="keywordtype">void</span>)
00105 {
00106     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> t;
00107     adeos_hw_tsc(t);
00108     <span class="keywordflow">return</span> t;
00109 }
00110 
00111 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>task_struct *rthal_root_host_task (<span class="keywordtype">int</span> cpuid)
00112 {
00113     <span class="keywordflow">return</span> current;
00114 }
00115 
00116 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>task_struct *rthal_current_host_task (<span class="keywordtype">int</span> cpuid)
00117 {
00118     <span class="keywordflow">return</span> current;
00119 }
00120 
00121 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rthal_timer_program_shot (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> delay)
00122 {
00123     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00124     <span class="keywordflow">if</span> (!delay) { delay = 10; }
00125     rthal_hw_lock(flags);
00126     ia64_set_itm(ia64_get_itc() + delay);
00127     rthal_hw_unlock(flags);
00128 }
00129 
00130     <span class="comment">/* Private interface -- Internal use only */</span>
00131 
00132 <span class="keywordtype">void</span> rthal_switch_context(<span class="keywordtype">void</span> *out_tcb,
00133                           <span class="keywordtype">void</span> *in_tcb);
00134 
00135 <span class="keywordtype">void</span> rthal_prepare_stack(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> stackbase);
00136 
00137 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> rthal_fault_labels[] = {
00138     [0] = <span class="stringliteral">"General exception"</span>,
00139     [1] = <span class="stringliteral">"FPU disabled"</span>,
00140     [2] = <span class="stringliteral">"NaT consumption"</span>,
00141     [3] = <span class="stringliteral">"Unsupported data reference"</span>,
00142     [4] = <span class="stringliteral">"Debug"</span>,
00143     [5] = <span class="stringliteral">"FPU fault"</span>,
00144     [6] = <span class="stringliteral">"Unimplemented instruction address"</span>,
00145     [7] = <span class="stringliteral">"ia32 exception"</span>,
00146     [8] = <span class="stringliteral">"Generic fault"</span>,
00147     [9] = <span class="stringliteral">"Page fault"</span>,
00148     [10] = NULL
00149 };
00150 
00151 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL__ &amp;&amp; !__cplusplus */</span>
00152 
00155 <span class="preprocessor">#endif </span><span class="comment">/* !_RTAI_ASM_IA64_HAL_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jun 22 18:44:54 2005 for RTAI Fusion API by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
