<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI Fusion API: skins/rtdm/rtdm_driver.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000018.html">skins</a>&nbsp;/&nbsp;<a class="el" href="dir_000020.html">rtdm</a></div>
<h1>rtdm_driver.h</h1><a href="rtdm__driver_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00025 <span class="preprocessor">#ifndef _RTDM_DRIVER_H</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#define _RTDM_DRIVER_H</span>
00027 <span class="preprocessor"></span>
00028 <span class="preprocessor">#ifndef __KERNEL__</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#error This header is for kernel space usage only. \</span>
00030 <span class="preprocessor">       You are likely looking for rtdm/rtdm.h...</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* !__KERNEL__ */</span>
00032 
00033 <span class="preprocessor">#include &lt;asm/atomic.h&gt;</span>
00034 <span class="preprocessor">#include &lt;linux/list.h&gt;</span>
00035 
00036 <span class="preprocessor">#include &lt;nucleus/fusion.h&gt;</span>
00037 <span class="preprocessor">#include &lt;nucleus/heap.h&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="pod_8h.html">nucleus/pod.h</a>&gt;</span>
00039 <span class="preprocessor">#include &lt;nucleus/synch.h&gt;</span>
00040 <span class="preprocessor">#include &lt;<a class="code" href="rtdm_8h.html">rtdm/rtdm.h</a>&gt;</span>
00041 
00042 
00043 <span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>;
00044 
00045 
<a name="l00053"></a><a class="code" href="rtdm__driver_8h.html#a0">00053</a> <span class="preprocessor">#define RTDM_EXCLUSIVE              0x0001</span>
00054 <span class="preprocessor"></span>
<a name="l00056"></a><a class="code" href="rtdm__driver_8h.html#a1">00056</a> <span class="preprocessor">#define RTDM_NAMED_DEVICE           0x0010</span>
00057 <span class="preprocessor"></span>
<a name="l00060"></a><a class="code" href="rtdm__driver_8h.html#a2">00060</a> <span class="preprocessor">#define RTDM_PROTOCOL_DEVICE        0x0020</span>
00061 <span class="preprocessor"></span>
<a name="l00063"></a><a class="code" href="rtdm__driver_8h.html#a3">00063</a> <span class="preprocessor">#define RTDM_DEVICE_TYPE_MASK       0x00F0</span>
00064 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="rtdm__driver_8h.html#a4">00074</a> <span class="preprocessor">#define RTDM_CREATED_IN_NRT         0</span>
00075 <span class="preprocessor"></span>
<a name="l00077"></a><a class="code" href="rtdm__driver_8h.html#a5">00077</a> <span class="preprocessor">#define RTDM_CLOSING                1</span>
00078 <span class="preprocessor"></span>
<a name="l00081"></a><a class="code" href="rtdm__driver_8h.html#a6">00081</a> <span class="preprocessor">#define RTDM_FORCED_CLOSING         2</span>
00082 <span class="preprocessor"></span>
<a name="l00084"></a><a class="code" href="rtdm__driver_8h.html#a7">00084</a> <span class="preprocessor">#define RTDM_USER_CONTEXT_FLAG      8   </span><span class="comment">/* first user-definable flag */</span>
00085 
<a name="l00093"></a><a class="code" href="rtdm__driver_8h.html#a8">00093</a> <span class="preprocessor">#define RTDM_DEVICE_STRUCT_VER      3</span>
00094 <span class="preprocessor"></span>
<a name="l00096"></a><a class="code" href="rtdm__driver_8h.html#a9">00096</a> <span class="preprocessor">#define RTDM_CONTEXT_STRUCT_VER     3</span>
00097 <span class="preprocessor"></span>
<a name="l00099"></a><a class="code" href="rtdm__driver_8h.html#a10">00099</a> <span class="preprocessor">#define RTDM_API_VER                3</span>
00100 <span class="preprocessor"></span>
<a name="l00102"></a><a class="code" href="rtdm__driver_8h.html#a11">00102</a> <span class="preprocessor">#define RTDM_API_MIN_COMPAT_VER     3</span>
00103 <span class="preprocessor"></span>
<a name="l00105"></a><a class="code" href="rtdm__driver_8h.html#a12">00105</a> <span class="preprocessor">#define RTDM_SECURE_DEVICE          0x80000000</span>
00106 <span class="preprocessor"></span>
00126 <span class="keyword">typedef</span>
<a name="l00127"></a><a class="code" href="rtdm__driver_8h.html#a47">00127</a>     int     (*<a class="code" href="rtdm__driver_8h.html#a47">rtdm_open_handler_t</a>)   (<span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>   *context,
00128                                       rtdm_user_info_t          *user_info,
00129                                       <span class="keywordtype">int</span>                       oflag);
00130 
00143 <span class="keyword">typedef</span>
<a name="l00144"></a><a class="code" href="rtdm__driver_8h.html#a48">00144</a>     int     (*<a class="code" href="rtdm__driver_8h.html#a48">rtdm_socket_handler_t</a>) (<span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>   *context,
00145                                       rtdm_user_info_t          *user_info,
00146                                       <span class="keywordtype">int</span>                       protocol);
00147 
00159 <span class="keyword">typedef</span>
<a name="l00160"></a><a class="code" href="rtdm__driver_8h.html#a49">00160</a>     int     (*<a class="code" href="rtdm__driver_8h.html#a49">rtdm_close_handler_t</a>)  (<span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>   *context,
00161                                       rtdm_user_info_t          *user_info);
00162 
00176 <span class="keyword">typedef</span>
<a name="l00177"></a><a class="code" href="rtdm__driver_8h.html#a50">00177</a>     int     (*<a class="code" href="rtdm__driver_8h.html#a50">rtdm_ioctl_handler_t</a>)  (<span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>   *context,
00178                                       rtdm_user_info_t          *user_info,
00179                                       <span class="keywordtype">int</span>                       request,
00180                                       <span class="keywordtype">void</span>                      *arg);
00181 
00195 <span class="keyword">typedef</span>
<a name="l00196"></a><a class="code" href="rtdm__driver_8h.html#a51">00196</a>     ssize_t (*<a class="code" href="rtdm__driver_8h.html#a51">rtdm_read_handler_t</a>)   (<span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>   *context,
00197                                       rtdm_user_info_t          *user_info,
00198                                       <span class="keywordtype">void</span>                      *buf,
00199                                       size_t                    nbyte);
00200 
00215 <span class="keyword">typedef</span>
<a name="l00216"></a><a class="code" href="rtdm__driver_8h.html#a52">00216</a>     ssize_t (*<a class="code" href="rtdm__driver_8h.html#a52">rtdm_write_handler_t</a>)  (<span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>   *context,
00217                                       rtdm_user_info_t          *user_info,
00218                                       <span class="keyword">const</span> <span class="keywordtype">void</span>                *buf,
00219                                       size_t                    nbyte);
00220 
00236 <span class="keyword">typedef</span>
<a name="l00237"></a><a class="code" href="rtdm__driver_8h.html#a53">00237</a>     ssize_t (*<a class="code" href="rtdm__driver_8h.html#a53">rtdm_recvmsg_handler_t</a>)(<span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>   *context,
00238                                       rtdm_user_info_t          *user_info,
00239                                       <span class="keyword">struct </span>msghdr             *msg,
00240                                       <span class="keywordtype">int</span>                       flags);
00241 
00257 <span class="keyword">typedef</span>
<a name="l00258"></a><a class="code" href="rtdm__driver_8h.html#a54">00258</a>     ssize_t (*<a class="code" href="rtdm__driver_8h.html#a54">rtdm_sendmsg_handler_t</a>)(<span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>   *context,
00259                                       rtdm_user_info_t          *user_info,
00260                                       <span class="keyword">const</span> <span class="keyword">struct </span>msghdr       *msg,
00261                                       <span class="keywordtype">int</span>                       flags);
00264 <span class="keyword">typedef</span>
00265     int     (*rtdm_rt_handler_t)     (<span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>   *context,
00266                                       rtdm_user_info_t          *user_info,
00267                                       <span class="keywordtype">void</span>                      *arg);
00268 
00269 
<a name="l00273"></a><a class="code" href="structrtdm__operations.html">00273</a> <span class="keyword">struct </span><a class="code" href="structrtdm__operations.html">rtdm_operations</a> {
<a name="l00278"></a><a class="code" href="structrtdm__operations.html#z27_0">00278</a>     <a class="code" href="rtdm__driver_8h.html#a49">rtdm_close_handler_t</a>            <a class="code" href="structrtdm__operations.html#z27_0">close_rt</a>;
<a name="l00281"></a><a class="code" href="structrtdm__operations.html#z27_1">00281</a>     <a class="code" href="rtdm__driver_8h.html#a49">rtdm_close_handler_t</a>            <a class="code" href="structrtdm__operations.html#z27_1">close_nrt</a>;
<a name="l00283"></a><a class="code" href="structrtdm__operations.html#z27_2">00283</a>     <a class="code" href="rtdm__driver_8h.html#a50">rtdm_ioctl_handler_t</a>            <a class="code" href="structrtdm__operations.html#z27_2">ioctl_rt</a>;
<a name="l00285"></a><a class="code" href="structrtdm__operations.html#z27_3">00285</a>     <a class="code" href="rtdm__driver_8h.html#a50">rtdm_ioctl_handler_t</a>            <a class="code" href="structrtdm__operations.html#z27_3">ioctl_nrt</a>;
<a name="l00291"></a><a class="code" href="structrtdm__operations.html#z28_0">00291</a>     <a class="code" href="rtdm__driver_8h.html#a51">rtdm_read_handler_t</a>             <a class="code" href="structrtdm__operations.html#z28_0">read_rt</a>;
<a name="l00293"></a><a class="code" href="structrtdm__operations.html#z28_1">00293</a>     <a class="code" href="rtdm__driver_8h.html#a51">rtdm_read_handler_t</a>             <a class="code" href="structrtdm__operations.html#z28_1">read_nrt</a>;
<a name="l00295"></a><a class="code" href="structrtdm__operations.html#z28_2">00295</a>     <a class="code" href="rtdm__driver_8h.html#a52">rtdm_write_handler_t</a>            <a class="code" href="structrtdm__operations.html#z28_2">write_rt</a>;
<a name="l00297"></a><a class="code" href="structrtdm__operations.html#z28_3">00297</a>     <a class="code" href="rtdm__driver_8h.html#a52">rtdm_write_handler_t</a>            <a class="code" href="structrtdm__operations.html#z28_3">write_nrt</a>;
<a name="l00303"></a><a class="code" href="structrtdm__operations.html#z29_0">00303</a>     <a class="code" href="rtdm__driver_8h.html#a53">rtdm_recvmsg_handler_t</a>          <a class="code" href="structrtdm__operations.html#z29_0">recvmsg_rt</a>;
<a name="l00305"></a><a class="code" href="structrtdm__operations.html#z29_1">00305</a>     <a class="code" href="rtdm__driver_8h.html#a53">rtdm_recvmsg_handler_t</a>          <a class="code" href="structrtdm__operations.html#z29_1">recvmsg_nrt</a>;
<a name="l00307"></a><a class="code" href="structrtdm__operations.html#z29_2">00307</a>     <a class="code" href="rtdm__driver_8h.html#a54">rtdm_sendmsg_handler_t</a>          <a class="code" href="structrtdm__operations.html#z29_2">sendmsg_rt</a>;
<a name="l00309"></a><a class="code" href="structrtdm__operations.html#z29_3">00309</a>     <a class="code" href="rtdm__driver_8h.html#a54">rtdm_sendmsg_handler_t</a>          <a class="code" href="structrtdm__operations.html#z29_3">sendmsg_nrt</a>;
00311 };
00312 
<a name="l00324"></a><a class="code" href="structrtdm__dev__context.html">00324</a> <span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a> {
<a name="l00326"></a><a class="code" href="structrtdm__dev__context.html#o0">00326</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>                   <a class="code" href="structrtdm__dev__context.html#o0">context_flags</a>;
<a name="l00328"></a><a class="code" href="structrtdm__dev__context.html#o1">00328</a>     <span class="keywordtype">int</span>                             <a class="code" href="structrtdm__dev__context.html#o1">fd</a>;
<a name="l00331"></a><a class="code" href="structrtdm__dev__context.html#o2">00331</a>     atomic_t                        <a class="code" href="structrtdm__dev__context.html#o2">close_lock_count</a>;
<a name="l00333"></a><a class="code" href="structrtdm__dev__context.html#o3">00333</a>     <span class="keyword">struct </span><a class="code" href="structrtdm__operations.html">rtdm_operations</a>          *<a class="code" href="structrtdm__dev__context.html#o3">ops</a>;
<a name="l00335"></a><a class="code" href="structrtdm__dev__context.html#o4">00335</a>     <span class="keyword">volatile</span> <span class="keyword">struct </span><a class="code" href="structrtdm__device.html">rtdm_device</a>     *<a class="code" href="structrtdm__dev__context.html#o4">device</a>;
<a name="l00337"></a><a class="code" href="structrtdm__dev__context.html#o5">00337</a>     <span class="keywordtype">char</span>                            <a class="code" href="structrtdm__dev__context.html#o5">dev_private</a>[0];
00338 };
00339 
00340 <span class="keyword">struct </span>rtdm_dev_reserved {
00341     <span class="keyword">struct </span>list_head                entry;
00342     atomic_t                        refcount;
00343     <span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a>         *exclusive_context;
00344 };
00345 
<a name="l00353"></a><a class="code" href="structrtdm__device.html">00353</a> <span class="keyword">struct </span><a class="code" href="structrtdm__device.html">rtdm_device</a> {
<a name="l00356"></a><a class="code" href="structrtdm__device.html#o0">00356</a>     <span class="keywordtype">int</span>                             <a class="code" href="structrtdm__device.html#o0">struct_version</a>;
00357 
<a name="l00359"></a><a class="code" href="structrtdm__device.html#o1">00359</a>     <span class="keywordtype">int</span>                             <a class="code" href="structrtdm__device.html#o1">device_flags</a>;
<a name="l00361"></a><a class="code" href="structrtdm__device.html#o2">00361</a>     size_t                          <a class="code" href="structrtdm__device.html#o2">context_size</a>;
00362 
<a name="l00364"></a><a class="code" href="structrtdm__device.html#o3">00364</a>     <span class="keywordtype">char</span>                            <a class="code" href="structrtdm__device.html#o3">device_name</a>[<a class="code" href="rtdm_8h.html#a0">RTDM_MAX_DEVNAME_LEN</a>+1];
00365 
<a name="l00367"></a><a class="code" href="structrtdm__device.html#o4">00367</a>     <span class="keywordtype">int</span>                             <a class="code" href="structrtdm__device.html#o4">protocol_family</a>;
<a name="l00369"></a><a class="code" href="structrtdm__device.html#o5">00369</a>     <span class="keywordtype">int</span>                             <a class="code" href="structrtdm__device.html#o5">socket_type</a>;
00370 
<a name="l00373"></a><a class="code" href="structrtdm__device.html#o6">00373</a>     <a class="code" href="rtdm__driver_8h.html#a47">rtdm_open_handler_t</a>             <a class="code" href="structrtdm__device.html#o6">open_rt</a>;
<a name="l00376"></a><a class="code" href="structrtdm__device.html#o7">00376</a>     <a class="code" href="rtdm__driver_8h.html#a47">rtdm_open_handler_t</a>             <a class="code" href="structrtdm__device.html#o7">open_nrt</a>;
00377 
<a name="l00380"></a><a class="code" href="structrtdm__device.html#o8">00380</a>     <a class="code" href="rtdm__driver_8h.html#a48">rtdm_socket_handler_t</a>           <a class="code" href="structrtdm__device.html#o8">socket_rt</a>;
<a name="l00383"></a><a class="code" href="structrtdm__device.html#o9">00383</a>     <a class="code" href="rtdm__driver_8h.html#a48">rtdm_socket_handler_t</a>           <a class="code" href="structrtdm__device.html#o9">socket_nrt</a>;
00384 
<a name="l00386"></a><a class="code" href="structrtdm__device.html#o10">00386</a>     <span class="keyword">struct </span><a class="code" href="structrtdm__operations.html">rtdm_operations</a>          ops;
00387 
<a name="l00389"></a><a class="code" href="structrtdm__device.html#o11">00389</a>     <span class="keywordtype">int</span>                             <a class="code" href="structrtdm__device.html#o11">device_class</a>;
<a name="l00392"></a><a class="code" href="structrtdm__device.html#o12">00392</a>     <span class="keywordtype">int</span>                             <a class="code" href="structrtdm__device.html#o12">device_sub_class</a>;
<a name="l00394"></a><a class="code" href="structrtdm__device.html#o13">00394</a>     <span class="keyword">const</span> <span class="keywordtype">char</span>                      *<a class="code" href="structrtdm__device.html#o13">driver_name</a>;
<a name="l00397"></a><a class="code" href="structrtdm__device.html#o14">00397</a>     <span class="keyword">const</span> <span class="keywordtype">char</span>                      *<a class="code" href="structrtdm__device.html#o14">peripheral_name</a>;
<a name="l00399"></a><a class="code" href="structrtdm__device.html#o15">00399</a>     <span class="keyword">const</span> <span class="keywordtype">char</span>                      *<a class="code" href="structrtdm__device.html#o15">provider_name</a>;
00400 
<a name="l00402"></a><a class="code" href="structrtdm__device.html#o16">00402</a>     <span class="keyword">const</span> <span class="keywordtype">char</span>                      *<a class="code" href="structrtdm__device.html#o16">proc_name</a>;
<a name="l00404"></a><a class="code" href="structrtdm__device.html#o17">00404</a>     <span class="keyword">struct </span>proc_dir_entry           *<a class="code" href="structrtdm__device.html#o17">proc_entry</a>;
00405 
<a name="l00407"></a><a class="code" href="structrtdm__device.html#o18">00407</a>     <span class="keywordtype">int</span>                             <a class="code" href="structrtdm__device.html#o18">device_id</a>;
00408 
<a name="l00410"></a><a class="code" href="structrtdm__device.html#o19">00410</a>     <span class="keyword">struct </span>rtdm_dev_reserved        reserved;
00411 };
00412 
00413 
00414 <span class="comment">/* --- device registration --- */</span>
00415 
00416 <span class="keywordtype">int</span> <a class="code" href="group__devregister.html#ga0">rtdm_dev_register</a>(<span class="keyword">struct</span> <a class="code" href="structrtdm__device.html">rtdm_device</a>* device);
00417 <span class="keywordtype">int</span> <a class="code" href="group__devregister.html#ga1">rtdm_dev_unregister</a>(<span class="keyword">struct</span> <a class="code" href="structrtdm__device.html">rtdm_device</a>* device, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> poll_delay);
00418 
00419 
00420 <span class="comment">/* --- inter-driver API --- */</span>
00421 
00422 <span class="preprocessor">#define rtdm_open                   rt_dev_open</span>
00423 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_socket                 rt_dev_socket</span>
00424 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_close                  rt_dev_close</span>
00425 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_ioctl                  rt_dev_ioctl</span>
00426 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_read                   rt_dev_read</span>
00427 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_write                  rt_dev_write</span>
00428 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_rescmsg                rt_dev_recvmsg</span>
00429 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_recv                   rt_dev_recv</span>
00430 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_recvfrom               rt_dev_recvfrom</span>
00431 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_sendmsg                rt_dev_sendmsg</span>
00432 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_send                   rt_dev_send</span>
00433 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_sendto                 rt_dev_sendto</span>
00434 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_bind                   rt_dev_bind</span>
00435 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_listen                 rt_dev_listen</span>
00436 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_accept                 rt_dev_accept</span>
00437 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_getsockopt             rt_dev_getsockopt</span>
00438 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_setsockopt             rt_dev_setsockopt</span>
00439 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_getsockname            rt_dev_getsockname</span>
00440 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_getpeername            rt_dev_getpeername</span>
00441 <span class="preprocessor"></span><span class="preprocessor">#define rtdm_shutdown               rt_dev_shutdown</span>
00442 <span class="preprocessor"></span>
00443 <span class="keyword">struct </span><a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a> *<a class="code" href="group__interdrv.html#ga7">rtdm_context_get</a>(<span class="keywordtype">int</span> <a class="code" href="structrtdm__dev__context.html#o1">fd</a>);
00444 
00445 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__interdrv.html#ga19">rtdm_context_lock</a>(<span class="keyword">struct</span> <a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a> *context)
00446 {
00447     atomic_inc(&amp;context-&gt;<a class="code" href="structrtdm__dev__context.html#o2">close_lock_count</a>);
00448 }
00449 
00450 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__interdrv.html#ga20">rtdm_context_unlock</a>(<span class="keyword">struct</span> <a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a> *context)
00451 {
00452     atomic_dec(&amp;context-&gt;<a class="code" href="structrtdm__dev__context.html#o2">close_lock_count</a>);
00453 }
00454 
00455 
00456 <span class="comment">/* --- clock services --- */</span>
00457 
00458 __u64 <a class="code" href="group__clock.html#ga0">rtdm_clock_read</a>(<span class="keywordtype">void</span>);
00459 
00460 
00461 <span class="comment">/* --- spin lock services --- */</span>
00471 <span class="keyword">typedef</span> spinlock_t                  rtdm_lock_t;
00472 <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>               rtdm_lockctx_t;
00473 
00474 
<a name="l00478"></a><a class="code" href="group__rtdmsync.html#ga17">00478</a> <span class="preprocessor">#define RTDM_LOCK_UNLOCKED          SPIN_LOCK_UNLOCKED</span>
00479 <span class="preprocessor"></span>
<a name="l00495"></a><a class="code" href="group__rtdmsync.html#ga18">00495</a> <span class="preprocessor">#define rtdm_lock_init(lock)        spin_lock_init(lock)</span>
00496 <span class="preprocessor"></span>
<a name="l00513"></a><a class="code" href="group__rtdmsync.html#ga19">00513</a> <span class="preprocessor">#define rtdm_lock_get(lock)         rthal_spin_lock(lock)</span>
00514 <span class="preprocessor"></span>
<a name="l00531"></a><a class="code" href="group__rtdmsync.html#ga20">00531</a> <span class="preprocessor">#define rtdm_lock_put(lock)         rthal_spin_unlock(lock)</span>
00532 <span class="preprocessor"></span>
<a name="l00550"></a><a class="code" href="group__rtdmsync.html#ga21">00550</a> <span class="preprocessor">#define rtdm_lock_get_irqsave(lock, context)    \</span>
00551 <span class="preprocessor">    rthal_spin_lock_irqsave(lock, context)</span>
00552 <span class="preprocessor"></span>
<a name="l00570"></a><a class="code" href="group__rtdmsync.html#ga22">00570</a> <span class="preprocessor">#define rtdm_lock_put_irqrestore(lock, context) \</span>
00571 <span class="preprocessor">    rthal_spin_unlock_irqrestore(lock, context)</span>
00572 <span class="preprocessor"></span>
<a name="l00589"></a><a class="code" href="group__rtdmsync.html#ga23">00589</a> <span class="preprocessor">#define rtdm_lock_irqsave(context)              \</span>
00590 <span class="preprocessor">    rthal_local_irq_save(context)</span>
00591 <span class="preprocessor"></span>
<a name="l00608"></a><a class="code" href="group__rtdmsync.html#ga24">00608</a> <span class="preprocessor">#define rtdm_lock_irqrestore(context)           \</span>
00609 <span class="preprocessor">    rthal_local_irq_restore(context)</span>
00610 <span class="preprocessor"></span>
00613 <span class="comment">/* --- Interrupt management services --- */</span>
00619 <span class="keyword">typedef</span> xnintr_t                    rtdm_irq_t;
00620 
<a name="l00628"></a><a class="code" href="group__rtdmirq.html#ga1">00628</a> <span class="keyword">typedef</span> int (*<a class="code" href="group__rtdmirq.html#ga1">rtdm_irq_handler_t</a>)(rtdm_irq_t *irq_handle);
00629 
00630 
<a name="l00637"></a><a class="code" href="group__rtdmirq.html#ga6">00637</a> <span class="preprocessor">#define RTDM_IRQ_PROPAGATE          XN_ISR_CHAINED</span>
00638 <span class="preprocessor"></span>
<a name="l00639"></a><a class="code" href="group__rtdmirq.html#ga7">00639</a> <span class="preprocessor">#define RTDM_IRQ_ENABLE             XN_ISR_ENABLE</span>
00640 <span class="preprocessor"></span>
<a name="l00659"></a><a class="code" href="group__rtdmirq.html#ga8">00659</a> <span class="preprocessor">#define rtdm_irq_get_arg(irq_handle, type)  ((type *)irq_handle-&gt;cookie)</span>
00660 <span class="preprocessor"></span>
00662 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__rtdmirq.html#ga2">rtdm_irq_request</a>(rtdm_irq_t *irq_handle,
00663                                    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irq_no,
00664                                    <a class="code" href="group__rtdmirq.html#ga1">rtdm_irq_handler_t</a> handler,
00665                                    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags,
00666                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *device_name,
00667                                    <span class="keywordtype">void</span> *arg)
00668 {
00669     <a class="code" href="group__intr.html#ga2">xnintr_init</a>(irq_handle, irq_no, handler, NULL, flags);
00670     <span class="keywordflow">return</span> <a class="code" href="group__intr.html#ga4">xnintr_attach</a>(irq_handle, arg);
00671 }
00672 
00673 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__rtdmirq.html#ga3">rtdm_irq_free</a>(rtdm_irq_t *irq_handle)
00674 {
00675     <span class="keywordflow">return</span> <a class="code" href="group__intr.html#ga5">xnintr_detach</a>(irq_handle);
00676 }
00677 
00678 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__rtdmirq.html#ga4">rtdm_irq_enable</a>(rtdm_irq_t *irq_handle)
00679 {
00680     <span class="keywordflow">return</span> <a class="code" href="group__intr.html#ga6">xnintr_enable</a>(irq_handle);
00681 }
00682 
00683 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__rtdmirq.html#ga5">rtdm_irq_disable</a>(rtdm_irq_t *irq_handle)
00684 {
00685     <span class="keywordflow">return</span> <a class="code" href="group__intr.html#ga7">xnintr_disable</a>(irq_handle);
00686 }
00687 
00688 
00689 <span class="comment">/* --- non-real-time signalling services --- */</span>
00690 
00696 <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span>                    rtdm_nrt_signal_t;
00697 
<a name="l00707"></a><a class="code" href="group__nrtsignal.html#ga1">00707</a> <span class="keyword">typedef</span> void (*<a class="code" href="group__nrtsignal.html#ga1">rtdm_nrt_sig_handler_t</a>)(rtdm_nrt_signal_t nrt_signal);
00711 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__nrtsignal.html#ga2">rtdm_nrt_signal_init</a>(rtdm_nrt_signal_t *nrt_sig,
00712                                        <a class="code" href="group__nrtsignal.html#ga1">rtdm_nrt_sig_handler_t</a> handler)
00713 {
00714     *nrt_sig = rthal_alloc_virq();
00715 
00716     <span class="keywordflow">if</span> (*nrt_sig &gt; 0)
00717         rthal_virtualize_irq(rthal_root_domain, *nrt_sig, handler, NULL,
00718                              IPIPE_HANDLE_MASK);
00719     <span class="keywordflow">else</span>
00720         *nrt_sig = -EBUSY;
00721 
00722     <span class="keywordflow">return</span> *nrt_sig;
00723 }
00724 
00725 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__nrtsignal.html#ga3">rtdm_nrt_signal_destroy</a>(rtdm_nrt_signal_t *nrt_sig)
00726 {
00727     rthal_free_virq(*nrt_sig);
00728 }
00729 
00730 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__nrtsignal.html#ga4">rtdm_nrt_pend_signal</a>(rtdm_nrt_signal_t *nrt_sig)
00731 {
00732     rthal_trigger_irq(*nrt_sig);
00733 }
00734 
00735 
00736 <span class="comment">/* --- task and timing services --- */</span>
00742 <span class="keyword">typedef</span> xnthread_t                  rtdm_task_t;
00743 
<a name="l00749"></a><a class="code" href="group__rtdmtask.html#ga1">00749</a> <span class="keyword">typedef</span> void (*<a class="code" href="group__rtdmtask.html#ga1">rtdm_task_proc_t</a>)(<span class="keywordtype">void</span> *arg);
00750 
00751 
00756 <span class="preprocessor">#define RTDM_TASK_LOWEST_PRIORITY   FUSION_LOW_PRIO</span>
00757 <span class="preprocessor"></span><span class="preprocessor">#define RTDM_TASK_HIGHEST_PRIORITY  FUSION_HIGH_PRIO</span>
00758 <span class="preprocessor"></span>
00762 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__rtdmtask.html#ga2">rtdm_task_init</a>(rtdm_task_t *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *name,
00763                                  <a class="code" href="group__rtdmtask.html#ga1">rtdm_task_proc_t</a> task_proc, <span class="keywordtype">void</span> *arg,
00764                                  <span class="keywordtype">int</span> priority, __u64 period)
00765 {
00766     <span class="keywordtype">int</span> res;
00767 
00768     res = <a class="code" href="group__pod.html#ga28">xnpod_init_thread</a>(task, name, priority, 0, 0);
00769     <span class="keywordflow">if</span> (res)
00770         <span class="keywordflow">goto</span> done;
00771 
00772     <span class="keywordflow">if</span> (!__builtin_constant_p(period) || (period != XN_INFINITE)) {
00773         res = <a class="code" href="group__pod.html#ga46">xnpod_set_thread_periodic</a>(task, XN_INFINITE,
00774                                         xnpod_ns2ticks(period));
00775         <span class="keywordflow">if</span> (res)
00776             <span class="keywordflow">goto</span> done;
00777     }
00778 
00779     res = <a class="code" href="group__pod.html#ga29">xnpod_start_thread</a>(task, 0, 0, XNPOD_ALL_CPUS, task_proc, arg);
00780 
00781   done:
00782     <span class="keywordflow">return</span> res;
00783 }
00784 
00785 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__rtdmtask.html#ga3">rtdm_task_destroy</a>(rtdm_task_t *task)
00786 {
00787     <a class="code" href="group__pod.html#ga31">xnpod_delete_thread</a>(task);
00788 }
00789 
00790 <span class="keywordtype">void</span> <a class="code" href="group__rtdmtask.html#ga8">rtdm_task_join_nrt</a>(rtdm_task_t *task, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> poll_delay);
00791 
00792 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__rtdmtask.html#ga4">rtdm_task_set_priority</a>(rtdm_task_t *task, <span class="keywordtype">int</span> priority)
00793 {
00794     <a class="code" href="group__pod.html#ga36">xnpod_renice_thread</a>(task, priority);
00795     <a class="code" href="group__pod.html#ga39">xnpod_schedule</a>();
00796 }
00797 
00798 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__rtdmtask.html#ga5">rtdm_task_set_period</a>(rtdm_task_t *task, __u64 period)
00799 {
00800     <span class="keywordflow">return</span> <a class="code" href="group__pod.html#ga46">xnpod_set_thread_periodic</a>(task, XN_INFINITE,
00801                                      xnpod_ns2ticks(period));
00802 }
00803 
00804 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__rtdmtask.html#ga7">rtdm_task_unblock</a>(rtdm_task_t *task)
00805 {
00806     <span class="keywordtype">int</span> res = <a class="code" href="group__pod.html#ga35">xnpod_unblock_thread</a>(task);
00807 
00808     <a class="code" href="group__pod.html#ga39">xnpod_schedule</a>();
00809     <span class="keywordflow">return</span> res;
00810 }
00811 
00812 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__rtdmtask.html#ga6">rtdm_task_wait_period</a>(<span class="keywordtype">void</span>)
00813 {
00814     <span class="keywordflow">return</span> <a class="code" href="group__pod.html#ga47">xnpod_wait_thread_period</a>();
00815 }
00816 
00817 <span class="keywordtype">int</span> <a class="code" href="group__rtdmtask.html#ga9">rtdm_task_sleep</a>(__u64 delay);
00818 <span class="keywordtype">int</span> <a class="code" href="group__rtdmtask.html#ga10">rtdm_task_sleep_until</a>(__u64 wakeup_time);
00819 <span class="keywordtype">void</span> <a class="code" href="group__rtdmtask.html#ga11">rtdm_task_busy_sleep</a>(__u64 delay);
00820 
00821 
00822 <span class="comment">/* --- event services --- */</span>
00823 
00824 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00825     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>                   pending;
00826     xnsynch_t                       synch_base;
00827 } rtdm_event_t;
00828 
00829 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__rtdmsync.html#ga2">rtdm_event_init</a>(rtdm_event_t *event, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pending)
00830 {
00831     event-&gt;pending = pending;
00832     <a class="code" href="group__synch.html#ga0">xnsynch_init</a>(&amp;event-&gt;synch_base, XNSYNCH_PRIO);
00833 }
00834 
00835 <span class="keywordtype">void</span> _rtdm_synch_flush(xnsynch_t *synch, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> reason);
00836 
00837 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__rtdmsync.html#ga3">rtdm_event_destroy</a>(rtdm_event_t *event)
00838 {
00839     _rtdm_synch_flush(&amp;event-&gt;synch_base, XNRMID);
00840 }
00841 
00842 <span class="keywordtype">int</span> <a class="code" href="group__rtdmsync.html#ga6">rtdm_event_wait</a>(rtdm_event_t *event, __s64 timeout);
00843 <span class="keywordtype">int</span> <a class="code" href="group__rtdmsync.html#ga7">rtdm_event_wait_until</a>(rtdm_event_t *event, __u64 timeout);
00844 <span class="keywordtype">void</span> <a class="code" href="group__rtdmsync.html#ga5">rtdm_event_signal</a>(rtdm_event_t *event);
00845 
00846 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__rtdmsync.html#ga4">rtdm_event_pulse</a>(rtdm_event_t *event)
00847 {
00848     _rtdm_synch_flush(&amp;event-&gt;synch_base, 0);
00849 }
00850 
00851 
00852 <span class="comment">/* --- semaphore services --- */</span>
00853 
00854 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00855     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>                   value;
00856     xnsynch_t                       synch_base;
00857 } rtdm_sem_t;
00858 
00859 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__rtdmsync.html#ga8">rtdm_sem_init</a>(rtdm_sem_t *sem, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> value)
00860 {
00861     sem-&gt;value = value;
00862     <a class="code" href="group__synch.html#ga0">xnsynch_init</a>(&amp;sem-&gt;synch_base, XNSYNCH_PRIO);
00863 }
00864 
00865 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__rtdmsync.html#ga9">rtdm_sem_destroy</a>(rtdm_sem_t *sem)
00866 {
00867     _rtdm_synch_flush(&amp;sem-&gt;synch_base, XNRMID);
00868 }
00869 
00870 <span class="keywordtype">int</span> <a class="code" href="group__rtdmsync.html#ga10">rtdm_sem_down</a>(rtdm_sem_t *sem, __s64 timeout);
00871 <span class="keywordtype">void</span> <a class="code" href="group__rtdmsync.html#ga11">rtdm_sem_up</a>(rtdm_sem_t *sem);
00872 
00873 
00874 <span class="comment">/* --- mutex services --- */</span>
00875 
00876 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00877     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>                   locked;
00878     xnsynch_t                       synch_base;
00879 } rtdm_mutex_t;
00880 
00881 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__rtdmsync.html#ga12">rtdm_mutex_init</a>(rtdm_mutex_t *mutex)
00882 {
00883     mutex-&gt;locked = 0;
00884     <a class="code" href="group__synch.html#ga0">xnsynch_init</a>(&amp;mutex-&gt;synch_base, XNSYNCH_PRIO|XNSYNCH_PIP);
00885 }
00886 
00887 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__rtdmsync.html#ga13">rtdm_mutex_destroy</a>(rtdm_mutex_t *mutex)
00888 {
00889     _rtdm_synch_flush(&amp;mutex-&gt;synch_base, XNRMID);
00890 }
00891 
00892 <span class="keywordtype">int</span> <a class="code" href="group__rtdmsync.html#ga14">rtdm_mutex_lock</a>(rtdm_mutex_t *mutex);
00893 <span class="keywordtype">int</span> <a class="code" href="group__rtdmsync.html#ga15">rtdm_mutex_timedlock</a>(rtdm_mutex_t *mutex, __s64 timeout);
00894 <span class="keywordtype">void</span> <a class="code" href="group__rtdmsync.html#ga16">rtdm_mutex_unlock</a>(rtdm_mutex_t *mutex);
00895 
00896 
00897 <span class="comment">/* --- utility functions --- */</span>
00898 
00899 <span class="preprocessor">#define rtdm_printk(format, ...)    printk(format, ##__VA_ARGS__)</span>
00900 <span class="preprocessor"></span>
00901 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> *<a class="code" href="group__util.html#ga1">rtdm_malloc</a>(size_t size)
00902 {
00903     <span class="keywordflow">return</span> xnmalloc(size);
00904 }
00905 
00906 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__util.html#ga2">rtdm_free</a>(<span class="keywordtype">void</span> *ptr)
00907 {
00908     xnfree(ptr);
00909 }
00910 
00911 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__util.html#ga3">rtdm_read_user_ok</a>(rtdm_user_info_t *user_info,
00912                                     <span class="keyword">const</span> <span class="keywordtype">void</span> __user *ptr, size_t size)
00913 {
00914     <span class="keywordflow">return</span> __xn_access_ok(user_info, VERIFY_READ, ptr, size);
00915 }
00916 
00917 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__util.html#ga4">rtdm_rw_user_ok</a>(rtdm_user_info_t *user_info,
00918                                   <span class="keyword">const</span> <span class="keywordtype">void</span> __user *ptr, size_t size)
00919 {
00920     <span class="keywordflow">return</span> __xn_access_ok(user_info, VERIFY_WRITE, ptr, size);
00921 }
00922 
00923 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__util.html#ga5">rtdm_copy_from_user</a>(rtdm_user_info_t *user_info,
00924                                       <span class="keywordtype">void</span> *dst, <span class="keyword">const</span> <span class="keywordtype">void</span> __user *src,
00925                                       size_t size)
00926 {
00927     <span class="keywordflow">return</span> __xn_copy_from_user(user_info, dst, src, size);
00928 }
00929 
00930 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__util.html#ga6">rtdm_copy_to_user</a>(rtdm_user_info_t *user_info,
00931                                     <span class="keywordtype">void</span> __user *dst, <span class="keyword">const</span> <span class="keywordtype">void</span> *src,
00932                                     size_t size)
00933 {
00934     <span class="keywordflow">return</span> __xn_copy_to_user(user_info, dst, src, size);
00935 }
00936 
00937 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__util.html#ga7">rtdm_strncpy_from_user</a>(rtdm_user_info_t *user_info,
00938                                          <span class="keywordtype">char</span> *dst,
00939                                          <span class="keyword">const</span> <span class="keywordtype">char</span> __user *src,
00940                                          size_t count)
00941 {
00942     <span class="keywordflow">if</span> (unlikely(__xn_access_ok(user_info, VERIFY_READ, src, 1)))
00943         <span class="keywordflow">return</span> -EFAULT;
00944     <span class="keywordflow">return</span> __xn_strncpy_from_user(user_info, dst, src, count);
00945 }
00946 
00947 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__util.html#ga8">rtdm_in_rt_context</a>(<span class="keywordtype">void</span>)
00948 {
00949     <span class="keywordflow">return</span> (rthal_current_domain != rthal_root_domain);
00950 }
00951 
00952 <span class="keywordtype">int</span> rtdm_exec_in_rt(<span class="keyword">struct</span> <a class="code" href="structrtdm__dev__context.html">rtdm_dev_context</a> *context,
00953                     rtdm_user_info_t *user_info, <span class="keywordtype">void</span> *arg,
00954                     rtdm_rt_handler_t handler);
00955 
00956 <span class="preprocessor">#endif </span><span class="comment">/* _RTDM_DRIVER_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Aug 1 07:27:26 2005 for RTAI Fusion API by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
