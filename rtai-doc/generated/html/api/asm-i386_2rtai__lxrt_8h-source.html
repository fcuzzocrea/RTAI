<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI API: rtai-core/include/asm-i386/rtai_lxrt.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000000.html">rtai-core</a>&nbsp;/&nbsp;<a class="el" href="dir_000019.html">include</a>&nbsp;/&nbsp;<a class="el" href="dir_000025.html">asm-i386</a></div>
<h1>rtai_lxrt.h</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (C) 1999-2003 Paolo Mantegazza &lt;mantegazza@aero.polimi.it&gt;</span>
00003 <span class="comment"> * extensions for user space modules are jointly copyrighted (2000) with:</span>
00004 <span class="comment"> *              Pierre Cloutier &lt;pcloutier@poseidoncontrols.com&gt;,</span>
00005 <span class="comment"> *              Steve Papacharalambous &lt;stevep@zentropix.com&gt;.</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * This library is free software; you can redistribute it and/or</span>
00008 <span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
00009 <span class="comment"> * License as published by the Free Software Foundation; either</span>
00010 <span class="comment"> * version 2 of the License, or (at your option) any later version.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * This library is distributed in the hope that it will be useful,</span>
00013 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00014 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00015 <span class="comment"> * Lesser General Public License for more details.</span>
00016 <span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
00017 <span class="comment"> * License along with this library; if not, write to the Free Software</span>
00018 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA.</span>
00019 <span class="comment"> */</span>
00020 
00021 <span class="preprocessor">#ifndef _RTAI_ASM_I386_LXRT_H</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#define _RTAI_ASM_I386_LXRT_H</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#include &lt;linux/version.h&gt;</span>
00025 
00026 <span class="preprocessor">#include &lt;asm/rtai_vectors.h&gt;</span>
00027 
00028 <span class="preprocessor">#define LOW  0</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#define HIGH 1</span>
00030 <span class="preprocessor"></span>
00031 <span class="keyword">union </span>rtai_lxrt_t {
00032 
00033     RTIME rt;
00034     <span class="keywordtype">int</span> i[2];
00035     <span class="keywordtype">void</span> *v[2];
00036 };
00037 
00038 <span class="preprocessor">#ifdef __cplusplus</span>
00039 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00040 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00041 
00042 <span class="preprocessor">#ifdef __KERNEL__</span>
00043 <span class="preprocessor"></span>
00044 <span class="preprocessor">#include &lt;asm/segment.h&gt;</span>
00045 <span class="preprocessor">#include &lt;asm/mmu_context.h&gt;</span>
00046 
00047 <span class="preprocessor">#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,6,0)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#define __LXRT_GET_DATASEG(reg) "movl $" STR(__KERNEL_DS) ",%" #reg "\n\t"</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* KERNEL_VERSION &gt;= 2.6.0 */</span>
00050 <span class="preprocessor">#define __LXRT_GET_DATASEG(reg) "movl $" STR(__USER_DS) ",%" #reg "\n\t"</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#endif  </span><span class="comment">/* KERNEL_VERSION &lt; 2.6.0 */</span>
00052 
00053 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> _lxrt_context_switch (<span class="keyword">struct</span> task_struct *prev,
00054                                         <span class="keyword">struct</span> task_struct *next,
00055                                         <span class="keywordtype">int</span> cpuid)
00056 {
00057     <span class="keyword">struct </span>mm_struct *oldmm = prev-&gt;active_mm;
00058 
00059 <span class="preprocessor">#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,6,0)</span>
00060 <span class="preprocessor"></span>    switch_mm(oldmm,next-&gt;active_mm,next,cpuid);
00061 
00062     <span class="keywordflow">if</span> (!next-&gt;mm)
00063         enter_lazy_tlb(oldmm,next,cpuid);
00064 #else <span class="comment">/* &gt;= 2.6.0 */</span>
00065     switch_mm(oldmm,next-&gt;active_mm,next);
00066 
00067     if (!next-&gt;mm)
00068         enter_lazy_tlb(oldmm,next);
00069 #endif <span class="comment">/* &lt; 2.6.0 */</span>
00070 
00071 <span class="comment">/* NOTE: Do not use switch_to() directly: this is a compiler</span>
00072 <span class="comment">   compatibility issue. */</span>
00073 
00074     __asm__ __volatile__(                                               \
00075                  "pushfl\n\t"                                           \
00076                  "cli\n\t"                                              \
00077                  "pushl %%esi\n\t"                                      \
00078                  "pushl %%edi\n\t"                                      \
00079                  "pushl %%ebp\n\t"                                      \
00080                  "movl %%esp,%0\n\t"    <span class="comment">/* save ESP */</span>          \
00081                  "movl %3,%%esp\n\t"    <span class="comment">/* restore ESP */</span>               \
00082                  "movl $1f,%1\n\t"      <span class="comment">/* save EIP */</span>          \
00083                  "pushl %4\n\t"         <span class="comment">/* restore EIP */</span>               \
00084                  "jmp "SYMBOL_NAME_STR(__switch_to)"\n"                 \
00085                  "1:\t"                                                 \
00086                  "popl %%ebp\n\t"                                       \
00087                  "popl %%edi\n\t"                                       \
00088                  "popl %%esi\n\t"                                       \
00089                  "popfl\n\t"                                            \
00090                  :"=m" (prev-&gt;thread.esp),"=m" (prev-&gt;thread.eip),      \
00091                   "=b" (prev)                                           \
00092                  :"m" (next-&gt;thread.esp),"m" (next-&gt;thread.eip),        \
00093                   "a" (prev), "d" (next),                               \
00094                   "b" (prev));                                          
00095 
00096     barrier();
00097 }
00098 
00099 #else <span class="comment">/* !__KERNEL__ */</span>
00100 
00101 <span class="comment">/* NOTE: Keep the following routines unfold: this is a compiler</span>
00102 <span class="comment">   compatibility issue. */</span>
00103 
00104 static union rtai_lxrt_t _rtai_lxrt(<span class="keywordtype">int</span> srq, <span class="keywordtype">void</span> *arg)
00105 {
00106         <span class="keyword">union </span>rtai_lxrt_t retval;
00107         RTAI_DO_TRAP(RTAI_SYS_VECTOR, retval, srq, arg);
00108         <span class="keywordflow">return</span> retval;
00109 }
00110 
00111 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">union </span>rtai_lxrt_t rtai_lxrt(short int dynx, short int lsize, int srq, void *arg)
00112 {
00113         <span class="keywordflow">return</span> _rtai_lxrt(ENCODE_LXRT_REQ(dynx, srq, lsize), arg);
00114 }
00115 
00116 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL__ */</span>
00117 
00118 <span class="preprocessor">#ifdef __cplusplus</span>
00119 <span class="preprocessor"></span>}
00120 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00121 
00122 <span class="preprocessor">#endif </span><span class="comment">/* !_RTAI_ASM_I386_LXRT_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun May 29 15:43:51 2005 for RTAI API by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
