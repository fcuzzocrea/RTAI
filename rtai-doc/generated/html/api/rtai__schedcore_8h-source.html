<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI API: rtai-core/include/rtai_schedcore.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>rtai-core/include/rtai_schedcore.h</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (C) 1999-2003 Paolo Mantegazza &lt;mantegazza@aero.polimi.it&gt;</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
00005 <span class="comment"> * modify it under the terms of the GNU General Public License as</span>
00006 <span class="comment"> * published by the Free Software Foundation; either version 2 of the</span>
00007 <span class="comment"> * License, or (at your option) any later version.</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment"> * GNU General Public License for more details.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00015 <span class="comment"> * along with this program; if not, write to the Free Software</span>
00016 <span class="comment"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
00017 <span class="comment"> */</span>
00018 
00019 <span class="preprocessor">#ifndef _RTAI_SCHEDCORE_H</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#define _RTAI_SCHEDCORE_H</span>
00021 <span class="preprocessor"></span>
00022 <span class="preprocessor">#include &lt;rtai_version.h&gt;</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="rtai__lxrt_8h.html">rtai_lxrt.h</a>&gt;</span>
00024 <span class="preprocessor">#include &lt;rtai_sched.h&gt;</span>
00025 <span class="preprocessor">#include &lt;rtai_malloc.h&gt;</span>
00026 <span class="preprocessor">#include &lt;rtai_trace.h&gt;</span>
00027 <span class="preprocessor">#include &lt;rtai_leds.h&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="rtai__sem_8h.html">rtai_sem.h</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;rtai_rwl.h&gt;</span>
00030 <span class="preprocessor">#include &lt;rtai_spl.h&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="rtai__scb_8h.html">rtai_scb.h</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="rtai__mbx_8h.html">rtai_mbx.h</a>&gt;</span>
00033 <span class="preprocessor">#include &lt;rtai_msg.h&gt;</span>
00034 <span class="preprocessor">#include &lt;rtai_tbx.h&gt;</span>
00035 <span class="preprocessor">#include &lt;rtai_mq.h&gt;</span>
00036 <span class="preprocessor">#include &lt;rtai_bits.h&gt;</span>
00037 <span class="preprocessor">#include &lt;rtai_wd.h&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="rtai__tasklets_8h.html">rtai_tasklets.h</a>&gt;</span>
00039 <span class="preprocessor">#include &lt;<a class="code" href="rtai__fifos_8h.html">rtai_fifos.h</a>&gt;</span>
00040 <span class="preprocessor">#include &lt;rtai_netrpc.h&gt;</span>
00041 <span class="preprocessor">#include &lt;<a class="code" href="rtai__shm_8h.html">rtai_shm.h</a>&gt;</span>
00042 <span class="preprocessor">#include &lt;rtai_usi.h&gt;</span>
00043 
00044 <span class="preprocessor">#ifdef __KERNEL__</span>
00045 <span class="preprocessor"></span>
00046 <span class="preprocessor">#include &lt;linux/module.h&gt;</span>
00047 <span class="preprocessor">#include &lt;linux/init.h&gt;</span>
00048 <span class="preprocessor">#include &lt;linux/kernel.h&gt;</span>
00049 <span class="preprocessor">#include &lt;linux/version.h&gt;</span>
00050 <span class="preprocessor">#include &lt;linux/errno.h&gt;</span>
00051 <span class="preprocessor">#include &lt;linux/slab.h&gt;</span>
00052 <span class="preprocessor">#include &lt;linux/timex.h&gt;</span>
00053 <span class="preprocessor">#include &lt;linux/sched.h&gt;</span>
00054 <span class="preprocessor">#include &lt;asm/param.h&gt;</span>
00055 <span class="preprocessor">#include &lt;asm/system.h&gt;</span>
00056 <span class="preprocessor">#include &lt;asm/io.h&gt;</span>
00057 
00058 <span class="keyword">extern</span> RT_TASK rt_smp_linux_task[];
00059 
00060 <span class="keyword">extern</span> RT_TASK *rt_smp_current[];
00061 
00062 <span class="keyword">extern</span> RTIME rt_smp_time_h[];
00063 
00064 <span class="keyword">extern</span> <span class="keywordtype">int</span> rt_smp_oneshot_timer[];
00065 
00066 <span class="preprocessor">#ifdef CONFIG_RTAI_MALLOC</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#define sched_malloc(size)              rt_malloc((size))</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#define sched_free(adr)                 rt_free((adr))</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#ifndef CONFIG_RTAI_MALLOC_BUILTIN</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#define sched_mem_init()</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#define sched_mem_end()</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#else  </span><span class="comment">/* CONFIG_RTAI_MALLOC_BUILTIN */</span>
00073 <span class="preprocessor">#define sched_mem_init() \</span>
00074 <span class="preprocessor">        { if(__rtai_heap_init() != 0) { \</span>
00075 <span class="preprocessor">                return(-ENOMEM); \</span>
00076 <span class="preprocessor">        } }</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#define sched_mem_end()         __rtai_heap_exit()</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* !CONFIG_RTAI_MALLOC_BUILTIN */</span>
00079 <span class="preprocessor">#define call_exit_handlers(task)                __call_exit_handlers(task)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#define set_exit_handler(task, fun, arg1, arg2) __set_exit_handler(task, fun, arg1, arg2)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#else  </span><span class="comment">/* !CONFIG_RTAI_MALLOC */</span>
00082 <span class="preprocessor">#define sched_malloc(size)      kmalloc((size), GFP_KERNEL)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#define sched_free(adr)         kfree((adr))</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#define sched_mem_init()</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#define sched_mem_end()</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#define call_exit_handlers(task)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#define set_exit_handler(task, fun, arg1, arg2)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_MALLOC */</span>
00089 
00090 <span class="preprocessor">#define RT_SEM_MAGIC 0xaabcdeff</span>
00091 <span class="preprocessor"></span>
00092 <span class="preprocessor">#define SEM_ERR (0xFfff)</span>
00093 <span class="preprocessor"></span>
00094 <span class="preprocessor">#define MSG_ERR ((RT_TASK *)0xFfff)</span>
00095 <span class="preprocessor"></span>
00096 <span class="preprocessor">#define NOTHING ((void *)0)</span>
00097 <span class="preprocessor"></span>
00098 <span class="preprocessor">#define SOMETHING ((void *)1)</span>
00099 <span class="preprocessor"></span>
00100 <span class="preprocessor">#define SEMHLF 0x0000FFFF</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#define RPCHLF 0xFFFF0000</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#define RPCINC 0x00010000</span>
00103 <span class="preprocessor"></span>
00104 <span class="preprocessor">#define DECLARE_RT_CURRENT int cpuid; RT_TASK *rt_current</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#define ASSIGN_RT_CURRENT rt_current = rt_smp_current[cpuid = hard_cpu_id()]</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#define RT_CURRENT rt_smp_current[hard_cpu_id()]</span>
00107 <span class="preprocessor"></span>
00108 <span class="preprocessor">#define MAX_LINUX_RTPRIO  99</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#define MIN_LINUX_RTPRIO   1</span>
00110 <span class="preprocessor"></span>
00111 <span class="preprocessor">#ifdef CONFIG_RTAI_SCHED_ISR_LOCK</span>
00112 <span class="preprocessor"></span><span class="keywordtype">void</span> rtai_handle_isched_lock(<span class="keywordtype">int</span> nesting);
00113 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_SCHED_ISR_LOCK */</span>
00114 
00115 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00116 <span class="preprocessor"></span><span class="preprocessor">#define rt_time_h (rt_smp_time_h[cpuid &amp; sqilter])</span>
00117 <span class="preprocessor"></span><span class="preprocessor">#define oneshot_timer (rt_smp_oneshot_timer[cpuid &amp; sqilter])</span>
00118 <span class="preprocessor"></span><span class="preprocessor">#define rt_linux_task (rt_smp_linux_task[cpuid])</span>
00119 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00120 <span class="preprocessor"></span><span class="preprocessor">#define rt_time_h (rt_smp_time_h[0])</span>
00121 <span class="preprocessor"></span><span class="preprocessor">#define oneshot_timer (rt_smp_oneshot_timer[0])</span>
00122 <span class="preprocessor"></span><span class="preprocessor">#define rt_linux_task (rt_smp_linux_task[0])</span>
00123 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00124 <span class="preprocessor"></span>
00125 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00126 <span class="preprocessor"></span>
00127 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sqilter;
00128 
00129 <span class="preprocessor">#define SCHED_IPI     RTAI_APIC1_IPI</span>
00130 <span class="preprocessor"></span><span class="preprocessor">#define SCHED_VECTOR  RTAI_APIC1_VECTOR</span>
00131 <span class="preprocessor"></span>
00132 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> send_sched_ipi(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> dest)
00133 {
00134         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00135         rtai_hw_lock(flags);
00136         apic_wait_icr_idle();
00137         apic_write_around(APIC_ICR2, SET_APIC_DEST_FIELD(dest));
00138         apic_write_around(APIC_ICR, APIC_DEST_LOGICAL | SCHED_VECTOR);
00139         rtai_hw_unlock(flags);
00140 }
00141 
00142 <span class="preprocessor">#define RT_SCHEDULE_MAP(schedmap) \</span>
00143 <span class="preprocessor">do { \</span>
00144 <span class="preprocessor">        if (sqilter) { \</span>
00145 <span class="preprocessor">                if (schedmap) send_sched_ipi(schedmap); \</span>
00146 <span class="preprocessor">        } else { \</span>
00147 <span class="preprocessor">                rt_schedule(); \</span>
00148 <span class="preprocessor">        } \</span>
00149 <span class="preprocessor">} while (0)</span>
00150 <span class="preprocessor"></span>
00151 <span class="preprocessor">#define RT_SCHEDULE_MAP_BOTH(schedmap) \</span>
00152 <span class="preprocessor">do { \</span>
00153 <span class="preprocessor">        if (sqilter &amp;&amp; schedmap) send_sched_ipi(schedmap); \</span>
00154 <span class="preprocessor">        rt_schedule(); \</span>
00155 <span class="preprocessor">} while (0)</span>
00156 <span class="preprocessor"></span>
00157 <span class="preprocessor">#define RT_SCHEDULE(task, cpuid) \</span>
00158 <span class="preprocessor">        do { \</span>
00159 <span class="preprocessor">                if (((task)-&gt;runnable_on_cpus != (cpuid)) &amp;&amp; sqilter) { \</span>
00160 <span class="preprocessor">                        send_sched_ipi(1 &lt;&lt; (task)-&gt;runnable_on_cpus); \</span>
00161 <span class="preprocessor">                } else { \</span>
00162 <span class="preprocessor">                        rt_schedule(); \</span>
00163 <span class="preprocessor">                } \</span>
00164 <span class="preprocessor">        } while (0)</span>
00165 <span class="preprocessor"></span>
00166 <span class="preprocessor">#define RT_SCHEDULE_BOTH(task, cpuid) \</span>
00167 <span class="preprocessor">        { \</span>
00168 <span class="preprocessor">                if (((task)-&gt;runnable_on_cpus != (cpuid)) &amp;&amp; sqilter) { \</span>
00169 <span class="preprocessor">                        send_sched_ipi(1 &lt;&lt; (task)-&gt;runnable_on_cpus); \</span>
00170 <span class="preprocessor">                } \</span>
00171 <span class="preprocessor">                rt_schedule(); \</span>
00172 <span class="preprocessor">        }</span>
00173 <span class="preprocessor"></span>
00174 <span class="preprocessor">#else </span><span class="comment">/* !CONFIG_SMP */</span>
00175 
00176 <span class="preprocessor">#define send_sched_ipi(dest)</span>
00177 <span class="preprocessor"></span>
00178 <span class="preprocessor">#define RT_SCHEDULE_MAP_BOTH(schedmap)  rt_schedule()</span>
00179 <span class="preprocessor"></span>
00180 <span class="preprocessor">#define RT_SCHEDULE_MAP(schedmap)       rt_schedule()</span>
00181 <span class="preprocessor"></span>
00182 <span class="preprocessor">#define RT_SCHEDULE(task, cpuid)        rt_schedule()</span>
00183 <span class="preprocessor"></span>
00184 <span class="preprocessor">#define RT_SCHEDULE_BOTH(task, cpuid)   rt_schedule()</span>
00185 <span class="preprocessor"></span>
00186 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_SMP */</span>
00187 
00188 <span class="preprocessor">#define BASE_SOFT_PRIORITY 1000000000</span>
00189 <span class="preprocessor"></span>
00190 <span class="preprocessor">#define TASK_HARDREALTIME  TASK_UNINTERRUPTIBLE</span>
00191 <span class="preprocessor"></span>
00192 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> enq_ready_edf_task(RT_TASK *ready_task)
00193 {
00194         RT_TASK *task;
00195 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00196 <span class="preprocessor"></span>        task = rt_smp_linux_task[ready_task-&gt;runnable_on_cpus &amp; sqilter].rnext;
00197 <span class="preprocessor">#else</span>
00198 <span class="preprocessor"></span>        task = rt_smp_linux_task[0].rnext;
00199 <span class="preprocessor">#endif</span>
00200 <span class="preprocessor"></span>        <span class="keywordflow">while</span> (task-&gt;policy &lt; 0 &amp;&amp; ready_task-&gt;period &gt;= task-&gt;period) {
00201                 task = task-&gt;rnext;
00202         }
00203         task-&gt;rprev = (ready_task-&gt;rprev = task-&gt;rprev)-&gt;rnext = ready_task;
00204         ready_task-&gt;rnext = task;
00205 }
00206 
00207 <span class="preprocessor">#define MAX_WAKEUP_SRQ (2 &lt;&lt; 6)</span>
00208 <span class="preprocessor"></span>
00209 <span class="keyword">struct </span>klist_t { <span class="keyword">volatile</span> <span class="keywordtype">int</span> srq, in, out; <span class="keywordtype">void</span> *task[MAX_WAKEUP_SRQ]; };
00210 <span class="keyword">extern</span> <span class="keyword">struct </span>klist_t wake_up_srq;
00211 
00212 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> enq_ready_task(RT_TASK *ready_task)
00213 {
00214         RT_TASK *task;
00215         <span class="keywordflow">if</span> (ready_task-&gt;is_hard) {
00216 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00217 <span class="preprocessor"></span>                task = rt_smp_linux_task[ready_task-&gt;runnable_on_cpus &amp; sqilter].rnext;
00218 <span class="preprocessor">#else</span>
00219 <span class="preprocessor"></span>                task = rt_smp_linux_task[0].rnext;
00220 <span class="preprocessor">#endif</span>
00221 <span class="preprocessor"></span>                <span class="keywordflow">while</span> (ready_task-&gt;priority &gt;= task-&gt;priority) {
00222                         <span class="keywordflow">if</span> ((task = task-&gt;rnext)-&gt;priority &lt; 0) <span class="keywordflow">break</span>;
00223                 }
00224                 task-&gt;rprev = (ready_task-&gt;rprev = task-&gt;rprev)-&gt;rnext = ready_task;
00225                 ready_task-&gt;rnext = task;
00226         } <span class="keywordflow">else</span> {
00227                 ready_task-&gt;state = 0;
00228                 wake_up_srq.task[wake_up_srq.in] = ready_task-&gt;lnxtsk;
00229                 wake_up_srq.in = (wake_up_srq.in + 1) &amp; (MAX_WAKEUP_SRQ - 1);
00230                 rt_pend_linux_srq(wake_up_srq.srq);
00231         }
00232 }
00233 
00234 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> renq_ready_task(RT_TASK *ready_task, <span class="keywordtype">int</span> priority)
00235 {
00236         <span class="keywordtype">int</span> retval;
00237         <span class="keywordflow">if</span> ((retval = ready_task-&gt;priority != priority)) {
00238                 ready_task-&gt;priority = priority;
00239                 <span class="keywordflow">if</span> (ready_task-&gt;state == RT_SCHED_READY) {
00240                         (ready_task-&gt;rprev)-&gt;rnext = ready_task-&gt;rnext;
00241                         (ready_task-&gt;rnext)-&gt;rprev = ready_task-&gt;rprev;
00242                         enq_ready_task(ready_task);
00243                 }
00244         }
00245         <span class="keywordflow">return</span> retval;
00246 }
00247 
00248 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> renq_current(RT_TASK *rt_current, <span class="keywordtype">int</span> priority)
00249 {
00250         <span class="keywordtype">int</span> retval;
00251         <span class="keywordflow">if</span> ((retval = rt_current-&gt;priority != priority)) {
00252                 rt_current-&gt;priority = priority;
00253                 (rt_current-&gt;rprev)-&gt;rnext = rt_current-&gt;rnext;
00254                 (rt_current-&gt;rnext)-&gt;rprev = rt_current-&gt;rprev;
00255                 enq_ready_task(rt_current);
00256         }
00257         <span class="keywordflow">return</span> retval;
00258 }
00259 
00260 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rem_ready_task(RT_TASK *task)
00261 {
00262         <span class="keywordflow">if</span> (task-&gt;state == RT_SCHED_READY) {
00263                 <span class="keywordflow">if</span> (!task-&gt;is_hard) {
00264                         (task-&gt;lnxtsk)-&gt;state = TASK_HARDREALTIME;
00265                 }
00266                 (task-&gt;rprev)-&gt;rnext = task-&gt;rnext;
00267                 (task-&gt;rnext)-&gt;rprev = task-&gt;rprev;
00268         }
00269 }
00270 
00271 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rem_ready_current(RT_TASK *rt_current)
00272 {
00273         <span class="keywordflow">if</span> (!rt_current-&gt;is_hard) {
00274                 (rt_current-&gt;lnxtsk)-&gt;state = TASK_HARDREALTIME;
00275         }
00276         (rt_current-&gt;rprev)-&gt;rnext = rt_current-&gt;rnext;
00277         (rt_current-&gt;rnext)-&gt;rprev = rt_current-&gt;rprev;
00278 }
00279 
00280 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> enq_timed_task(RT_TASK *timed_task)
00281 {
00282         RT_TASK *task;
00283 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00284 <span class="preprocessor"></span>        task = rt_smp_linux_task[timed_task-&gt;runnable_on_cpus &amp; sqilter].tnext;
00285 <span class="preprocessor">#else</span>
00286 <span class="preprocessor"></span>        task = rt_smp_linux_task[0].tnext;
00287 <span class="preprocessor">#endif</span>
00288 <span class="preprocessor"></span>        <span class="keywordflow">while</span> (timed_task-&gt;resume_time &gt; task-&gt;resume_time) {
00289                 task = task-&gt;tnext;
00290         }
00291         task-&gt;tprev = (timed_task-&gt;tprev = task-&gt;tprev)-&gt;tnext = timed_task;
00292         timed_task-&gt;tnext = task;
00293 }
00294 
00295 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> wake_up_timed_tasks(<span class="keywordtype">int</span> cpuid)
00296 {
00297         RT_TASK *task;
00298 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00299 <span class="preprocessor"></span>        task = rt_smp_linux_task[cpuid = cpuid &amp; sqilter].tnext;
00300 <span class="preprocessor">#else</span>
00301 <span class="preprocessor"></span>        task = rt_smp_linux_task[0].tnext;
00302 <span class="preprocessor">#endif</span>
00303 <span class="preprocessor"></span>        <span class="keywordflow">while</span> (task-&gt;resume_time &lt;= rt_time_h) {
00304                 <span class="keywordflow">if</span> ((task-&gt;state &amp;= ~(RT_SCHED_DELAYED | RT_SCHED_SEMAPHORE | RT_SCHED_RECEIVE | RT_SCHED_SEND | RT_SCHED_RPC | RT_SCHED_RETURN | RT_SCHED_MBXSUSP)) == RT_SCHED_READY) {
00305                         <span class="keywordflow">if</span> (task-&gt;policy &lt; 0) {
00306                                 enq_ready_edf_task(task);
00307                         } <span class="keywordflow">else</span> {
00308                                 enq_ready_task(task);
00309                         }
00310                 }
00311                 task = task-&gt;tnext;
00312         }
00313 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00314 <span class="preprocessor"></span>        rt_smp_linux_task[cpuid].tnext = task;
00315         task-&gt;tprev = &amp;rt_smp_linux_task[cpuid];
00316 <span class="preprocessor">#else</span>
00317 <span class="preprocessor"></span>        rt_smp_linux_task[0].tnext = task;
00318         task-&gt;tprev = &amp;rt_smp_linux_task[0];
00319 <span class="preprocessor">#endif</span>
00320 <span class="preprocessor"></span>}
00321 
00322 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rem_timed_task(RT_TASK *task)
00323 {
00324         <span class="keywordflow">if</span> ((task-&gt;state &amp; RT_SCHED_DELAYED)) {
00325                 (task-&gt;tprev)-&gt;tnext = task-&gt;tnext;
00326                 (task-&gt;tnext)-&gt;tprev = task-&gt;tprev;
00327         }
00328 }
00329 
00330 <span class="preprocessor">#define get_time() rt_get_time()</span>
00331 <span class="preprocessor"></span><span class="preprocessor">#if 0</span>
00332 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> RTIME get_time(<span class="keywordtype">void</span>)
00333 {
00334 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00335 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sqilter) {
00336                 <span class="keywordtype">int</span> cpuid;
00337                 <span class="keywordflow">return</span> rt_smp_oneshot_timer[cpuid = hard_cpu_id()] ? rdtsc() : rt_smp_times[cpuid].tick_time;
00338         } <span class="keywordflow">else</span> {
00339                 <span class="keywordflow">return</span> rt_smp_oneshot_timer[0] ? rdtsc(): rt_times.tick_time;
00340         }
00341 <span class="preprocessor">#else</span>
00342 <span class="preprocessor"></span>        <span class="keywordflow">return</span> oneshot_timer ? rdtsc(): rt_times.tick_time;
00343 <span class="preprocessor">#endif</span>
00344 <span class="preprocessor"></span>}
00345 <span class="preprocessor">#endif</span>
00346 <span class="preprocessor"></span>
00347 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> enqueue_blocked(RT_TASK *task, QUEUE *queue, <span class="keywordtype">int</span> qtype)
00348 {
00349         QUEUE *q;
00350         task-&gt;blocked_on = (q = queue);
00351         <span class="keywordflow">if</span> (!qtype) {
00352                 <span class="keywordflow">while</span> ((q = q-&gt;next) != queue &amp;&amp; (q-&gt;task)-&gt;priority &lt;= task-&gt;priority);
00353         }
00354         q-&gt;prev = (task-&gt;queue.prev = q-&gt;prev)-&gt;next  = &amp;(task-&gt;queue);
00355         task-&gt;queue.next = q;
00356 }
00357 
00358 
00359 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> dequeue_blocked(RT_TASK *task)
00360 {
00361         task-&gt;prio_passed_to     = NOTHING;
00362         (task-&gt;queue.prev)-&gt;next = task-&gt;queue.next;
00363         (task-&gt;queue.next)-&gt;prev = task-&gt;queue.prev;
00364         task-&gt;blocked_on         = NOTHING;
00365 }
00366 
00367 <span class="keyword">static</span> __volatile__ <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pass_prio(RT_TASK *to, RT_TASK *from)
00368 {
00369         QUEUE *q;
00370 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00371 <span class="preprocessor"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> schedmap;
00372         schedmap = 0;
00373 <span class="preprocessor">#endif</span>
00374 <span class="preprocessor"></span>        from-&gt;prio_passed_to = to;
00375         <span class="keywordflow">while</span> (to &amp;&amp; to-&gt;priority &gt; from-&gt;priority) {
00376                 to-&gt;priority = from-&gt;priority;
00377                 <span class="keywordflow">if</span> (to-&gt;state == RT_SCHED_READY) {
00378                         (to-&gt;rprev)-&gt;rnext = to-&gt;rnext;
00379                         (to-&gt;rnext)-&gt;rprev = to-&gt;rprev;
00380                         enq_ready_task(to);
00381 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00382 <span class="preprocessor"></span>                        set_bit(to-&gt;runnable_on_cpus &amp; 0x1F, &amp;schedmap);
00383 <span class="preprocessor">#endif</span>
00384 <span class="preprocessor"></span>                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((q = to-&gt;blocked_on) &amp;&amp; !((to-&gt;state &amp; RT_SCHED_SEMAPHORE) &amp;&amp;
00385  ((SEM *)q)-&gt;qtype)) {
00386                         (to-&gt;queue.prev)-&gt;next = to-&gt;queue.next;
00387                         (to-&gt;queue.next)-&gt;prev = to-&gt;queue.prev;
00388                         <span class="keywordflow">while</span> ((q = q-&gt;next) != to-&gt;blocked_on &amp;&amp; (q-&gt;task)-&gt;priority &lt;= to-&gt;priority);
00389                         q-&gt;prev = (to-&gt;queue.prev = q-&gt;prev)-&gt;next  = &amp;(to-&gt;queue);
00390                         to-&gt;queue.next = q;
00391                 }
00392                 to = to-&gt;prio_passed_to;
00393         }
00394 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00395 <span class="preprocessor"></span>        <span class="keywordflow">return</span> schedmap;
00396 <span class="preprocessor">#else</span>
00397 <span class="preprocessor"></span>        <span class="keywordflow">return</span> 0;
00398 <span class="preprocessor">#endif</span>
00399 <span class="preprocessor"></span>}
00400 
00401 <span class="keyword">static</span> <span class="keyword">inline</span> RT_TASK *_rt_whoami(<span class="keywordtype">void</span>)
00402 {
00403 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00404 <span class="preprocessor"></span>        RT_TASK *rt_current;
00405         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00406         flags = rt_global_save_flags_and_cli();
00407         rt_current = RT_CURRENT;
00408         rt_global_restore_flags(flags);
00409         <span class="keywordflow">return</span> rt_current;
00410 <span class="preprocessor">#else</span>
00411 <span class="preprocessor"></span>        <span class="keywordflow">return</span> rt_smp_current[0];
00412 <span class="preprocessor">#endif</span>
00413 <span class="preprocessor"></span>}
00414 
00415 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __call_exit_handlers(RT_TASK *task)
00416 {
00417         XHDL *pt, *tmp;
00418 
00419         pt = task-&gt;ExitHook; <span class="comment">// Initialise ExitHook in rt_task_init()</span>
00420         <span class="keywordflow">while</span> ( pt ) {
00421                 (*pt-&gt;fun) (pt-&gt;arg1, pt-&gt;arg2);
00422                 tmp = pt;
00423                 pt  = pt-&gt;nxt;
00424                 rt_free(tmp);
00425         }
00426         task-&gt;ExitHook = 0;
00427 }
00428 
00429 <span class="keyword">static</span> <span class="keyword">inline</span> XHDL *__set_exit_handler(RT_TASK *task, <span class="keywordtype">void</span> (*fun) (<span class="keywordtype">void</span> *, <span class="keywordtype">int</span>), <span class="keywordtype">void</span> *arg1, <span class="keywordtype">int</span> arg2)
00430 {
00431         XHDL *p;
00432 
00433         <span class="comment">// exit handler functions are automatically executed at terminattion time by rt_task_delete()</span>
00434         <span class="comment">// in the reverse order they were created (like C++ destructors behave).</span>
00435         <span class="keywordflow">if</span> (task-&gt;magic != RT_TASK_MAGIC) <span class="keywordflow">return</span> 0;
00436         <span class="keywordflow">if</span> (!(p = (XHDL *) rt_malloc (<span class="keyword">sizeof</span>(XHDL)))) <span class="keywordflow">return</span> 0;
00437         p-&gt;fun  = fun;
00438         p-&gt;arg1 = arg1;
00439         p-&gt;arg2 = arg2;
00440         p-&gt;nxt  = task-&gt;ExitHook;
00441         <span class="keywordflow">return</span> (task-&gt;ExitHook = p);
00442 }
00443 
00444 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> rtai_init_features (<span class="keywordtype">void</span>)
00445 
00446 {
00447 <span class="preprocessor">#ifdef CONFIG_RTAI_LEDS_BUILTIN</span>
00448 <span class="preprocessor"></span>    __rtai_leds_init();
00449 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_LEDS_BUILTIN */</span>
00450 <span class="preprocessor">#ifdef CONFIG_RTAI_SEM_BUILTIN</span>
00451 <span class="preprocessor"></span>    __rtai_sem_init();
00452 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_SEM_BUILTIN */</span>
00453 <span class="preprocessor">#ifdef CONFIG_RTAI_MSG_BUILTIN</span>
00454 <span class="preprocessor"></span>    __rtai_msg_init();
00455 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_MSG_BUILTIN */</span>
00456 <span class="preprocessor">#ifdef CONFIG_RTAI_MBX_BUILTIN</span>
00457 <span class="preprocessor"></span>    __rtai_mbx_init();
00458 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_MBX_BUILTIN */</span>
00459 <span class="preprocessor">#ifdef CONFIG_RTAI_TBX_BUILTIN</span>
00460 <span class="preprocessor"></span>    __rtai_tbx_init();
00461 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_TBX_BUILTIN */</span>
00462 <span class="preprocessor">#ifdef CONFIG_RTAI_MQ_BUILTIN</span>
00463 <span class="preprocessor"></span>    __rtai_mq_init();
00464 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_MQ_BUILTIN */</span>
00465 <span class="preprocessor">#ifdef CONFIG_RTAI_BITS_BUILTIN</span>
00466 <span class="preprocessor"></span>    __rtai_bits_init();
00467 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_BITS_BUILTIN */</span>
00468 <span class="preprocessor">#ifdef CONFIG_RTAI_TASKLETS_BUILTIN</span>
00469 <span class="preprocessor"></span>    __rtai_tasklets_init();
00470 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_TASKLETS_BUILTIN */</span>
00471 <span class="preprocessor">#ifdef CONFIG_RTAI_FIFOS_BUILTIN</span>
00472 <span class="preprocessor"></span>    __rtai_fifos_init();
00473 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_FIFOS_BUILTIN */</span>
00474 <span class="preprocessor">#ifdef CONFIG_RTAI_NETRPC_BUILTIN</span>
00475 <span class="preprocessor"></span>    __rtai_netrpc_init();
00476 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_NETRPC_BUILTIN */</span>
00477 <span class="preprocessor">#ifdef CONFIG_RTAI_SHM_BUILTIN</span>
00478 <span class="preprocessor"></span>    __rtai_shm_init();
00479 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_SHM_BUILTIN */</span>
00480 <span class="preprocessor">#ifdef CONFIG_RTAI_USI_BUILTIN</span>
00481 <span class="preprocessor"></span>    __rtai_usi_init();
00482 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_USI_BUILTIN */</span>
00483 <span class="preprocessor">#ifdef CONFIG_RTAI_MATH_BUILTIN</span>
00484 <span class="preprocessor"></span>    __rtai_math_init();
00485 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_MATH_BUILTIN */</span>
00486 
00487         <span class="keywordflow">return</span> 0;
00488 }
00489 
00490 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rtai_cleanup_features (<span class="keywordtype">void</span>) {
00491 
00492 <span class="preprocessor">#ifdef CONFIG_RTAI_MATH_BUILTIN</span>
00493 <span class="preprocessor"></span>    __rtai_math_exit();
00494 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_MATH_BUILTIN */</span>
00495 <span class="preprocessor">#ifdef CONFIG_RTAI_USI_BUILTIN</span>
00496 <span class="preprocessor"></span>    __rtai_usi_exit();
00497 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_USI_BUILTIN */</span>
00498 <span class="preprocessor">#ifdef CONFIG_RTAI_SHM_BUILTIN</span>
00499 <span class="preprocessor"></span>    __rtai_shm_exit();
00500 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_SHM_BUILTIN */</span>
00501 <span class="preprocessor">#ifdef CONFIG_RTAI_NETRPC_BUILTIN</span>
00502 <span class="preprocessor"></span>    __rtai_netrpc_exit();
00503 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_NETRPC_BUILTIN */</span>
00504 <span class="preprocessor">#ifdef CONFIG_RTAI_FIFOS_BUILTIN</span>
00505 <span class="preprocessor"></span>    __rtai_fifos_exit();
00506 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_FIFOS_BUILTIN */</span>
00507 <span class="preprocessor">#ifdef CONFIG_RTAI_TASKLETS_BUILTIN</span>
00508 <span class="preprocessor"></span>    __rtai_tasklets_exit();
00509 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_TASKLETS_BUILTIN */</span>
00510 <span class="preprocessor">#ifdef CONFIG_RTAI_BITS_BUILTIN</span>
00511 <span class="preprocessor"></span>    __rtai_bits_exit();
00512 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_BITS_BUILTIN */</span>
00513 <span class="preprocessor">#ifdef CONFIG_RTAI_MQ_BUILTIN</span>
00514 <span class="preprocessor"></span>    __rtai_mq_exit();
00515 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_MQ_BUILTIN */</span>
00516 <span class="preprocessor">#ifdef CONFIG_RTAI_TBX_BUILTIN</span>
00517 <span class="preprocessor"></span>    __rtai_tbx_exit();
00518 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_TBX_BUILTIN */</span>
00519 <span class="preprocessor">#ifdef CONFIG_RTAI_MBX_BUILTIN</span>
00520 <span class="preprocessor"></span>    __rtai_mbx_exit();
00521 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_MBX_BUILTIN */</span>
00522 <span class="preprocessor">#ifdef CONFIG_RTAI_MSG_BUILTIN</span>
00523 <span class="preprocessor"></span>    __rtai_msg_exit();
00524 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_MSG_BUILTIN */</span>
00525 <span class="preprocessor">#ifdef CONFIG_RTAI_SEM_BUILTIN</span>
00526 <span class="preprocessor"></span>    __rtai_sem_exit();
00527 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_SEM_BUILTIN */</span>
00528 <span class="preprocessor">#ifdef CONFIG_RTAI_LEDS_BUILTIN</span>
00529 <span class="preprocessor"></span>    __rtai_leds_exit();
00530 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_LEDS_BUILTIN */</span>
00531 }
00532 
00533 <span class="keywordtype">int</span> rt_check_current_stack(<span class="keywordtype">void</span>);
00534 
00535 <span class="keywordtype">int</span> rt_kthread_init(RT_TASK *task,
00536                     <span class="keywordtype">void</span> (*rt_thread)(<span class="keywordtype">int</span>),
00537                     <span class="keywordtype">int</span> data,
00538                     <span class="keywordtype">int</span> stack_size,
00539                     <span class="keywordtype">int</span> priority,
00540                     <span class="keywordtype">int</span> uses_fpu,
00541                     <span class="keywordtype">void</span>(*signal)(<span class="keywordtype">void</span>));
00542 
00543 <span class="keywordtype">int</span> rt_kthread_init_cpuid(RT_TASK *task,
00544                           <span class="keywordtype">void</span> (*rt_thread)(<span class="keywordtype">int</span>),
00545                           <span class="keywordtype">int</span> data,
00546                           <span class="keywordtype">int</span> stack_size,
00547                           <span class="keywordtype">int</span> priority,
00548                           <span class="keywordtype">int</span> uses_fpu,
00549                           <span class="keywordtype">void</span>(*signal)(<span class="keywordtype">void</span>),
00550                           <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cpuid);
00551 
00552 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL__ */</span>
00553 
00554 <span class="preprocessor">#endif </span><span class="comment">/* !_RTAI_SCHEDCORE_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Jul 24 19:36:04 2004 for RTAI API by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
