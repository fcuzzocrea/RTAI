<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI API: rtai-core/include/rtai_shm.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>rtai-core/include/rtai_shm.h</h1><a href="rtai__shm_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00026 <span class="comment">/*</span>
00027 <span class="comment">ACKNOWLEDGMENTS:</span>
00028 <span class="comment">- The suggestion and the code for mmapping at a user specified address is due to  Trevor Woolven (trevw@zentropix.com).</span>
00029 <span class="comment">*/</span>
00030 
00031 
00032 <span class="comment">// the "_new" in some of the functions below is temporary, to avoid</span>
00033 <span class="comment">// clashing with the very same functions in malloc.c, it will disappear</span>
00034 <span class="comment">// when shm.c will become the only real time memory management support</span>
00035 <span class="comment">// (using xnheap_alloc/free, in xenomai/heap.c).</span>
00036 
00037 <span class="preprocessor">#ifndef _RTAI_SHM_H</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#define _RTAI_SHM_H</span>
00039 <span class="preprocessor"></span>
00043 <span class="preprocessor">#define GLOBAL_HEAP_ID  0x9ac6d9e5  // nam2num("RTGLBH");</span>
00044 <span class="preprocessor"></span>
00045 <span class="preprocessor">#define USE_VMALLOC     0</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#define USE_GFP_KERNEL  1</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#define USE_GFP_ATOMIC  2</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#define USE_GFP_DMA     3</span>
00049 <span class="preprocessor"></span>
<a name="l00071"></a><a class="code" href="group__shm.html#a15">00071</a> <span class="preprocessor">#define rtai_kmalloc(name, size) \</span>
00072 <span class="preprocessor">        rt_shm_alloc(name, size, USE_VMALLOC)  // legacy</span>
00073 <span class="preprocessor"></span>
<a name="l00091"></a><a class="code" href="group__shm.html#a16">00091</a> <span class="preprocessor">#define rtai_kfree(name) \</span>
00092 <span class="preprocessor">        rt_shm_free(name)  // legacy</span>
00093 <span class="preprocessor"></span>
00094 <span class="preprocessor">#if defined(__KERNEL__)</span>
00095 <span class="preprocessor"></span>
00096 <span class="preprocessor">#include &lt;linux/module.h&gt;</span>
00097 <span class="preprocessor">#include &lt;linux/version.h&gt;</span>
00098 <span class="preprocessor">#include &lt;linux/vmalloc.h&gt;</span>
00099 <span class="preprocessor">#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,6,0)</span>
00100 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/wrapper.h&gt;</span>
00101 <span class="preprocessor">#else </span><span class="comment">/* &gt;= 2.6.0 */</span>
00102 <span class="preprocessor">#include &lt;linux/mm.h&gt;</span>
00103 <span class="preprocessor">#define mem_map_reserve(p)   SetPageReserved(p)</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#define mem_map_unreserve(p) ClearPageReserved(p)</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* &lt; 2.6.0 */</span>
00106 
00107 <span class="preprocessor">#include &lt;asm/rtai_shm.h&gt;</span>
00108 
00109 <span class="preprocessor">#ifdef __cplusplus</span>
00110 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00111 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00112 
00113 <span class="keywordtype">int</span> __rtai_shm_init(<span class="keywordtype">void</span>);
00114 
00115 <span class="keywordtype">void</span> __rtai_shm_exit(<span class="keywordtype">void</span>);
00116 
00117 <span class="keywordtype">void</span> *<a class="code" href="shm_8c.html#a19">rt_shm_alloc</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name,
00118                    <span class="keywordtype">int</span> size,
00119                    <span class="keywordtype">int</span> suprt);
00120 
00121 <span class="preprocessor">#define rt_shm_alloc_adr(adr, name, size) \</span>
00122 <span class="preprocessor">        rt_shm_alloc(name, size, suprt)</span>
00123 <span class="preprocessor"></span>
00124 <span class="keywordtype">int</span> <a class="code" href="shm_8c.html#a21">rt_shm_free</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name);
00125 
00126 <span class="keywordtype">void</span> *<a class="code" href="shm_8c.html#a47">rt_heap_open</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name,
00127                    <span class="keywordtype">int</span> size,
00128                    <span class="keywordtype">int</span> suprt);
00129 
00130 <span class="preprocessor">#define rt_heap_open_adr(adr, name, size, suprt) \</span>
00131 <span class="preprocessor">        rt_heap_open(name, size, suprt)</span>
00132 <span class="preprocessor"></span>
00133 <span class="keywordtype">void</span> *<a class="code" href="shm_8c.html#a39">rt_halloc</a>(<span class="keywordtype">int</span> size);
00134 
00135 <span class="keywordtype">void</span> <a class="code" href="shm_8c.html#a40">rt_hfree</a>(<span class="keywordtype">void</span> *addr);
00136 
00137 <span class="keywordtype">void</span> *<a class="code" href="shm_8c.html#a41">rt_named_halloc</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name,
00138                       <span class="keywordtype">int</span> size);
00139 
00140 <span class="keywordtype">void</span> <a class="code" href="shm_8c.html#a42">rt_named_hfree</a>(<span class="keywordtype">void</span> *addr);
00141 
00142 <span class="keywordtype">void</span> *<a class="code" href="shm_8c.html#a31">rt_malloc_new</a>(<span class="keywordtype">int</span> size);
00143 
00144 <span class="keywordtype">void</span> <a class="code" href="shm_8c.html#a32">rt_free_new</a>(<span class="keywordtype">void</span> *addr);
00145 
00146 <span class="keywordtype">void</span> *<a class="code" href="shm_8c.html#a33">rt_named_malloc</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name,
00147                       <span class="keywordtype">int</span> size);
00148 
00149 <span class="keywordtype">void</span> <a class="code" href="shm_8c.html#a34">rt_named_free</a>(<span class="keywordtype">void</span> *addr);
00150 
00151 <span class="keywordtype">void</span> *rvmalloc(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);
00152 
00153 <span class="keywordtype">void</span> rvfree(<span class="keywordtype">void</span> *mem,
00154             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);
00155 
00156 <span class="keywordtype">int</span> rvmmap(<span class="keywordtype">void</span> *mem,
00157            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> memsize,
00158            <span class="keyword">struct</span> vm_area_struct *vma);
00159 
00160 <span class="keywordtype">void</span> *rkmalloc(<span class="keywordtype">int</span> *size,
00161                <span class="keywordtype">int</span> suprt);
00162 
00163 <span class="keywordtype">void</span> rkfree(<span class="keywordtype">void</span> *mem,
00164             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);
00165 
00166 <span class="keywordtype">int</span> rkmmap(<span class="keywordtype">void</span> *mem,
00167            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> memsize,
00168            <span class="keyword">struct</span> vm_area_struct *vma);
00169 
00170 <span class="preprocessor">#ifdef __cplusplus</span>
00171 <span class="preprocessor"></span>}
00172 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00173 
00174 <span class="preprocessor">#else </span><span class="comment">/* !__KERNEL__ */</span>
00175 
00176 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00177 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00178 <span class="preprocessor">#include &lt;sys/mman.h&gt;</span>
00179 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
00180 <span class="preprocessor">#include &lt;<a class="code" href="rtai__lxrt_8h.html">rtai_lxrt.h</a>&gt;</span>
00181 
00182 <span class="comment">//#define SHM_USE_LXRT</span>
00183 
00184 <span class="preprocessor">#define RTAI_SHM_DEV  "/dev/rtai_shm"</span>
00185 <span class="preprocessor"></span>
00186 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> *_rt_shm_alloc(<span class="keywordtype">void</span> *start, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> suprt, <span class="keywordtype">int</span> isheap)
00187 {
00188         <span class="keywordtype">int</span> hook;
00189         <span class="keywordtype">void</span> *adr;
00190         <span class="keywordflow">if</span> ((hook = open(RTAI_SHM_DEV, O_RDWR)) &lt;= 0) {
00191                 <span class="keywordflow">return</span> 0;
00192         } <span class="keywordflow">else</span> {
00193                 <span class="keyword">struct </span>{ <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name, arg, suprt; } arg = { name, size, suprt };
00194 <span class="preprocessor">#ifdef SHM_USE_LXRT</span>
00195 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((size = rtai_lxrt(BIDX, SIZARG, SHM_ALLOC, &amp;arg).i[LOW])) {
00196 <span class="preprocessor">#else</span>
00197 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((size = ioctl(hook, SHM_ALLOC, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(&amp;arg)))) {
00198 <span class="preprocessor">#endif</span>
00199 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ((adr = mmap(start, size, PROT_WRITE | PROT_READ, MAP_SHARED | MAP_LOCKED | MAP_FILE, hook, 0)) == (<span class="keywordtype">void</span> *)-1) {;
00200 <span class="preprocessor">#ifdef SHM_USE_LXRT</span>
00201 <span class="preprocessor"></span>                                rtai_lxrt(BIDX, <span class="keyword">sizeof</span>(name), SHM_FREE, &amp;name);
00202 <span class="preprocessor">#else</span>
00203 <span class="preprocessor"></span>                                ioctl(hook, SHM_FREE, &amp;name);
00204 <span class="preprocessor">#endif</span>
00205 <span class="preprocessor"></span>                                adr = 0;
00206                         } 
00207 <span class="preprocessor">#if 0</span>
00208 <span class="preprocessor"></span>                          <span class="keywordflow">else</span> {
00209                                 <span class="keywordtype">int</span> i;
00210                                 <span class="keyword">volatile</span> <span class="keywordtype">int</span> k;
00211                                 <span class="keywordflow">for</span> (i = 0; i &lt; size/<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>); i++) {
00212                                         k = ((<span class="keywordtype">int</span> *)adr)[i];
00213                                 }
00214                                 mlockall(MCL_CURRENT | MCL_FUTURE);
00215                         }
00216 <span class="preprocessor">#endif</span>
00217 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (isheap) {
00218                                 arg.arg = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)adr;
00219 <span class="preprocessor">#ifdef SHM_USE_LXRT</span>
00220 <span class="preprocessor"></span>                                rtai_lxrt(BIDX, SIZARG, HEAP_SET, &amp;arg);
00221 <span class="preprocessor">#else</span>
00222 <span class="preprocessor"></span>                                ioctl(hook, HEAP_SET, &amp;arg);
00223 <span class="preprocessor">#endif</span>
00224 <span class="preprocessor"></span>                        }
00225                 } <span class="keywordflow">else</span> {
00226                         adr = 0;
00227                 }
00228         }
00229         close(hook);
00230         <span class="keywordflow">return</span> adr;
00231 }
00232 
00233 <span class="preprocessor">#define rt_shm_alloc(name, size, suprt)  \</span>
00234 <span class="preprocessor">        _rt_shm_alloc(0, name, size, suprt, 0)</span>
00235 <span class="preprocessor"></span>
00236 <span class="preprocessor">#define rt_heap_open(name, size, suprt)  \</span>
00237 <span class="preprocessor">        _rt_shm_alloc(0, name, size, suprt, 1)</span>
00238 <span class="preprocessor"></span>
<a name="l00260"></a><a class="code" href="group__shm.html#a20">00260</a> <span class="preprocessor">#define rtai_malloc(name, size)  \</span>
00261 <span class="preprocessor">        _rt_shm_alloc(0, name, size, USE_VMALLOC, 0)  // legacy</span>
00262 <span class="preprocessor"></span>
<a name="l00303"></a><a class="code" href="group__shm.html#a21">00303</a> <span class="preprocessor">#define rt_shm_alloc_adr(start_address, name, size, suprt)  \</span>
00304 <span class="preprocessor">        _rt_shm_alloc(start_address, name, size, suprt, 0)</span>
00305 <span class="preprocessor"></span>
00306 <span class="preprocessor">#define rt_heap_open_adr(start, name, size, suprt)  \</span>
00307 <span class="preprocessor">        _rt_shm_alloc(start, name, size, suprt, 1)</span>
00308 <span class="preprocessor"></span>
<a name="l00332"></a><a class="code" href="group__shm.html#a23">00332</a> <span class="preprocessor">#define rtai_malloc_adr(start_address, name, size)  \</span>
00333 <span class="preprocessor">        _rt_shm_alloc(start_address, name, size, USE_VMALLOC, 0)  // legacy</span>
00334 <span class="preprocessor"></span>
<a name="l00335"></a><a class="code" href="group__shm.html#a1">00335</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="shm_8c.html#a21">rt_shm_free</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name) 
00336 {
00337         <span class="keywordtype">int</span> hook, size;
00338         <span class="keyword">struct </span>{ <span class="keywordtype">void</span> *nameadr; } arg = { &amp;name };
00339         <span class="keywordflow">if</span> ((hook = open(RTAI_SHM_DEV, O_RDWR)) &lt;= 0) {
00340                 <span class="keywordflow">return</span> 0;
00341         }
00342 <span class="comment">// no SHM_FREE needed, we release it all and munmap will do it through </span>
00343 <span class="comment">// the vma close operation provided by shm.c</span>
00344 <span class="preprocessor">#ifdef SHM_USE_LXRT</span>
00345 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((size = rtai_lxrt(BIDX, SIZARG, SHM_SIZE, &amp;arg).i[LOW])) {
00346 <span class="preprocessor">#else</span>
00347 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((size = ioctl(hook, SHM_SIZE, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)&amp;arg))) {
00348 <span class="preprocessor">#endif</span>
00349 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (munmap((<span class="keywordtype">void</span> *)name, size)) {
00350                         size = 0;
00351                 }
00352         }
00353         close(hook);
00354         <span class="keywordflow">return</span> size;
00355 }
00356 
<a name="l00374"></a><a class="code" href="group__shm.html#a24">00374</a> <span class="preprocessor">#define rtai_free(name, adr)  \</span>
00375 <span class="preprocessor">        rt_shm_free(name)  // legacy</span>
00376 <span class="preprocessor"></span>
<a name="l00377"></a><a class="code" href="group__shm.html#a2">00377</a> RTAI_PROTO(<span class="keywordtype">void</span> *, rt_halloc, (<span class="keywordtype">int</span> size))
00378 {
00379         <span class="keyword">struct </span>{ <span class="keywordtype">int</span> size; } arg = { size };
00380         <span class="keywordflow">return</span> rtai_lxrt(BIDX, SIZARG, HEAP_ALLOC, &amp;arg).v[LOW];
00381 }
00382 
<a name="l00383"></a><a class="code" href="group__shm.html#a3">00383</a> RTAI_PROTO(<span class="keywordtype">void</span>, rt_hfree, (<span class="keywordtype">void</span> *addr))
00384 {
00385         <span class="keyword">struct </span>{ <span class="keywordtype">void</span> *addr; } arg = { addr };
00386         rtai_lxrt(BIDX, SIZARG, HEAP_FREE, &amp;arg);
00387 }
00388 
<a name="l00389"></a><a class="code" href="group__shm.html#a4">00389</a> RTAI_PROTO(<span class="keywordtype">void</span> *, rt_named_halloc, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name, <span class="keywordtype">int</span> size))
00390 {
00391         <span class="keyword">struct </span>{ <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name; <span class="keywordtype">int</span> size; } arg = { name, size };
00392         <span class="keywordflow">return</span> rtai_lxrt(BIDX, SIZARG, HEAP_NAMED_ALLOC, &amp;arg).v[LOW];
00393 }
00394 
<a name="l00395"></a><a class="code" href="group__shm.html#a5">00395</a> RTAI_PROTO(<span class="keywordtype">void</span>, rt_named_hfree, (<span class="keywordtype">void</span> *addr))
00396 {
00397         <span class="keyword">struct </span>{ <span class="keywordtype">void</span> *addr; } arg = { addr };
00398         rtai_lxrt(BIDX, SIZARG, HEAP_NAMED_FREE, &amp;arg);
00399 }
00400 
<a name="l00401"></a><a class="code" href="group__shm.html#a6">00401</a> RTAI_PROTO(<span class="keywordtype">void</span> *, rt_malloc_new, (<span class="keywordtype">int</span> size))
00402 {
00403         <span class="keyword">struct </span>{ <span class="keywordtype">int</span> size; } arg = { size };
00404         <span class="keywordflow">return</span> rtai_lxrt(BIDX, SIZARG, MALLOC, &amp;arg).v[LOW];
00405 }
00406 
<a name="l00407"></a><a class="code" href="group__shm.html#a7">00407</a> RTAI_PROTO(<span class="keywordtype">void</span>, rt_free_new, (<span class="keywordtype">void</span> *addr))
00408 {
00409         <span class="keyword">struct </span>{ <span class="keywordtype">void</span> *addr; } arg = { addr };
00410         rtai_lxrt(BIDX, SIZARG, FREE, &amp;arg);
00411 }
00412 
<a name="l00413"></a><a class="code" href="group__shm.html#a8">00413</a> RTAI_PROTO(<span class="keywordtype">void</span> *, rt_named_malloc, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name, <span class="keywordtype">int</span> size))
00414 {
00415         <span class="keyword">struct </span>{ <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name; <span class="keywordtype">int</span> size; } arg = { name, size };
00416         <span class="keywordflow">return</span> rtai_lxrt(BIDX, SIZARG, NAMED_MALLOC, &amp;arg).v[LOW];
00417 }
00418 
<a name="l00419"></a><a class="code" href="group__shm.html#a9">00419</a> RTAI_PROTO(<span class="keywordtype">void</span>, rt_named_free, (<span class="keywordtype">void</span> *addr))
00420 {
00421         <span class="keyword">struct </span>{ <span class="keywordtype">void</span> *addr; } arg = { addr };
00422         rtai_lxrt(BIDX, SIZARG, NAMED_FREE, &amp;arg);
00423 }
00424 
00425 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL__ */</span>
00426 
<a name="l00446"></a><a class="code" href="group__shm.html#a25">00446</a> <span class="preprocessor">#define rt_heap_close(name, adr)  rt_shm_free(name)</span>
00447 <span class="preprocessor"></span>
00448 <span class="comment">// aliases in use already, different heads different choices</span>
00449 <span class="preprocessor">#define rt_heap_init         rt_heap_open</span>
00450 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_create       rt_heap_open</span>
00451 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_acquire      rt_heap_open</span>
00452 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_init_adr     rt_heap_open_adr</span>
00453 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_create_adr   rt_heap_open_adr</span>
00454 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_acquire_adr  rt_heap_open_adr</span>
00455 <span class="preprocessor"></span>
00456 <span class="preprocessor">#define rt_heap_delete       rt_heap_close</span>
00457 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_destroy      rt_heap_close</span>
00458 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_release      rt_heap_close</span>
00459 <span class="preprocessor"></span>
00460 <span class="comment">// these have no aliases, and never will</span>
00461 
<a name="l00477"></a><a class="code" href="group__shm.html#a35">00477</a> <span class="preprocessor">#define rt_global_heap_open()  rt_heap_open(GLOBAL_HEAP_ID, 0, 0)</span>
00478 <span class="preprocessor"></span>
<a name="l00495"></a><a class="code" href="group__shm.html#a36">00495</a> <span class="preprocessor">#define rt_global_heap_close()  rt_heap_close(GLOBAL_HEAP_ID, 0)</span>
00496 <span class="preprocessor"></span>
00499 <span class="preprocessor">#endif </span><span class="comment">/* !_RTAI_SHM_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 14 03:17:31 2004 for RTAI API by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
