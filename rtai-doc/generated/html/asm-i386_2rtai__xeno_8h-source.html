<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI API: rtai-core/include/asm-i386/rtai_xeno.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>rtai-core/include/asm-i386/rtai_xeno.h</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * Copyright (C) 2001,2002,2003 Philippe Gerum &lt;rpm@xenomai.org&gt;.</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Xenomai is free software; you can redistribute it and/or modify it</span>
00005 <span class="comment"> * under the terms of the GNU General Public License as published by</span>
00006 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment"> * (at your option) any later version.</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * Xenomai is distributed in the hope that it will be useful, but</span>
00010 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00012 <span class="comment"> * General Public License for more details.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00015 <span class="comment"> * along with Xenomai; if not, write to the Free Software Foundation,</span>
00016 <span class="comment"> * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> * As a special exception, the RTAI project gives permission</span>
00019 <span class="comment"> * for additional uses of the text contained in its release of</span>
00020 <span class="comment"> * Xenomai.</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> * The exception is that, if you link the Xenomai libraries with other</span>
00023 <span class="comment"> * files to produce an executable, this does not by itself cause the</span>
00024 <span class="comment"> * resulting executable to be covered by the GNU General Public License.</span>
00025 <span class="comment"> * Your use of that executable is in no way restricted on account of</span>
00026 <span class="comment"> * linking the Xenomai libraries code into it.</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> * This exception does not however invalidate any other reasons why</span>
00029 <span class="comment"> * the executable file might be covered by the GNU General Public</span>
00030 <span class="comment"> * License.</span>
00031 <span class="comment"> *</span>
00032 <span class="comment"> * This exception applies only to the code released by the</span>
00033 <span class="comment"> * RTAI project under the name Xenomai.  If you copy code from other</span>
00034 <span class="comment"> * RTAI project releases into a copy of Xenomai, as the General Public</span>
00035 <span class="comment"> * License permits, the exception does not apply to the code that you</span>
00036 <span class="comment"> * add in this way.  To avoid misleading anyone as to the status of</span>
00037 <span class="comment"> * such modified files, you must delete this exception notice from</span>
00038 <span class="comment"> * them.</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * If you write modifications of your own for Xenomai, it is your</span>
00041 <span class="comment"> * choice whether to permit this exception to apply to your</span>
00042 <span class="comment"> * modifications. If you do not wish that, delete this exception</span>
00043 <span class="comment"> * notice.</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> * This file implements the interface between the Xenomai nucleus and</span>
00046 <span class="comment"> * RTAI/Adeos in kernel space.</span>
00047 <span class="comment"> */</span>
00048 
00049 <span class="preprocessor">#ifndef _RTAI_ASM_I386_XENO_H</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#define _RTAI_ASM_I386_XENO_H</span>
00051 <span class="preprocessor"></span>
00052 <span class="preprocessor">#include &lt;linux/kernel.h&gt;</span>
00053 <span class="preprocessor">#include &lt;linux/version.h&gt;</span>
00054 <span class="preprocessor">#include &lt;linux/module.h&gt;</span>
00055 <span class="preprocessor">#include &lt;linux/slab.h&gt;</span>
00056 <span class="preprocessor">#include &lt;linux/errno.h&gt;</span>
00057 <span class="preprocessor">#include &lt;linux/wrapper.h&gt;</span>
00058 <span class="preprocessor">#include &lt;linux/adeos.h&gt;</span>
00059 <span class="preprocessor">#include &lt;asm/uaccess.h&gt;</span>
00060 <span class="preprocessor">#include &lt;asm/mmu_context.h&gt;</span>
00061 <span class="preprocessor">#include &lt;rtai_config.h&gt;</span>
00062 <span class="preprocessor">#include &lt;asm/rtai_hal.h&gt;</span>
00063 <span class="preprocessor">#include &lt;asm/rtai_xnatomic.h&gt;</span>
00064 <span class="preprocessor">#include &lt;xenomai/shadow.h&gt;</span>
00065 
00066 <span class="preprocessor">#define MODULE_PARM_VALUE(parm) (parm)</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#ifndef MODULE_LICENSE</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#define MODULE_LICENSE(s)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* MODULE_LICENSE */</span>
00070 
00071 <span class="preprocessor">#define MAIN_INIT_MODULE     init_module</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#define MAIN_CLEANUP_MODULE  cleanup_module</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#define SKIN_INIT_MODULE     init_module</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#define SKIN_CLEANUP_MODULE  cleanup_module</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#define USER_INIT_MODULE     init_module</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#define USER_CLEANUP_MODULE  cleanup_module</span>
00077 <span class="preprocessor"></span>
00078 <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> spl_t;
00079 
00080 <span class="preprocessor">#define splhigh(x)  arti_local_irq_save(x)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#define splexit(x)  arti_local_irq_restore(x)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#define splnone()   arti_sti()</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#define spltest()   arti_local_irq_test()</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#define splget(x)   arti_local_irq_flags(x)</span>
00085 <span class="preprocessor"></span>
00086 <span class="preprocessor">#define XNARCH_DEFAULT_TICK  1000000 </span><span class="comment">/* ns, i.e. 1ms */</span>
00087 <span class="preprocessor">#define XNARCH_IRQ_MAX       NR_IRQS</span>
00088 <span class="preprocessor"></span>
00089 <span class="preprocessor">#define XNARCH_THREAD_COOKIE  (THIS_MODULE)</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#define XNARCH_THREAD_STACKSZ 4096</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#define XNARCH_ROOT_STACKSZ   0 </span><span class="comment">/* Only a placeholder -- no stack */</span>
00092 
00093 <span class="preprocessor">#define xnarch_printf                printk </span><span class="comment">/* Yup! This is safe under ARTI */</span>
00094 <span class="preprocessor">#define xnarch_ullmod(ull,uld,rem)   (xnarch_ulldiv(ull,uld,rem), (*rem))</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_ulldiv                arti_ulldiv</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_imuldiv               arti_imuldiv</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_llimd                 arti_llimd</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_get_cpu_tsc           arti_rdtsc</span>
00099 <span class="preprocessor"></span>
00100 <span class="keyword">struct </span>xnthread;
00101 <span class="keyword">struct </span>xnmutex;
00102 <span class="keyword">struct </span>module;
00103 <span class="keyword">struct </span>task_struct;
00104 
00105 <span class="preprocessor">#define xnarch_stack_size(tcb)  ((tcb)-&gt;stacksize)</span>
00106 <span class="preprocessor"></span>
00107 <span class="keyword">typedef</span> <span class="keyword">struct </span>xnarchtcb {      <span class="comment">/* Per-thread arch-dependent block */</span>
00108 
00109     <span class="comment">/* Kernel mode side */</span>
00110     <span class="keyword">union </span>i387_union fpuenv __attribute__ ((aligned (16))); <span class="comment">/* FPU backup area */</span>
00111     <span class="keywordtype">unsigned</span> stacksize;         <span class="comment">/* Aligned size of stack (bytes) */</span>
00112     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *stackbase;   <span class="comment">/* Stack space */</span>
00113     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> esp;          <span class="comment">/* Saved ESP for kernel-based threads */</span>
00114     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> eip;          <span class="comment">/* Saved EIP for kernel-based threads */</span>
00115     <span class="keywordtype">int</span> cr0;                    <span class="comment">/* A (somewhat phony) version of the cr0 register */</span>
00116     <span class="keyword">struct </span>module *module;      <span class="comment">/* Creator's module */</span>
00117 
00118     <span class="comment">/* User mode side */</span>
00119     <span class="keyword">struct </span>task_struct *user_task;      <span class="comment">/* Shadowed user-space task */</span>
00120     <span class="keyword">struct </span>task_struct *active_task;    <span class="comment">/* Active user-space task */</span>
00121 
00122     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *espp;        <span class="comment">/* Pointer to ESP backup area (&amp;esp or &amp;user-&gt;thread.esp) */</span>
00123     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *eipp;        <span class="comment">/* Pointer to EIP backup area (&amp;eip or &amp;user-&gt;thread.eip) */</span>
00124     <span class="keyword">union </span>i387_union *fpup;     <span class="comment">/* Pointer to the FPU backup area (&amp;fpuenv or &amp;user-&gt;thread.i387.f[x]save */</span>
00125 
00126 } xnarchtcb_t;
00127 
00128 <span class="keyword">typedef</span> <span class="keyword">struct </span>xnarch_fltinfo {
00129 
00130     <span class="keywordtype">unsigned</span> vector;
00131     <span class="keywordtype">long</span> errcode;
00132     <span class="keyword">struct </span>pt_regs *regs;
00133 
00134 } xnarch_fltinfo_t;
00135 
00136 <span class="preprocessor">#define xnarch_fault_trap(fi)  ((fi)-&gt;vector)</span>
00137 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_fault_code(fi)  ((fi)-&gt;errcode)</span>
00138 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_fault_pc(fi)    ((fi)-&gt;regs-&gt;eip)</span>
00139 <span class="preprocessor"></span>
00140 <span class="keyword">extern</span> adomain_t xeno_domain;
00141 
00142 <span class="preprocessor">#ifdef __cplusplus</span>
00143 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00144 <span class="preprocessor">#endif</span>
00145 <span class="preprocessor"></span>
00146 <span class="preprocessor">#ifdef XENO_INTR_MODULE</span>
00147 <span class="preprocessor"></span>
00148 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> xnarch_hook_irq (<span class="keywordtype">unsigned</span> irq,
00149                                    <span class="keywordtype">void</span> (*handler)(<span class="keywordtype">unsigned</span> irq,
00150                                                    <span class="keywordtype">void</span> *cookie),
00151                                    <span class="keywordtype">void</span> *cookie)
00152 {
00153     <span class="keywordtype">int</span> err = rt_request_irq(irq,handler,cookie);
00154 
00155     <span class="keywordflow">if</span> (!err)
00156         rt_enable_irq(irq);
00157 
00158     <span class="keywordflow">return</span> err;
00159 }
00160 
00161 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> xnarch_release_irq (<span class="keywordtype">unsigned</span> irq) {
00162 
00163     <span class="keywordflow">return</span> rt_release_irq(irq);
00164 }
00165 
00166 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> xnarch_enable_irq (<span class="keywordtype">unsigned</span> irq)
00167 
00168 {
00169     <span class="keywordflow">if</span> (irq &gt;= XNARCH_IRQ_MAX)
00170         <span class="keywordflow">return</span> -EINVAL;
00171 
00172     rt_enable_irq(irq);
00173 
00174     <span class="keywordflow">return</span> 0;
00175 }
00176 
00177 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> xnarch_disable_irq (<span class="keywordtype">unsigned</span> irq)
00178 
00179 {
00180     <span class="keywordflow">if</span> (irq &gt;= XNARCH_IRQ_MAX)
00181         <span class="keywordflow">return</span> -EINVAL;
00182 
00183     rt_disable_irq(irq);
00184 
00185     <span class="keywordflow">return</span> 0;
00186 }
00187 
00188 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_isr_chain_irq (<span class="keywordtype">unsigned</span> irq) {
00189     rt_pend_linux_irq(irq);
00190 }
00191 
00192 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_isr_enable_irq (<span class="keywordtype">unsigned</span> irq) {
00193     rt_enable_irq(irq);
00194 }
00195 
00196 <span class="preprocessor">#endif </span><span class="comment">/* XENO_INTR_MODULE */</span>
00197 
00198 <span class="preprocessor">#ifdef XENO_POD_MODULE</span>
00199 <span class="preprocessor"></span>
00200 <span class="keywordtype">void</span> <a class="code" href="group__pod.html#a63">xnpod_welcome_thread</a>(<span class="keyword">struct</span> xnthread *);
00201 
00202 <span class="keywordtype">void</span> <a class="code" href="group__pod.html#a60">xnpod_delete_thread</a>(<span class="keyword">struct</span> xnthread *,
00203                          <span class="keyword">struct</span> xnmutex *mutex);
00204 
00205 <span class="keyword">static</span> <span class="keywordtype">void</span> xnarch_recover_jiffies (<span class="keywordtype">int</span> irq,
00206                                     <span class="keywordtype">void</span> *dev_id,
00207                                     <span class="keyword">struct</span> pt_regs *regs)
00208 {
00209     spl_t s;
00210 
00211     splhigh(s);
00212 
00213     <span class="keywordflow">if</span> (rt_times.tick_time &gt;= rt_times.linux_time)
00214         {
00215         rt_times.linux_time += rt_times.linux_tick;
00216         rt_pend_linux_irq(TIMER_8254_IRQ);
00217         }
00218 
00219     splexit(s);
00220 } 
00221 
00222 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_start_timer (<span class="keywordtype">int</span> ns, <span class="keywordtype">void</span> (*tickhandler)(<span class="keywordtype">void</span>))
00223 
00224 {
00225     <span class="keywordtype">unsigned</span> period = (<span class="keywordtype">unsigned</span>)llimd(ns,ARTI_FREQ_8254,1000000000);
00226     <span class="comment">/* Always use periodic mode. */</span>
00227     arti_tunables.timers_tol[0] = (rt_times.periodic_tick + 1) &gt;&gt; 1;
00228     rt_request_timer(tickhandler,period &gt; LATCH ? LATCH : period,0);
00229 }
00230 
00231 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_stop_timer (<span class="keywordtype">void</span>)
00232 
00233 {
00234     rt_free_linux_irq(TIMER_8254_IRQ,&amp;xnarch_recover_jiffies);
00235     <a class="code" href="group__hal.html#a70">rt_free_timer</a>();
00236 }
00237 
00238 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_leave_root (xnarchtcb_t *rootcb) {
00239     TRACE_RTAI_SWITCHTO_RT(0);
00240     set_bit(0,&amp;arti_cpu_realtime);
00241     <span class="comment">/* Remember the preempted non-RT task pointer. */</span>
00242     rootcb-&gt;user_task = rootcb-&gt;active_task = arti_get_current(0);
00243 }
00244 
00245 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_enter_root (xnarchtcb_t *rootcb) {
00246     TRACE_RTAI_SWITCHTO_LINUX(0);
00247     clear_bit(0,&amp;arti_cpu_realtime);
00248 }
00249 
00250 <span class="preprocessor">#define __switch_threads(out_tcb, in_tcb, outproc, inproc) \</span>
00251 <span class="preprocessor">do { \</span>
00252 <span class="preprocessor">        __asm__ __volatile__( \</span>
00253 <span class="preprocessor">        "pushl %%ecx\n\t" \</span>
00254 <span class="preprocessor">        "pushl %%edi\n\t" \</span>
00255 <span class="preprocessor">        "pushl %%ebp\n\t" \</span>
00256 <span class="preprocessor">        "movl %0,%%ecx\n\t" \</span>
00257 <span class="preprocessor">        "movl %%esp,(%%ecx)\n\t" \</span>
00258 <span class="preprocessor">        "movl %1,%%ecx\n\t" \</span>
00259 <span class="preprocessor">        "movl $1f,(%%ecx)\n\t" \</span>
00260 <span class="preprocessor">        "movl %2,%%ecx\n\t" \</span>
00261 <span class="preprocessor">        "movl %3,%%edi\n\t" \</span>
00262 <span class="preprocessor">        "movl (%%ecx),%%esp\n\t" \</span>
00263 <span class="preprocessor">        "pushl (%%edi)\n\t" \</span>
00264 <span class="preprocessor">        "testl %%edx,%%edx\n\t" \</span>
00265 <span class="preprocessor">        "jne  __switch_to\n\t" \</span>
00266 <span class="preprocessor">        "ret\n\t" \</span>
00267 <span class="preprocessor">"1:      popl %%ebp\n\t" \</span>
00268 <span class="preprocessor">        "popl %%edi\n\t" \</span>
00269 <span class="preprocessor">        "popl %%ecx\n\t" \</span>
00270 <span class="preprocessor">      : </span><span class="comment">/* no output */</span> \
00271       : "m" (out_tcb-&gt;espp), \
00272         "m" (out_tcb-&gt;eipp), \
00273         "m" (in_tcb-&gt;espp), \
00274         "m" (in_tcb-&gt;eipp), \
00275         "b" (out_tcb), \
00276         "S" (in_tcb), \
00277         "a" (outproc), \
00278         "d" (inproc)); \
00279 } while (0)
00280 
00281 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_switch_to (xnarchtcb_t *out_tcb,
00282                                      xnarchtcb_t *in_tcb)
00283 {
00284     <span class="keyword">struct </span>task_struct *outproc = out_tcb-&gt;active_task;
00285     <span class="keyword">struct </span>task_struct *inproc = in_tcb-&gt;user_task;
00286 
00287     in_tcb-&gt;active_task = inproc ?: outproc;
00288 
00289     <span class="keywordflow">if</span> (inproc &amp;&amp; inproc != outproc)
00290         arti_switch_linux_mm(outproc,inproc,0);
00291 
00292     __switch_threads(out_tcb,in_tcb,outproc,inproc);
00293 }
00294 
00295 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_finalize_and_switch (xnarchtcb_t *dead_tcb,
00296                                                xnarchtcb_t *next_tcb) {
00297     xnarch_switch_to(dead_tcb,next_tcb);
00298 }
00299 
00300 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_finalize_no_switch (xnarchtcb_t *dead_tcb) {
00301     <span class="comment">/* Empty */</span>
00302 }
00303 
00304 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_save_fpu (xnarchtcb_t *tcb)
00305 
00306 {
00307 <span class="preprocessor">#ifdef CONFIG_RTAI_FPU_SUPPORT</span>
00308 <span class="preprocessor"></span>
00309     <span class="comment">/* If EM(bit 2) is cleared (i.e. FPU emulate is false), then this</span>
00310 <span class="comment">       is a real cr0 value, so we are considering a user-space thread</span>
00311 <span class="comment">       (root or shadow).  Otherwise, it is a phony cr0 register, so it</span>
00312 <span class="comment">       is a kernel-based thread. */</span>
00313 
00314     <span class="keywordflow">if</span> (!(tcb-&gt;cr0 &amp; 0x4))
00315         {
00316         __asm__ __volatile__ (<span class="stringliteral">"movl %%cr0,%0"</span>: <span class="stringliteral">"=r"</span> (tcb-&gt;cr0));
00317         clts();
00318         }
00319 
00320     <span class="keywordflow">if</span> (cpu_has_fxsr)
00321         __asm__ __volatile__ (<span class="stringliteral">"fxsave %0; fnclex"</span> : <span class="stringliteral">"=m"</span> (*tcb-&gt;fpup));
00322     <span class="keywordflow">else</span>
00323         __asm__ __volatile__ (<span class="stringliteral">"fnsave %0; fwait"</span> : <span class="stringliteral">"=m"</span> (*tcb-&gt;fpup));
00324 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_FPU_SUPPORT */</span>
00325 }
00326 
00327 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_restore_fpu (xnarchtcb_t *tcb)
00328 
00329 {
00330 <span class="preprocessor">#ifdef CONFIG_RTAI_FPU_SUPPORT</span>
00331 <span class="preprocessor"></span>    clts();
00332 
00333     <span class="keywordflow">if</span> (cpu_has_fxsr)
00334         __asm__ __volatile__ (<span class="stringliteral">"fxrstor %0"</span>: <span class="comment">/* no output */</span> : <span class="stringliteral">"m"</span> (*tcb-&gt;fpup));
00335     <span class="keywordflow">else</span>
00336         __asm__ __volatile__ (<span class="stringliteral">"frstor %0"</span>: <span class="comment">/* no output */</span> : <span class="stringliteral">"m"</span> (*tcb-&gt;fpup));
00337 
00338     <span class="comment">/* If TS was set for the user-space thread before it yielded</span>
00339 <span class="comment">       control to a kernel-based one, reset this bit in cr0 before</span>
00340 <span class="comment">       control is given back to the user-space thread. */</span>
00341        
00342     <span class="keywordflow">if</span> ((tcb-&gt;cr0 &amp; 0xc) == 0x8) <span class="comment">/* EM=0 and TS=1? */</span>
00343         stts();
00344 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_FPU_SUPPORT */</span>
00345 }
00346 
00347 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_init_root_tcb (xnarchtcb_t *tcb,
00348                                          <span class="keyword">struct</span> xnthread *thread,
00349                                          <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
00350 {
00351     tcb-&gt;module = THIS_MODULE;
00352     tcb-&gt;user_task = current;
00353     tcb-&gt;active_task = NULL;
00354     tcb-&gt;esp = 0;
00355     tcb-&gt;espp = &amp;tcb-&gt;esp;
00356     tcb-&gt;eipp = &amp;tcb-&gt;eip;
00357     tcb-&gt;fpup = &amp;tcb-&gt;fpuenv;
00358     tcb-&gt;cr0 = 0; <span class="comment">/* Clear EM so we know it is a user-space thread */</span>
00359 }
00360 
00361 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_init_tcb (xnarchtcb_t *tcb, <span class="keywordtype">void</span> *adcookie) {
00362 
00363     tcb-&gt;module = (<span class="keyword">struct </span>module *)adcookie;
00364     tcb-&gt;user_task = NULL;
00365     tcb-&gt;active_task = NULL;
00366     tcb-&gt;espp = &amp;tcb-&gt;esp;
00367     tcb-&gt;eipp = &amp;tcb-&gt;eip;
00368     tcb-&gt;fpup = &amp;tcb-&gt;fpuenv;
00369     tcb-&gt;cr0 = 0x4; <span class="comment">/* Set EM so we know it is a phony cr0 */</span>
00370     <span class="comment">/* Must be followed by xnarch_init_thread(). */</span>
00371 }
00372 
00373 <span class="keyword">static</span> <span class="keywordtype">void</span> xnarch_thread_redirect (<span class="keyword">struct</span> xnthread *self,
00374                                     <span class="keywordtype">int</span> imask,
00375                                     <span class="keywordtype">void</span>(*entry)(<span class="keywordtype">void</span> *),
00376                                     <span class="keywordtype">void</span> *cookie)
00377 {
00378     arti_local_irq_restore(!!imask);
00379     <a class="code" href="group__pod.html#a63">xnpod_welcome_thread</a>(self);
00380     entry(cookie);
00381     <a class="code" href="group__pod.html#a60">xnpod_delete_thread</a>(self,NULL);
00382 }
00383 
00384 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_init_thread (xnarchtcb_t *tcb,
00385                                        <span class="keywordtype">void</span> (*entry)(<span class="keywordtype">void</span> *),
00386                                        <span class="keywordtype">void</span> *cookie,
00387                                        <span class="keywordtype">int</span> imask,
00388                                        <span class="keyword">struct</span> xnthread *thread,
00389                                        <span class="keywordtype">char</span> *name)
00390 {
00391     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> **psp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> **)&amp;tcb-&gt;esp;
00392 
00393     tcb-&gt;eip = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)&amp;xnarch_thread_redirect;
00394     tcb-&gt;esp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)tcb-&gt;stackbase;
00395     **psp = 0;  <span class="comment">/* Commit bottom stack memory */</span>
00396     *psp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*psp + tcb-&gt;stacksize - 0x10) &amp; ~0xf);
00397     *--(*psp) = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)cookie;
00398     *--(*psp) = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)entry;
00399     *--(*psp) = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)imask;
00400     *--(*psp) = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)thread;
00401     *--(*psp) = 0;
00402 }
00403 
00404 <span class="preprocessor">#ifdef CONFIG_RTAI_FPU_SUPPORT</span>
00405 <span class="preprocessor"></span>
00406 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_init_fpu (xnarchtcb_t *tcb)
00407 
00408 {
00409     __asm__ __volatile__ (<span class="stringliteral">"clts; fninit"</span>);
00410 
00411     <span class="keywordflow">if</span> (cpu_has_xmm)
00412         load_mxcsr(0x1f80);
00413 }
00414 
00415 <span class="preprocessor">#else </span><span class="comment">/* !CONFIG_RTAI_FPU_SUPPORT */</span>
00416 
00417 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_init_fpu (xnarchtcb_t *tcb) {
00418 }
00419 
00420 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_FPU_SUPPORT */</span>
00421 
00422 <span class="keywordtype">int</span> xnarch_setimask (<span class="keywordtype">int</span> imask)
00423 
00424 {
00425     spl_t s;
00426     splhigh(s);
00427     splexit(!!imask);
00428     <span class="keywordflow">return</span> !!s;
00429 }
00430 
00431 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_announce_tick (<span class="keywordtype">void</span>)
00432 
00433 {
00434     rt_times.tick_time = rt_times.intr_time;
00435 
00436     <span class="keywordflow">if</span> (rt_times.tick_time &gt;= rt_times.linux_time)
00437         {
00438         rt_times.linux_time += rt_times.linux_tick;
00439         rt_pend_linux_irq(TIMER_8254_IRQ);
00440         }
00441 
00442     rt_times.intr_time += rt_times.periodic_tick;
00443 }
00444 
00445 <span class="preprocessor">#define xnarch_notify_ready() </span><span class="comment">/* Nullified */</span>
00446 
00447 <span class="preprocessor">#endif </span><span class="comment">/* XENO_POD_MODULE */</span>
00448 
00449 <span class="preprocessor">#ifdef XENO_SHADOW_MODULE</span>
00450 <span class="preprocessor"></span>
00451 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_init_shadow_tcb (xnarchtcb_t *tcb,
00452                                            <span class="keyword">struct</span> xnthread *thread,
00453                                            <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
00454 {
00455     <span class="keyword">struct </span>task_struct *task = current;
00456 
00457     tcb-&gt;module = THIS_MODULE;
00458     tcb-&gt;user_task = task;
00459     tcb-&gt;active_task = NULL;
00460     tcb-&gt;esp = 0;
00461     tcb-&gt;espp = &amp;task-&gt;thread.esp;
00462     tcb-&gt;eipp = &amp;task-&gt;thread.eip;
00463     tcb-&gt;fpup = &amp;task-&gt;thread.i387;
00464     tcb-&gt;cr0 = 0;
00465 }
00466 
00467 <span class="preprocessor">#endif </span><span class="comment">/* XENO_SHADOW_MODULE */</span>
00468 
00469 <span class="preprocessor">#ifdef XENO_HEAP_MODULE</span>
00470 <span class="preprocessor"></span>
00471 <span class="keywordtype">void</span> *xnarch_sysalloc (<span class="keywordtype">unsigned</span> bytes) {
00472 
00473     <span class="keywordflow">return</span> kmalloc(bytes,GFP_ATOMIC);
00474 }
00475 
00476 <span class="keywordtype">void</span> xnarch_sysfree (<span class="keywordtype">void</span> *chunk, <span class="keywordtype">unsigned</span> bytes) {
00477 
00478     kfree(chunk);
00479 }
00480 
00481 <span class="preprocessor">#else </span><span class="comment">/* !XENO_HEAP_MODULE */</span>
00482 
00483 <span class="keywordtype">void</span> *xnarch_sysalloc(<span class="keywordtype">unsigned</span> bytes);
00484 
00485 <span class="keywordtype">void</span> xnarch_sysfree(<span class="keywordtype">void</span> *chunk,
00486                     <span class="keywordtype">unsigned</span> bytes);
00487 
00488 <span class="preprocessor">#endif </span><span class="comment">/* XENO_HEAP_MODULE */</span>
00489 
00490 <span class="preprocessor">#ifdef XENO_MAIN_MODULE</span>
00491 <span class="preprocessor"></span>
00492 <span class="keyword">static</span> RT_TRAP_HANDLER xnarch_old_trap_handler;
00493 
00494 adomain_t xeno_domain;
00495 
00496 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="group__pod.html#a65">xnpod_trap_fault</a>(xnarch_fltinfo_t *fltinfo);
00497 
00498 <span class="keyword">static</span> <span class="keywordtype">int</span> xnarch_trap_fault (<span class="keywordtype">int</span> vector,
00499                               <span class="keywordtype">int</span> signo,
00500                               <span class="keyword">struct</span> pt_regs *regs,
00501                               <span class="keywordtype">void</span> *dummy)
00502 {
00503     xnarch_fltinfo_t fltinfo;
00504 
00505     fltinfo.vector = vector;
00506     fltinfo.errcode = regs-&gt;orig_eax;
00507     fltinfo.regs = regs;
00508 
00509     <span class="keywordflow">return</span> <a class="code" href="group__pod.html#a65">xnpod_trap_fault</a>(&amp;fltinfo);
00510 }
00511 
00512 <span class="keyword">static</span> <span class="keywordtype">void</span> xnarch_irq_trampoline (<span class="keywordtype">unsigned</span> irq) {
00513     adeos_propagate_irq(irq);
00514 }
00515 
00516 <span class="keyword">static</span> <span class="keywordtype">void</span> xnarch_domain_entry (<span class="keywordtype">int</span> iflag)
00517 
00518 {
00519     <span class="keywordtype">unsigned</span> irq;
00520 
00521     <span class="keywordflow">if</span> (iflag)
00522         <span class="keywordflow">for</span> (irq = 0; irq &lt; NR_IRQS; irq++)
00523             adeos_virtualize_irq(irq,
00524                                  &amp;xnarch_irq_trampoline,
00525                                  NULL,
00526                                  IPIPE_DYNAMIC_MASK);
00527     <span class="keywordflow">for</span> (;;)
00528         adeos_suspend_domain();
00529 }
00530 
00531 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> xnarch_init (<span class="keywordtype">void</span>)
00532 
00533 {
00534     adattr_t attr;
00535 
00536     <span class="keywordflow">if</span> (!boot_cpu_data.wp_works_ok) <span class="comment">/* Needed by the shadow support. */</span>
00537         {
00538         printk(KERN_ERR <span class="stringliteral">"Sorry, a functional WP bit is needed to run Xenomai/x86"</span>);
00539         <span class="keywordflow">return</span> -ENOSYS;
00540         }
00541 
00542     xnarch_old_trap_handler = rt_set_trap_handler(&amp;xnarch_trap_fault);
00543 
00544     adeos_init_attr(&amp;attr);
00545     attr.name = <span class="stringliteral">"Xenomai"</span>;
00546     attr.domid = 0x59454e4f;
00547     attr.entry = &amp;xnarch_domain_entry;
00548     attr.priority = ADEOS_ROOT_PRI + 50;
00549 
00550     <span class="keywordflow">if</span> (adeos_register_domain(&amp;xeno_domain,&amp;attr))
00551         <span class="keywordflow">return</span> 1;
00552 
00553     xnshadow_init();
00554 
00555     <span class="keywordflow">return</span> 0;
00556 }
00557 
00558 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> xnarch_exit (<span class="keywordtype">void</span>) {
00559 
00560     xnshadow_cleanup();
00561     rt_set_rtai_trap_handler(xnarch_old_trap_handler);
00562     adeos_unregister_domain(&amp;xeno_domain);
00563 }
00564 
00565 <span class="preprocessor">#endif </span><span class="comment">/* XENO_MAIN_MODULE */</span>
00566 
00567 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> xnarch_tsc_to_ns (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ts) {
00568     <span class="keywordflow">return</span> xnarch_llimd(ts,1000000000,ARTI_CPU_FREQ);
00569 }
00570 
00571 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> xnarch_get_cpu_time (<span class="keywordtype">void</span>) {
00572     <span class="keywordflow">return</span> xnarch_tsc_to_ns(xnarch_get_cpu_tsc());
00573 }
00574 
00575 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> xnarch_get_cpu_freq (<span class="keywordtype">void</span>) {
00576     <span class="keywordflow">return</span> ARTI_CPU_FREQ;
00577 }
00578 
00579 <span class="preprocessor">#define xnarch_halt(emsg) \</span>
00580 <span class="preprocessor">do { \</span>
00581 <span class="preprocessor">    xnarch_printf("Xenomai: fatal: %s\n",emsg); \</span>
00582 <span class="preprocessor">    BUG(); \</span>
00583 <span class="preprocessor">} while(0)</span>
00584 <span class="preprocessor"></span>
00585 <span class="keywordtype">int</span> xnarch_setimask(<span class="keywordtype">int</span> imask);
00586 
00587 <span class="preprocessor">#ifdef __cplusplus</span>
00588 <span class="preprocessor"></span>}
00589 <span class="preprocessor">#endif</span>
00590 <span class="preprocessor"></span>
00591 <span class="comment">/* Dashboard and graph control. */</span>
00592 <span class="preprocessor">#define XNARCH_DECL_DISPLAY_CONTEXT();</span>
00593 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_init_display_context(obj)</span>
00594 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_create_display(obj,name,tag)</span>
00595 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_delete_display(obj)</span>
00596 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_post_graph(obj,state)</span>
00597 <span class="preprocessor"></span><span class="preprocessor">#define xnarch_post_graph_if(obj,state,cond)</span>
00598 <span class="preprocessor"></span>
00599 <span class="preprocessor">#endif </span><span class="comment">/* !_RTAI_ASM_I386_XENO_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Jun 18 18:14:30 2004 for RTAI API by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
