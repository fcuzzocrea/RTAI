<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI API: rtai-core/include/rtai_shm.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>rtai-core/include/rtai_shm.h</h1><a href="rtai__shm_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00026 <span class="comment">/*</span>
00027 <span class="comment">ACKNOWLEDGMENTS:</span>
00028 <span class="comment">- The suggestion and the code for mmapping at a user specified address is due to  Trevor Woolven (trevw@zentropix.com).</span>
00029 <span class="comment">*/</span>
00030 
00031 
00032 <span class="comment">// the "_new" in some of the functions below is temporary, to avoid</span>
00033 <span class="comment">// clashing with the very same functions in malloc.c, it will disappear</span>
00034 <span class="comment">// when shm.c will become the only real time memory management support</span>
00035 <span class="comment">// (using xnheap_alloc/free, in xenomai/heap.c).</span>
00036 
00037 <span class="preprocessor">#ifndef _RTAI_SHM_H</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#define _RTAI_SHM_H</span>
00039 <span class="preprocessor"></span>
00043 <span class="preprocessor">#ifdef CONFIG_RTAI_SHM_BUILTIN</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#define SHM_INIT_MODULE     shm_init_module</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#define SHM_CLEANUP_MODULE  shm_cleanup_module</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* !CONFIG_RTAI_SHM_BUILTIN */</span>
00047 <span class="preprocessor">#define SHM_INIT_MODULE     init_module</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#define SHM_CLEANUP_MODULE  cleanup_module</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_SHM_BUILTIN */</span>
00050 
00051 <span class="preprocessor">#define GLOBAL_HEAP_ID  0x9ac6d9e5  // nam2num("RTGLBH");</span>
00052 <span class="preprocessor"></span>
00053 <span class="preprocessor">#define USE_VMALLOC     0</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#define USE_GFP_KERNEL  1</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#define USE_GFP_ATOMIC  2</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#define USE_GFP_DMA     3</span>
00057 <span class="preprocessor"></span>
<a name="l00079"></a><a class="code" href="group__shm.html#a52">00079</a> <span class="preprocessor">#define rtai_kmalloc(name, size) \</span>
00080 <span class="preprocessor">        rt_shm_alloc(name, size, USE_VMALLOC)  // legacy</span>
00081 <span class="preprocessor"></span>
<a name="l00099"></a><a class="code" href="group__shm.html#a53">00099</a> <span class="preprocessor">#define rtai_kfree(name) \</span>
00100 <span class="preprocessor">        rt_shm_free(name)  // legacy</span>
00101 <span class="preprocessor"></span>
00102 <span class="preprocessor">#if defined(__KERNEL__)</span>
00103 <span class="preprocessor"></span>
00104 <span class="preprocessor">#include &lt;linux/module.h&gt;</span>
00105 <span class="preprocessor">#include &lt;linux/version.h&gt;</span>
00106 <span class="preprocessor">#include &lt;linux/wrapper.h&gt;</span>
00107 <span class="preprocessor">#include &lt;linux/vmalloc.h&gt;</span>
00108 
00109 <span class="preprocessor">#include &lt;asm/rtai_shm.h&gt;</span>
00110 
00111 <span class="preprocessor">#ifdef __cplusplus</span>
00112 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00113 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00114 
00115 <span class="keywordtype">int</span> SHM_INIT_MODULE(<span class="keywordtype">void</span>);
00116 
00117 <span class="keywordtype">void</span> SHM_CLEANUP_MODULE(<span class="keywordtype">void</span>);
00118 
00119 <span class="keywordtype">void</span> *<a class="code" href="group__shm.html#a20">rt_shm_alloc</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name,
00120                       <span class="keywordtype">int</span> size,
00121                       <span class="keywordtype">int</span> suprt);
00122 
00123 <span class="preprocessor">#define rt_shm_alloc_adr(adr, name, size) \</span>
00124 <span class="preprocessor">        rt_shm_alloc(name, size, suprt)</span>
00125 <span class="preprocessor"></span>
00126 <span class="keywordtype">int</span> <a class="code" href="group__shm.html#a8">rt_shm_free</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name);
00127 
00128 <span class="keywordtype">void</span> *<a class="code" href="group__shm.html#a39">rt_heap_open</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name,
00129                    <span class="keywordtype">int</span> size,
00130                    <span class="keywordtype">int</span> suprt);
00131 
00132 <span class="preprocessor">#define rt_heap_open_adr(adr, name, size, suprt) \</span>
00133 <span class="preprocessor">        rt_heap_open(name, size, suprt)</span>
00134 <span class="preprocessor"></span>
00135 <span class="keywordtype">void</span> *<a class="code" href="group__shm.html#a9">rt_halloc</a>(<span class="keywordtype">int</span> size);
00136 
00137 <span class="keywordtype">void</span> <a class="code" href="group__shm.html#a10">rt_hfree</a>(<span class="keywordtype">void</span> *addr);
00138 
00139 <span class="keywordtype">void</span> *<a class="code" href="group__shm.html#a11">rt_named_halloc</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name,
00140                       <span class="keywordtype">int</span> size);
00141 
00142 <span class="keywordtype">void</span> <a class="code" href="group__shm.html#a12">rt_named_hfree</a>(<span class="keywordtype">void</span> *addr);
00143 
00144 <span class="keywordtype">void</span> *<a class="code" href="group__shm.html#a13">rt_malloc_new</a>(<span class="keywordtype">int</span> size);
00145 
00146 <span class="keywordtype">void</span> <a class="code" href="group__shm.html#a14">rt_free_new</a>(<span class="keywordtype">void</span> *addr);
00147 
00148 <span class="keywordtype">void</span> *<a class="code" href="group__shm.html#a15">rt_named_malloc</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name,
00149                       <span class="keywordtype">int</span> size);
00150 
00151 <span class="keywordtype">void</span> <a class="code" href="group__shm.html#a16">rt_named_free</a>(<span class="keywordtype">void</span> *addr);
00152 
00153 <span class="keywordtype">void</span> *rvmalloc(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);
00154 
00155 <span class="keywordtype">void</span> rvfree(<span class="keywordtype">void</span> *mem,
00156             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);
00157 
00158 <span class="keywordtype">int</span> rvmmap(<span class="keywordtype">void</span> *mem,
00159            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> memsize,
00160            <span class="keyword">struct</span> vm_area_struct *vma);
00161 
00162 <span class="keywordtype">void</span> *rkmalloc(<span class="keywordtype">int</span> *size,
00163                <span class="keywordtype">int</span> suprt);
00164 
00165 <span class="keywordtype">void</span> rkfree(<span class="keywordtype">void</span> *mem,
00166             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);
00167 
00168 <span class="keywordtype">int</span> rkmmap(<span class="keywordtype">void</span> *mem,
00169            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> memsize,
00170            <span class="keyword">struct</span> vm_area_struct *vma);
00171 
00172 <span class="preprocessor">#ifdef __cplusplus</span>
00173 <span class="preprocessor"></span>}
00174 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00175 
00176 <span class="preprocessor">#else </span><span class="comment">/* !__KERNEL__ */</span>
00177 
00178 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00179 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00180 <span class="preprocessor">#include &lt;sys/mman.h&gt;</span>
00181 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
00182 <span class="preprocessor">#include &lt;<a class="code" href="rtai__lxrt_8h.html">rtai_lxrt.h</a>&gt;</span>
00183 
00184 <span class="comment">//#define SHM_USE_LXRT</span>
00185 
00186 <span class="keyword">struct </span>spinlock;
00187 
00188 <span class="preprocessor">#define RTAI_SHM_DEV  "/dev/rtai_shm"</span>
00189 <span class="preprocessor"></span>
00190 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> *_rt_shm_alloc(<span class="keywordtype">void</span> *start, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> suprt, <span class="keywordtype">int</span> isheap)
00191 {
00192         <span class="keywordtype">int</span> hook;
00193         <span class="keywordtype">void</span> *adr;
00194         <span class="keywordflow">if</span> ((hook = open(RTAI_SHM_DEV, O_RDWR)) &lt;= 0) {
00195                 <span class="keywordflow">return</span> 0;
00196         } <span class="keywordflow">else</span> {
00197                 <span class="keyword">struct </span>{ <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name, arg, suprt; } arg = { name, size, suprt };
00198 <span class="preprocessor">#ifdef SHM_USE_LXRT</span>
00199 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((size = rtai_lxrt(BIDX, SIZARG, SHM_ALLOC, &amp;arg).i[LOW])) {
00200 <span class="preprocessor">#else</span>
00201 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((size = ioctl(hook, SHM_ALLOC, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(&amp;arg)))) {
00202 <span class="preprocessor">#endif</span>
00203 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ((adr = mmap(start, size, PROT_WRITE | PROT_READ, MAP_SHARED | MAP_LOCKED | MAP_FILE, hook, 0)) == (<span class="keywordtype">void</span> *)-1) {;
00204 <span class="preprocessor">#ifdef SHM_USE_LXRT</span>
00205 <span class="preprocessor"></span>                                rtai_lxrt(BIDX, <span class="keyword">sizeof</span>(name), SHM_FREE, &amp;name);
00206 <span class="preprocessor">#else</span>
00207 <span class="preprocessor"></span>                                ioctl(hook, SHM_FREE, &amp;name);
00208 <span class="preprocessor">#endif</span>
00209 <span class="preprocessor"></span>                                adr = 0;
00210                         } 
00211 <span class="preprocessor">#if 0</span>
00212 <span class="preprocessor"></span>                          <span class="keywordflow">else</span> {
00213                                 <span class="keywordtype">int</span> i;
00214                                 <span class="keyword">volatile</span> <span class="keywordtype">int</span> k;
00215                                 <span class="keywordflow">for</span> (i = 0; i &lt; size/<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>); i++) {
00216                                         k = ((<span class="keywordtype">int</span> *)adr)[i];
00217                                 }
00218                                 mlockall(MCL_CURRENT | MCL_FUTURE);
00219                         }
00220 <span class="preprocessor">#endif</span>
00221 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (isheap) {
00222                                 arg.arg = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)adr;
00223 <span class="preprocessor">#ifdef SHM_USE_LXRT</span>
00224 <span class="preprocessor"></span>                                rtai_lxrt(BIDX, SIZARG, HEAP_SET, &amp;arg);
00225 <span class="preprocessor">#else</span>
00226 <span class="preprocessor"></span>                                ioctl(hook, HEAP_SET, &amp;arg);
00227 <span class="preprocessor">#endif</span>
00228 <span class="preprocessor"></span>                        }
00229                 } <span class="keywordflow">else</span> {
00230                         adr = 0;
00231                 }
00232         }
00233         close(hook);
00234         <span class="keywordflow">return</span> adr;
00235 }
00236 
00237 <span class="preprocessor">#define rt_shm_alloc(name, size, suprt)  \</span>
00238 <span class="preprocessor">        _rt_shm_alloc(0, name, size, suprt, 0)</span>
00239 <span class="preprocessor"></span>
00240 <span class="preprocessor">#define rt_heap_open(name, size, suprt)  \</span>
00241 <span class="preprocessor">        _rt_shm_alloc(0, name, size + sizeof(struct spinlock *) + 1, suprt, 1)</span>
00242 <span class="preprocessor"></span>
<a name="l00264"></a><a class="code" href="group__shm.html#a57">00264</a> <span class="preprocessor">#define rtai_malloc(name, size)  \</span>
00265 <span class="preprocessor">        _rt_shm_alloc(0, name, size, USE_VMALLOC, 0)  // legacy</span>
00266 <span class="preprocessor"></span>
<a name="l00307"></a><a class="code" href="group__shm.html#a58">00307</a> <span class="preprocessor">#define rt_shm_alloc_adr(start_address, name, size, suprt)  \</span>
00308 <span class="preprocessor">        _rt_shm_alloc(start_address, name, size, suprt, 0)</span>
00309 <span class="preprocessor"></span>
00310 <span class="preprocessor">#define rt_heap_open_adr(start, name, size, suprt)  \</span>
00311 <span class="preprocessor">        _rt_shm_alloc(start, name, size + sizeof(struct spinlock *) + 1, suprt, 1)</span>
00312 <span class="preprocessor"></span>
<a name="l00336"></a><a class="code" href="group__shm.html#a60">00336</a> <span class="preprocessor">#define rtai_malloc_adr(start_address, name, size)  \</span>
00337 <span class="preprocessor">        _rt_shm_alloc(start_address, name, size, USE_VMALLOC, 0)  // legacy</span>
00338 <span class="preprocessor"></span>
<a name="l00339"></a><a class="code" href="group__shm.html#a8">00339</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__shm.html#a8">rt_shm_free</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name) 
00340 {
00341         <span class="keywordtype">int</span> hook, size;
00342         <span class="keyword">struct </span>{ <span class="keywordtype">void</span> *nameadr; } arg = { &amp;name };
00343         <span class="keywordflow">if</span> ((hook = open(RTAI_SHM_DEV, O_RDWR)) &lt;= 0) {
00344                 <span class="keywordflow">return</span> 0;
00345         }
00346 <span class="comment">// no SHM_FREE needed, we release it all and munmap will do it through </span>
00347 <span class="comment">// the vma close operation provided by shm.c</span>
00348 <span class="preprocessor">#ifdef SHM_USE_LXRT</span>
00349 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((size = rtai_lxrt(BIDX, SIZARG, SHM_SIZE, &amp;arg).i[LOW])) {
00350 <span class="preprocessor">#else</span>
00351 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((size = ioctl(hook, SHM_SIZE, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)&amp;arg))) {
00352 <span class="preprocessor">#endif</span>
00353 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (munmap((<span class="keywordtype">void</span> *)name, size)) {
00354                         size = 0;
00355                 }
00356         }
00357         close(hook);
00358         <span class="keywordflow">return</span> size;
00359 }
00360 
<a name="l00378"></a><a class="code" href="group__shm.html#a61">00378</a> <span class="preprocessor">#define rtai_free(name, adr)  \</span>
00379 <span class="preprocessor">        rt_shm_free(name)  // legacy</span>
00380 <span class="preprocessor"></span>
<a name="l00381"></a><a class="code" href="group__shm.html#a9">00381</a> RTAI_PROTO(<span class="keywordtype">void</span> *, rt_halloc, (<span class="keywordtype">int</span> size))
00382 {
00383         <span class="keyword">struct </span>{ <span class="keywordtype">int</span> size; } arg = { size };
00384         <span class="keywordflow">return</span> rtai_lxrt(BIDX, SIZARG, HEAP_ALLOC, &amp;arg).v[LOW];
00385 }
00386 
<a name="l00387"></a><a class="code" href="group__shm.html#a10">00387</a> RTAI_PROTO(<span class="keywordtype">void</span>, rt_hfree, (<span class="keywordtype">void</span> *addr))
00388 {
00389         <span class="keyword">struct </span>{ <span class="keywordtype">void</span> *addr; } arg = { addr };
00390         rtai_lxrt(BIDX, SIZARG, HEAP_FREE, &amp;arg);
00391 }
00392 
<a name="l00393"></a><a class="code" href="group__shm.html#a11">00393</a> RTAI_PROTO(<span class="keywordtype">void</span> *, rt_named_halloc, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name, <span class="keywordtype">int</span> size))
00394 {
00395         <span class="keyword">struct </span>{ <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name; <span class="keywordtype">int</span> size; } arg = { name, size };
00396         <span class="keywordflow">return</span> rtai_lxrt(BIDX, SIZARG, HEAP_NAMED_ALLOC, &amp;arg).v[LOW];
00397 }
00398 
<a name="l00399"></a><a class="code" href="group__shm.html#a12">00399</a> RTAI_PROTO(<span class="keywordtype">void</span>, rt_named_hfree, (<span class="keywordtype">void</span> *addr))
00400 {
00401         <span class="keyword">struct </span>{ <span class="keywordtype">void</span> *addr; } arg = { addr };
00402         rtai_lxrt(BIDX, SIZARG, HEAP_NAMED_FREE, &amp;arg);
00403 }
00404 
<a name="l00405"></a><a class="code" href="group__shm.html#a13">00405</a> RTAI_PROTO(<span class="keywordtype">void</span> *, rt_malloc_new, (<span class="keywordtype">int</span> size))
00406 {
00407         <span class="keyword">struct </span>{ <span class="keywordtype">int</span> size; } arg = { size };
00408         <span class="keywordflow">return</span> rtai_lxrt(BIDX, SIZARG, MALLOC, &amp;arg).v[LOW];
00409 }
00410 
<a name="l00411"></a><a class="code" href="group__shm.html#a14">00411</a> RTAI_PROTO(<span class="keywordtype">void</span>, rt_free_new, (<span class="keywordtype">void</span> *addr))
00412 {
00413         <span class="keyword">struct </span>{ <span class="keywordtype">void</span> *addr; } arg = { addr };
00414         rtai_lxrt(BIDX, SIZARG, FREE, &amp;arg);
00415 }
00416 
<a name="l00417"></a><a class="code" href="group__shm.html#a15">00417</a> RTAI_PROTO(<span class="keywordtype">void</span> *, rt_named_malloc, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name, <span class="keywordtype">int</span> size))
00418 {
00419         <span class="keyword">struct </span>{ <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> name; <span class="keywordtype">int</span> size; } arg = { name, size };
00420         <span class="keywordflow">return</span> rtai_lxrt(BIDX, SIZARG, NAMED_MALLOC, &amp;arg).v[LOW];
00421 }
00422 
<a name="l00423"></a><a class="code" href="group__shm.html#a16">00423</a> RTAI_PROTO(<span class="keywordtype">void</span>, rt_named_free, (<span class="keywordtype">void</span> *addr))
00424 {
00425         <span class="keyword">struct </span>{ <span class="keywordtype">void</span> *addr; } arg = { addr };
00426         rtai_lxrt(BIDX, SIZARG, NAMED_FREE, &amp;arg);
00427 }
00428 
00429 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL__ */</span>
00430 
<a name="l00450"></a><a class="code" href="group__shm.html#a62">00450</a> <span class="preprocessor">#define rt_heap_close(name, adr)  rt_shm_free(name)</span>
00451 <span class="preprocessor"></span>
00452 <span class="comment">// aliases in use already, different heads different choices</span>
00453 <span class="preprocessor">#define rt_heap_init         rt_heap_open</span>
00454 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_create       rt_heap_open</span>
00455 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_acquire      rt_heap_open</span>
00456 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_init_adr     rt_heap_open_adr</span>
00457 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_create_adr   rt_heap_open_adr</span>
00458 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_acquire_adr  rt_heap_open_adr</span>
00459 <span class="preprocessor"></span>
00460 <span class="preprocessor">#define rt_heap_delete       rt_heap_close</span>
00461 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_destroy      rt_heap_close</span>
00462 <span class="preprocessor"></span><span class="preprocessor">#define rt_heap_release      rt_heap_close</span>
00463 <span class="preprocessor"></span>
00464 <span class="comment">// these have no aliases, and never will</span>
00465 
<a name="l00481"></a><a class="code" href="group__shm.html#a72">00481</a> <span class="preprocessor">#define rt_global_heap_open()  rt_heap_open(GLOBAL_HEAP_ID, 0, 0)</span>
00482 <span class="preprocessor"></span>
<a name="l00499"></a><a class="code" href="group__shm.html#a73">00499</a> <span class="preprocessor">#define rt_global_heap_close()  rt_heap_close(GLOBAL_HEAP_ID, 0)</span>
00500 <span class="preprocessor"></span>
00503 <span class="preprocessor">#endif </span><span class="comment">/* !_RTAI_SHM_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun Jun 20 16:23:36 2004 for RTAI API by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
